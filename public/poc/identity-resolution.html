<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Identity Resolution POC</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #000;
      color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.4;
      padding: 20px;
      min-height: 100vh;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    header {
      border: 1px solid #fff;
      padding: 15px 20px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { font-size: 18px; font-weight: normal; }
    .brand-select {
      background: #000;
      color: #fff;
      border: 1px solid #fff;
      padding: 5px 10px;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
    }
    .grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
    }
    .panel {
      border: 1px solid #fff;
      padding: 15px;
    }
    .panel-title {
      font-size: 12px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #333;
    }
    .signal-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 12px;
    }
    .signal-label { color: #888; }
    .signal-value {
      color: #fff;
      text-align: right;
      max-width: 160px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-indicator.active {
      background: #fff;
      animation: pulse 1s infinite;
    }
    .status-indicator.success { background: #fff; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    .right-column {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .flow-diagram {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 20px;
      flex-wrap: wrap;
    }
    .flow-step {
      border: 1px solid #333;
      padding: 10px 15px;
      text-align: center;
      min-width: 100px;
      font-size: 11px;
      transition: all 0.3s;
    }
    .flow-step.active {
      border-color: #fff;
      background: #fff;
      color: #000;
    }
    .flow-step.complete { border-color: #fff; }
    .flow-arrow { color: #333; font-size: 18px; }
    .flow-arrow.active { color: #fff; }
    .flow-branch {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 12px;
      color: #888;
    }
    .form-group input, .form-group select {
      width: 100%;
      background: #000;
      border: 1px solid #fff;
      color: #fff;
      padding: 8px 10px;
      font-family: inherit;
      font-size: 13px;
    }
    .form-group input:focus, .form-group select:focus {
      outline: none;
      background: #111;
    }
    .btn {
      background: #fff;
      color: #000;
      border: none;
      padding: 10px 20px;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s;
    }
    .btn:hover { background: #ccc; }
    .btn:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }
    .btn-outline {
      background: transparent;
      color: #fff;
      border: 1px solid #fff;
      margin-top: 10px;
    }
    .btn-outline:hover {
      background: #fff;
      color: #000;
    }
    .scenario-box {
      background: #111;
      border: 1px solid #333;
      padding: 12px;
      margin-bottom: 15px;
      font-size: 11px;
    }
    .scenario-box.highlight { border-color: #fff; }
    .scenario-label {
      color: #888;
      margin-bottom: 8px;
      font-size: 10px;
      text-transform: uppercase;
    }
    .scenario-desc {
      color: #fff;
      line-height: 1.5;
    }
    .lookup-result {
      font-size: 12px;
      padding: 15px;
      background: #111;
      margin-top: 10px;
    }
    .lookup-result.match { border-left: 3px solid #fff; }
    .lookup-result.no-match { border-left: 3px solid #333; }
    .payload-box {
      background: #111;
      padding: 15px;
      font-size: 11px;
      overflow-x: auto;
      white-space: pre;
      max-height: 180px;
      overflow-y: auto;
    }
    .payload-label {
      font-size: 11px;
      color: #888;
      margin-bottom: 5px;
      margin-top: 15px;
    }
    .payload-label:first-child { margin-top: 0; }
    .event-log {
      height: 180px;
      overflow-y: auto;
      background: #111;
      padding: 10px;
      font-size: 11px;
    }
    .log-entry {
      margin-bottom: 5px;
      display: flex;
      gap: 10px;
    }
    .log-time { color: #666; flex-shrink: 0; }
    .log-indicator { flex-shrink: 0; }
    .log-message { color: #fff; }
    .clear-btn {
      background: transparent;
      color: #666;
      border: 1px solid #333;
      padding: 5px 10px;
      font-size: 11px;
      cursor: pointer;
      float: right;
    }
    .clear-btn:hover {
      border-color: #fff;
      color: #fff;
    }
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .master-record {
      margin-top: 15px;
      padding: 15px;
      background: #111;
      font-size: 11px;
    }
    .master-record h4 {
      margin-bottom: 10px;
      font-weight: normal;
      color: #888;
    }
    .device-list { margin-top: 10px; }
    .device-item {
      padding: 8px;
      border: 1px solid #333;
      margin-bottom: 5px;
      font-size: 10px;
    }
    .device-item.current { border-color: #fff; }
    .tag {
      display: inline-block;
      border: 1px solid #fff;
      padding: 2px 6px;
      font-size: 10px;
      margin-right: 5px;
      margin-top: 5px;
    }
    .tag.warning { border-color: #888; color: #888; }
    .tag.new { background: #fff; color: #000; }
    .hidden { display: none; }
    .processing { animation: blink 0.5s infinite; }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .submission-counter {
      background: #111;
      padding: 10px;
      margin-top: 15px;
      font-size: 11px;
      text-align: center;
    }
    .counter-value {
      font-size: 24px;
      margin: 5px 0;
    }
    .dup-warning {
      background: #fff;
      color: #000;
      padding: 15px;
      margin-top: 15px;
      text-align: center;
    }
    .dup-warning strong {
      display: block;
      font-size: 14px;
      margin-bottom: 5px;
    }
    .history-table {
      width: 100%;
      margin-top: 15px;
      border-collapse: collapse;
      font-size: 10px;
    }
    .history-table th, .history-table td {
      border: 1px solid #333;
      padding: 6px;
      text-align: left;
    }
    .history-table th {
      background: #111;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>■ IDENTITY RESOLUTION POC</h1>
      <div style="display: flex; gap: 10px; align-items: center;">
        <span style="color: #888; font-size: 12px;">Current Brand:</span>
        <select class="brand-select" id="brandSelect">
          <option value="clg">CLG</option>
          <option value="access-hire">Access Hire</option>
          <option value="access-express">Access Express</option>
        </select>
      </div>
    </header>
    
    <div class="grid">
      <div class="left-column">
        <div class="panel">
          <div class="panel-title">■ TEST SCENARIO</div>
          
          <div class="form-group">
            <label>Quick Select</label>
            <select id="scenarioSelect" onchange="loadScenario()">
              <option value="returning-user">↻ Returning User (John)</option>
              <option value="returning-user-jane">↻ Returning User (Jane)</option>
              <option value="new-user">+ New User</option>
              <option value="same-email-diff-phone">↻ Same Email, Diff Phone</option>
              <option value="same-phone-diff-email">↻ Same Phone, Diff Email</option>
              <option value="custom">✎ Custom Entry</option>
            </select>
          </div>
          
          <div class="scenario-box highlight" id="scenarioDesc">
            <div class="scenario-label">What Will Happen</div>
            <div class="scenario-desc" id="scenarioText">
              Known user - will match and link to existing record.
            </div>
          </div>
          
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="testEmail" placeholder="user@example.com">
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="testPhone" placeholder="0400000000">
          </div>
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="testName" placeholder="Full Name">
          </div>
          
          <button class="btn" id="submitBtn" onclick="submitTestLead()">
            SUBMIT LEAD
          </button>
          
          <button class="btn btn-outline" onclick="resetDemo()">
            RESET SESSION
          </button>
          
          <div class="submission-counter">
            <div style="color: #888;">SESSION SUBMISSIONS</div>
            <div class="counter-value" id="sessionCounter">0</div>
            <div style="color: #666; font-size: 10px;">Each gets unique UID for NetSuite</div>
          </div>
        </div>
        
        <div class="panel" style="margin-top: 20px;">
          <div class="panel-title">■ CURRENT DEVICE</div>
          <div class="signal-row">
            <span class="signal-label">Device ID</span>
            <span class="signal-value" id="deviceId">-</span>
          </div>
          <div class="signal-row">
            <span class="signal-label">Platform</span>
            <span class="signal-value" id="platform">-</span>
          </div>
          <div class="signal-row">
            <span class="signal-label">Browser</span>
            <span class="signal-value" id="browser">-</span>
          </div>
          <div class="signal-row">
            <span class="signal-label">Visitor ID</span>
            <span class="signal-value" id="visitorId">-</span>
          </div>
          <div class="signal-row">
            <span class="signal-label">Session ID</span>
            <span class="signal-value" id="sessionId">-</span>
          </div>
        </div>
      </div>
      
      <div class="right-column">
        <div class="panel">
          <div class="panel-title">■ DEDUPLICATION FLOW</div>
          <div class="flow-diagram">
            <div class="flow-step" id="step-capture">CAPTURE<br>SIGNALS</div>
            <span class="flow-arrow" id="arrow-1">→</span>
            <div class="flow-step" id="step-check">QUERY<br>FIREBASE</div>
            <span class="flow-arrow" id="arrow-2">→</span>
            <div class="flow-step" id="step-match">MATCH<br>EMAIL/PHONE</div>
            <span class="flow-arrow" id="arrow-3">→</span>
            <div class="flow-branch">
              <div class="flow-step" id="step-new">CREATE<br>NEW</div>
              <span style="color: #333;">─ OR ─</span>
              <div class="flow-step" id="step-link">LINK TO<br>EXISTING</div>
            </div>
            <span class="flow-arrow" id="arrow-4">→</span>
            <div class="flow-step" id="step-push">SEND<br>UNIQUE UID</div>
          </div>
        </div>
        
        <div class="two-col">
          <div class="panel">
            <div class="panel-title">■ FIREBASE DEDUPLICATION</div>
            <div id="lookupStatus">
              <span style="color: #666;">Submit a lead to see deduplication...</span>
            </div>
            <div id="lookupResult" class="hidden"></div>
            <div id="masterRecord" class="hidden"></div>
            <div id="dupWarning" class="hidden"></div>
          </div>
          
          <div class="panel">
            <div class="panel-title">■ OUTBOUND PAYLOADS</div>
            <div class="payload-label">▼ DataLayer Push</div>
            <div class="payload-box" id="dataLayerPayload">// Submit a lead...</div>
            <div class="payload-label">▼ NetSuite Payload (unique UID)</div>
            <div class="payload-box" id="netsuitePayload">// Submit a lead...</div>
          </div>
        </div>
        
        <div class="panel">
          <div class="panel-title">
            ■ SESSION HISTORY
            <button class="clear-btn" onclick="clearLog()">CLEAR LOG</button>
          </div>
          <div id="sessionHistory"></div>
          <div class="event-log" id="eventLog"></div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Simulated Firebase database
    const database = {
      leads: {
        'LEAD-ABC123': {
          masterLeadId: 'LEAD-ABC123',
          email: 'john@example.com',
          phone: '0412345678',
          firstName: 'John',
          lastName: 'Smith',
          firstSeen: '2026-01-15T10:30:00Z',
          devices: {
            'DEV-PREV01': { deviceType: 'desktop', platform: 'Win32', browser: 'Chrome', brands: ['access-hire'] },
            'DEV-PREV02': { deviceType: 'mobile', platform: 'iPhone', browser: 'Safari', brands: ['access-hire', 'access-express'] }
          },
          siteIds: {
            'access-hire': ['UID-001', 'UID-003'],
            'access-express': ['UID-002']
          },
          totalSubmissions: 3
        },
        'LEAD-DEF456': {
          masterLeadId: 'LEAD-DEF456',
          email: 'jane@company.com',
          phone: '0498765432',
          firstName: 'Jane',
          lastName: 'Doe',
          firstSeen: '2026-01-20T14:00:00Z',
          devices: {
            'DEV-PREV03': { deviceType: 'desktop', platform: 'MacIntel', browser: 'Safari', brands: ['clg'] }
          },
          siteIds: { 'clg': ['UID-004'] },
          totalSubmissions: 1
        }
      }
    };
    
    // Scenarios
    const scenarios = {
      'returning-user': {
        email: 'john@example.com',
        phone: '0412345678',
        name: 'John Smith',
        desc: '↻ MATCH: Email + Phone match existing lead LEAD-ABC123. Will link this submission to master record.'
      },
      'returning-user-jane': {
        email: 'jane@company.com',
        phone: '0498765432',
        name: 'Jane Doe',
        desc: '↻ MATCH: Will match existing lead LEAD-DEF456 from CLG site.'
      },
      'new-user': {
        email: 'brand.new@user.com',
        phone: '0400111222',
        name: 'Brand New User',
        desc: '+ NEW: No email or phone match. Will create NEW master lead record.'
      },
      'same-email-diff-phone': {
        email: 'john@example.com',
        phone: '0499999999',
        name: 'John Smith',
        desc: '↻ MATCH: Same email as John (different phone). EMAIL MATCH links to LEAD-ABC123.'
      },
      'same-phone-diff-email': {
        email: 'different@email.com',
        phone: '0412345678',
        name: 'J Smith',
        desc: '↻ MATCH: Different email but same phone. PHONE MATCH links to LEAD-ABC123.'
      },
      'custom': {
        email: '',
        phone: '',
        name: '',
        desc: '✎ Enter any values to test. Try submitting same data twice to see duplicate handling.'
      }
    };
    
    // Session state
    let deviceId, visitorId, sessionId;
    let sessionSubmissions = 0;
    let sessionLeads = []; // Track submissions this session
    
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16).toUpperCase();
      });
    }
    
    function generateId(prefix) {
      return prefix + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();
    }
    
    function log(msg, type = 'info') {
      const el = document.getElementById('eventLog');
      const time = new Date().toLocaleTimeString('en-AU', { hour12: false });
      const icon = type === 'success' ? '●' : type === 'warning' ? '▲' : type === 'processing' ? '◐' : '○';
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="log-time">${time}</span><span class="log-indicator">${icon}</span><span class="log-message">${msg}</span>`;
      el.insertBefore(entry, el.firstChild);
    }
    
    function clearLog() {
      document.getElementById('eventLog').innerHTML = '';
    }
    
    function loadScenario() {
      const id = document.getElementById('scenarioSelect').value;
      const s = scenarios[id];
      document.getElementById('testEmail').value = s.email;
      document.getElementById('testPhone').value = s.phone;
      document.getElementById('testName').value = s.name;
      document.getElementById('scenarioText').textContent = s.desc;
    }
    
    function init() {
      deviceId = generateId('DEV');
      visitorId = generateId('VIS');
      sessionId = generateId('SES');
      
      document.getElementById('deviceId').textContent = deviceId;
      document.getElementById('platform').textContent = navigator.platform;
      document.getElementById('browser').textContent = navigator.userAgent.includes('Chrome') ? 'Chrome' : 'Safari';
      document.getElementById('visitorId').textContent = visitorId;
      document.getElementById('sessionId').textContent = sessionId;
      
      document.getElementById('step-capture').classList.add('complete');
      loadScenario();
      log('Session started: ' + sessionId);
    }
    
    async function activateStep(stepId, arrowId) {
      if (arrowId) document.getElementById(arrowId).classList.add('active');
      const step = document.getElementById(stepId);
      step.classList.add('active');
      await new Promise(r => setTimeout(r, 500));
      step.classList.remove('active');
      step.classList.add('complete');
    }
    
    function findMatch(email, phone) {
      for (const id in database.leads) {
        const lead = database.leads[id];
        if (email && lead.email.toLowerCase() === email.toLowerCase()) {
          return { lead, matchType: 'EMAIL' };
        }
        if (phone && lead.phone === phone) {
          return { lead, matchType: 'PHONE' };
        }
      }
      return null;
    }
    
    function checkDuplicate(email, phone) {
      // Check if we've already submitted this email/phone in this session
      return sessionLeads.find(l => 
        (email && l.email.toLowerCase() === email.toLowerCase()) || 
        (phone && l.phone === phone)
      );
    }
    
    function updateSessionHistory() {
      if (sessionLeads.length === 0) {
        document.getElementById('sessionHistory').innerHTML = '';
        return;
      }
      
      let html = `<table class="history-table">
        <tr><th>#</th><th>UID (NetSuite)</th><th>Master ID</th><th>Email</th><th>Brand</th><th>Type</th></tr>`;
      
      sessionLeads.forEach((l, i) => {
        html += `<tr>
          <td>${i + 1}</td>
          <td>${l.uid.substring(0, 8)}...</td>
          <td>${l.masterId}</td>
          <td>${l.email || '-'}</td>
          <td>${l.brand}</td>
          <td>${l.type}</td>
        </tr>`;
      });
      
      html += '</table>';
      document.getElementById('sessionHistory').innerHTML = html;
    }
    
    async function submitTestLead() {
      const email = document.getElementById('testEmail').value.trim();
      const phone = document.getElementById('testPhone').value.trim();
      const name = document.getElementById('testName').value.trim();
      const brand = document.getElementById('brandSelect').value;
      
      if (!email && !phone) {
        alert('Enter at least email or phone');
        return;
      }
      
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = 'PROCESSING...';
      
      // Reset flow
      document.querySelectorAll('.flow-step').forEach(el => el.classList.remove('active', 'complete'));
      document.querySelectorAll('.flow-arrow').forEach(el => el.classList.remove('active'));
      document.getElementById('step-capture').classList.add('complete');
      document.getElementById('dupWarning').classList.add('hidden');
      
      log('━━━━━━━━━━━━━━━━━━━━━━━━');
      log(`SUBMISSION #${sessionSubmissions + 1} on ${brand.toUpperCase()}`);
      
      // Check for session duplicate FIRST
      const prevSubmission = checkDuplicate(email, phone);
      const isDuplicate = !!prevSubmission;
      
      if (isDuplicate) {
        log('⚠ DUPLICATE in this session!', 'warning');
      }
      
      await activateStep('step-check', 'arrow-1');
      log('Querying Firebase...', 'processing');
      
      document.getElementById('lookupStatus').innerHTML = `
        <div class="processing">
          Checking: ${email || '(no email)'}<br>
          Checking: ${phone || '(no phone)'}
        </div>
      `;
      
      await new Promise(r => setTimeout(r, 300));
      await activateStep('step-match', 'arrow-2');
      
      const result = findMatch(email, phone);
      let masterId, isReturning = false, matchedLead = null, matchType = null;
      
      if (result) {
        isReturning = true;
        masterId = result.lead.masterLeadId;
        matchedLead = result.lead;
        matchType = result.matchType;
        
        log(`✓ MATCH via ${matchType}: ${masterId}`, 'success');
        
        const isNewBrand = !matchedLead.siteIds[brand];
        const isNewDevice = !matchedLead.devices[deviceId];
        
        document.getElementById('lookupStatus').innerHTML = '';
        document.getElementById('lookupResult').classList.remove('hidden');
        document.getElementById('lookupResult').className = 'lookup-result match';
        document.getElementById('lookupResult').innerHTML = `
          <strong>✓ MATCH FOUND (${matchType})</strong><br><br>
          Master ID: <strong>${masterId}</strong><br>
          Stored Email: ${matchedLead.email}<br>
          Stored Phone: ${matchedLead.phone}<br>
          Previous submissions: ${matchedLead.totalSubmissions}<br>
          Known brands: ${Object.keys(matchedLead.siteIds).join(', ')}<br>
          Known devices: ${Object.keys(matchedLead.devices).length}
        `;
        
        document.getElementById('masterRecord').classList.remove('hidden');
        document.getElementById('masterRecord').innerHTML = `
          <div class="master-record">
            <h4>UPDATING MASTER RECORD</h4>
            ${isNewBrand ? `<span class="tag new">+ NEW BRAND: ${brand}</span>` : `<span class="tag">EXISTING BRAND: ${brand}</span>`}
            ${isNewDevice ? `<span class="tag new">+ NEW DEVICE</span>` : ''}
            ${isDuplicate ? `<span class="tag warning">DUPLICATE SESSION</span>` : ''}
            <div style="margin-top: 10px;">
              Submissions: ${matchedLead.totalSubmissions} → <strong>${matchedLead.totalSubmissions + 1}</strong>
            </div>
            <div>
              UIDs for ${brand}: [${(matchedLead.siteIds[brand] || []).join(', ')}${matchedLead.siteIds[brand] ? ', ' : ''}<strong>+NEW</strong>]
            </div>
          </div>
        `;
        
        await activateStep('step-link', 'arrow-3');
        
      } else {
        masterId = generateId('LEAD');
        log(`+ NEW LEAD: ${masterId}`);
        
        document.getElementById('lookupStatus').innerHTML = '';
        document.getElementById('lookupResult').classList.remove('hidden');
        document.getElementById('lookupResult').className = 'lookup-result no-match';
        document.getElementById('lookupResult').innerHTML = `
          <strong>○ NO MATCH</strong><br><br>
          No existing lead found.<br>
          Creating new master record...
        `;
        
        document.getElementById('masterRecord').classList.remove('hidden');
        document.getElementById('masterRecord').innerHTML = `
          <div class="master-record">
            <h4>NEW MASTER RECORD</h4>
            <div>ID: <strong>${masterId}</strong></div>
            <div>Email: ${email || '(none)'}</div>
            <div>Phone: ${phone || '(none)'}</div>
            <div>Brand: ${brand}</div>
            <span class="tag new">NEW LEAD</span>
          </div>
        `;
        
        // Add to database for future lookups
        database.leads[masterId] = {
          masterLeadId: masterId,
          email: email,
          phone: phone,
          firstName: name,
          firstSeen: new Date().toISOString(),
          devices: { [deviceId]: { deviceType: 'desktop', platform: navigator.platform, browser: 'Chrome', brands: [brand] } },
          siteIds: { [brand]: [] },
          totalSubmissions: 0
        };
        
        await activateStep('step-new', 'arrow-3');
      }
      
      // Show duplicate warning
      if (isDuplicate) {
        document.getElementById('dupWarning').classList.remove('hidden');
        document.getElementById('dupWarning').innerHTML = `
          <div class="dup-warning">
            <strong>⚠ DUPLICATE SUBMISSION DETECTED</strong>
            Same user submitted earlier in this session.<br>
            Previous UID: ${prevSubmission.uid.substring(0, 8)}...<br>
            <strong>NEW unique UID generated for NetSuite.</strong>
          </div>
        `;
      }
      
      await activateStep('step-push', 'arrow-4');
      
      // Generate unique UID for NetSuite
      const uid = generateUUID();
      sessionSubmissions++;
      
      // Track in session
      sessionLeads.push({
        uid,
        masterId,
        email,
        phone,
        brand,
        type: isReturning ? (isDuplicate ? 'DUPLICATE' : 'RETURNING') : 'NEW'
      });
      
      // Update database
      if (database.leads[masterId]) {
        database.leads[masterId].totalSubmissions++;
        if (!database.leads[masterId].siteIds[brand]) {
          database.leads[masterId].siteIds[brand] = [];
        }
        database.leads[masterId].siteIds[brand].push(uid);
      }
      
      document.getElementById('sessionCounter').textContent = sessionSubmissions;
      updateSessionHistory();
      
      // Payloads
      const dataLayer = {
        event: 'lead_identified',
        master_lead_id: masterId,
        submission_uid: uid,
        is_returning: isReturning,
        is_duplicate: isDuplicate,
        match_type: matchType || 'NONE',
        brand: brand,
        device_id: deviceId,
        cross_brand_history: Object.keys(database.leads[masterId]?.siteIds || {})
      };
      
      const netsuite = {
        contactRequestId: uid,
        masterLeadId: masterId,
        isReturning: isReturning,
        isDuplicate: isDuplicate,
        email: email,
        phone: phone,
        name: name,
        brand: brand
      };
      
      document.getElementById('dataLayerPayload').textContent = JSON.stringify(dataLayer, null, 2);
      document.getElementById('netsuitePayload').textContent = JSON.stringify(netsuite, null, 2);
      
      log(`NetSuite UID: ${uid.substring(0, 8)}...`, 'success');
      log('Submission complete ✓', 'success');
      
      btn.disabled = false;
      btn.textContent = 'SUBMIT LEAD';
    }
    
    function resetDemo() {
      sessionSubmissions = 0;
      sessionLeads = [];
      
      // Reset database to original
      delete database.leads['LEAD-ABC123'].siteIds['clg'];
      database.leads['LEAD-ABC123'].totalSubmissions = 3;
      database.leads['LEAD-DEF456'].totalSubmissions = 1;
      
      // Remove any new leads
      for (const id in database.leads) {
        if (!['LEAD-ABC123', 'LEAD-DEF456'].includes(id)) {
          delete database.leads[id];
        }
      }
      
      document.getElementById('sessionCounter').textContent = '0';
      document.querySelectorAll('.flow-step').forEach(el => el.classList.remove('active', 'complete'));
      document.querySelectorAll('.flow-arrow').forEach(el => el.classList.remove('active'));
      
      document.getElementById('lookupStatus').innerHTML = '<span style="color: #666;">Submit a lead to see deduplication...</span>';
      document.getElementById('lookupResult').classList.add('hidden');
      document.getElementById('masterRecord').classList.add('hidden');
      document.getElementById('dupWarning').classList.add('hidden');
      document.getElementById('sessionHistory').innerHTML = '';
      document.getElementById('dataLayerPayload').textContent = '// Submit a lead...';
      document.getElementById('netsuitePayload').textContent = '// Submit a lead...';
      
      clearLog();
      init();
    }
    
    window.onload = init;
  </script>
</body>
</html>
