<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Identity Resolution POC</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: #000;
      color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.4;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    header {
      border: 1px solid #fff;
      padding: 15px 20px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    header h1 {
      font-size: 18px;
      font-weight: normal;
    }
    
    .brand-select {
      background: #000;
      color: #fff;
      border: 1px solid #fff;
      padding: 5px 10px;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 20px;
    }
    
    .panel {
      border: 1px solid #fff;
      padding: 15px;
    }
    
    .panel-title {
      font-size: 12px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #333;
    }
    
    .signal-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 12px;
    }
    
    .signal-label {
      color: #888;
    }
    
    .signal-value {
      color: #fff;
      text-align: right;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-indicator.active {
      background: #fff;
      animation: pulse 1s infinite;
    }
    
    .status-indicator.success {
      background: #fff;
    }
    
    .status-indicator.pending {
      background: #333;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    
    .right-column {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .flow-diagram {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 20px;
      flex-wrap: wrap;
    }
    
    .flow-step {
      border: 1px solid #333;
      padding: 10px 15px;
      text-align: center;
      min-width: 100px;
      font-size: 11px;
      transition: all 0.3s;
    }
    
    .flow-step.active {
      border-color: #fff;
      background: #fff;
      color: #000;
    }
    
    .flow-step.complete {
      border-color: #fff;
    }
    
    .flow-arrow {
      color: #333;
      font-size: 18px;
    }
    
    .flow-arrow.active {
      color: #fff;
    }
    
    .flow-branch {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 12px;
      color: #888;
    }
    
    .form-group input {
      width: 100%;
      background: #000;
      border: 1px solid #fff;
      color: #fff;
      padding: 8px 10px;
      font-family: inherit;
      font-size: 14px;
    }
    
    .form-group input:focus {
      outline: none;
      background: #111;
    }
    
    .btn {
      background: #fff;
      color: #000;
      border: none;
      padding: 10px 20px;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: #ccc;
    }
    
    .btn:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }
    
    .lookup-result {
      font-size: 12px;
      padding: 15px;
      background: #111;
      margin-top: 10px;
    }
    
    .lookup-result.match {
      border-left: 3px solid #fff;
    }
    
    .lookup-result.no-match {
      border-left: 3px solid #333;
    }
    
    .payload-box {
      background: #111;
      padding: 15px;
      font-size: 11px;
      overflow-x: auto;
      white-space: pre;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .payload-label {
      font-size: 11px;
      color: #888;
      margin-bottom: 5px;
      margin-top: 15px;
    }
    
    .payload-label:first-child {
      margin-top: 0;
    }
    
    .event-log {
      height: 200px;
      overflow-y: auto;
      background: #111;
      padding: 10px;
      font-size: 11px;
    }
    
    .log-entry {
      margin-bottom: 5px;
      display: flex;
      gap: 10px;
    }
    
    .log-time {
      color: #666;
      flex-shrink: 0;
    }
    
    .log-indicator {
      flex-shrink: 0;
    }
    
    .log-message {
      color: #fff;
    }
    
    .clear-btn {
      background: transparent;
      color: #666;
      border: 1px solid #333;
      padding: 5px 10px;
      font-size: 11px;
      cursor: pointer;
      float: right;
    }
    
    .clear-btn:hover {
      border-color: #fff;
      color: #fff;
    }
    
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .master-record {
      margin-top: 15px;
      padding: 15px;
      background: #111;
      font-size: 11px;
    }
    
    .master-record h4 {
      margin-bottom: 10px;
      font-weight: normal;
      color: #888;
    }
    
    .device-list {
      margin-top: 10px;
    }
    
    .device-item {
      padding: 8px;
      border: 1px solid #333;
      margin-bottom: 5px;
      font-size: 10px;
    }
    
    .device-item.current {
      border-color: #fff;
    }
    
    .tag {
      display: inline-block;
      border: 1px solid #fff;
      padding: 2px 6px;
      font-size: 10px;
      margin-right: 5px;
      margin-top: 5px;
    }
    
    .hidden {
      display: none;
    }
    
    .processing {
      animation: blink 0.5s infinite;
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>■ IDENTITY RESOLUTION POC</h1>
      <select class="brand-select" id="brandSelect">
        <option value="clg">CLG</option>
        <option value="access-hire">Access Hire</option>
        <option value="access-express">Access Express</option>
      </select>
    </header>
    
    <div class="grid">
      <div class="left-column">
        <div class="panel">
          <div class="panel-title">■ DEVICE SIGNALS</div>
          <div class="signal-row">
            <span class="signal-label">Device ID</span>
            <span class="signal-value" id="deviceId">-</span>
          </div>
          <div class="signal-row">
            <span class="signal-label">Platform</span>
            <span class="signal-value" id="platform">-</span>
          </div>
          <div class="signal-row">
            <span class="signal-label">Screen</span>
            <span class="signal-value" id="screen">-</span>
          </div>
          <div class="signal-row">
            <span class="signal-label">Browser</span>
            <span class="signal-value" id="browser">-</span>
          </div>
          <div class="signal-row">
            <span class="signal-label">Touch</span>
            <span class="signal-value" id="touch">-</span>
          </div>
          <div class="signal-row">
            <span class="signal-label">Timezone</span>
            <span class="signal-value" id="timezone">-</span>
          </div>
          <div class="signal-row">
            <span class="signal-label">Language</span>
            <span class="signal-value" id="language">-</span>
          </div>
          <div style="margin-top: 15px; font-size: 11px;">
            <span class="status-indicator active"></span>
            <span>Signals Captured</span>
          </div>
        </div>
        
        <div class="panel" style="margin-top: 20px;">
          <div class="panel-title">■ VISITOR STATE</div>
          <div class="signal-row">
            <span class="signal-label">Visitor ID</span>
            <span class="signal-value" id="visitorId">-</span>
          </div>
          <div class="signal-row">
            <span class="signal-label">Session ID</span>
            <span class="signal-value" id="sessionId">-</span>
          </div>
          <div class="signal-row">
            <span class="signal-label">Page Views</span>
            <span class="signal-value" id="pageViews">-</span>
          </div>
          <div class="signal-row">
            <span class="signal-label">First Touch</span>
            <span class="signal-value" id="firstTouch">-</span>
          </div>
          <div style="margin-top: 15px; font-size: 11px;">
            <span class="status-indicator success"></span>
            <span>Connected</span>
          </div>
        </div>
        
        <div class="panel" style="margin-top: 20px;">
          <div class="panel-title">■ TEST FORM</div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="testEmail" placeholder="john@example.com">
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="testPhone" placeholder="0412345678">
          </div>
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="testName" placeholder="John Smith">
          </div>
          <button class="btn" id="submitBtn" onclick="submitTestLead()">
            SUBMIT TEST LEAD
          </button>
        </div>
      </div>
      
      <div class="right-column">
        <div class="panel">
          <div class="panel-title">■ PROCESS FLOW</div>
          <div class="flow-diagram">
            <div class="flow-step" id="step-capture">
              CAPTURE<br>SIGNALS
            </div>
            <span class="flow-arrow" id="arrow-1">→</span>
            <div class="flow-step" id="step-check">
              CHECK<br>FIREBASE
            </div>
            <span class="flow-arrow" id="arrow-2">→</span>
            <div class="flow-step" id="step-match">
              MATCH<br>LOOKUP
            </div>
            <span class="flow-arrow" id="arrow-3">→</span>
            <div class="flow-branch">
              <div class="flow-step" id="step-new">
                NEW LEAD<br>CREATED
              </div>
              <span style="color: #333;">OR</span>
              <div class="flow-step" id="step-link">
                LINK TO<br>MASTER
              </div>
            </div>
            <span class="flow-arrow" id="arrow-4">→</span>
            <div class="flow-step" id="step-push">
              PUSH<br>DATA
            </div>
          </div>
        </div>
        
        <div class="two-col">
          <div class="panel">
            <div class="panel-title">■ FIREBASE LOOKUP</div>
            <div id="lookupStatus">
              <span style="color: #666;">Awaiting form submission...</span>
            </div>
            <div id="lookupResult" class="hidden">
            </div>
            <div id="masterRecord" class="hidden">
            </div>
          </div>
          
          <div class="panel">
            <div class="panel-title">■ OUTBOUND PAYLOADS</div>
            <div class="payload-label">▼ DataLayer Push</div>
            <div class="payload-box" id="dataLayerPayload">
// Awaiting submission...
            </div>
            <div class="payload-label">▼ NetSuite Payload</div>
            <div class="payload-box" id="netsuitePayload">
// Awaiting submission...
            </div>
          </div>
        </div>
        
        <div class="panel">
          <div class="panel-title">
            ■ EVENT LOG
            <button class="clear-btn" onclick="clearLog()">CLEAR</button>
          </div>
          <div class="event-log" id="eventLog">
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Dummy data store (simulating Firebase)
    const dummyDatabase = {
      leads: {
        'LEAD-ABC123': {
          masterLeadId: 'LEAD-ABC123',
          email: 'john@example.com',
          phone: '0412345678',
          firstName: 'John',
          lastName: 'Smith',
          firstSeen: '2026-01-15T10:30:00Z',
          devices: {
            'DEV-OLD001': {
              deviceType: 'desktop',
              platform: 'Win32',
              browser: 'Chrome',
              firstSeen: '2026-01-15',
              lastSeen: '2026-01-20',
              sessionCount: 3,
              brands: ['access-hire']
            },
            'DEV-OLD002': {
              deviceType: 'mobile',
              platform: 'iPhone',
              browser: 'Safari',
              firstSeen: '2026-01-18',
              lastSeen: '2026-01-25',
              sessionCount: 5,
              brands: ['access-hire', 'access-express']
            }
          },
          siteIds: {
            'access-hire': ['UID-001', 'UID-003'],
            'access-express': ['UID-002']
          },
          totalSubmissions: 3
        },
        'LEAD-DEF456': {
          masterLeadId: 'LEAD-DEF456',
          email: 'jane@company.com',
          phone: '0498765432',
          firstName: 'Jane',
          lastName: 'Doe',
          firstSeen: '2026-01-20T14:00:00Z',
          devices: {
            'DEV-XYZ999': {
              deviceType: 'desktop',
              platform: 'MacIntel',
              browser: 'Safari',
              firstSeen: '2026-01-20',
              lastSeen: '2026-01-27',
              sessionCount: 2,
              brands: ['clg']
            }
          },
          siteIds: {
            'clg': ['UID-004']
          },
          totalSubmissions: 1
        }
      }
    };
    
    // Current state
    let currentDeviceId = null;
    let currentVisitorId = null;
    let currentSessionId = null;
    
    // Generate IDs
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16).toUpperCase();
      });
    }
    
    function generateShortId(prefix) {
      return prefix + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();
    }
    
    // Logging
    function log(message, type = 'info') {
      const logEl = document.getElementById('eventLog');
      const time = new Date().toLocaleTimeString('en-AU', { hour12: false });
      const indicator = type === 'success' ? '●' : type === 'processing' ? '◐' : '○';
      
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `
        <span class="log-time">${time}</span>
        <span class="log-indicator">${indicator}</span>
        <span class="log-message">${message}</span>
      `;
      logEl.insertBefore(entry, logEl.firstChild);
    }
    
    function clearLog() {
      document.getElementById('eventLog').innerHTML = '';
    }
    
    // Initialize device signals
    function initializeSignals() {
      currentDeviceId = generateShortId('DEV');
      currentVisitorId = generateShortId('VIS');
      currentSessionId = generateShortId('SES');
      
      // Device signals
      document.getElementById('deviceId').textContent = currentDeviceId;
      document.getElementById('platform').textContent = navigator.platform || 'Unknown';
      document.getElementById('screen').textContent = `${screen.width}x${screen.height}`;
      document.getElementById('browser').textContent = getBrowserName();
      document.getElementById('touch').textContent = 'ontouchstart' in window ? 'Yes' : 'No';
      document.getElementById('timezone').textContent = Intl.DateTimeFormat().resolvedOptions().timeZone;
      document.getElementById('language').textContent = navigator.language;
      
      // Visitor state
      document.getElementById('visitorId').textContent = currentVisitorId;
      document.getElementById('sessionId').textContent = currentSessionId;
      document.getElementById('pageViews').textContent = Math.floor(Math.random() * 5) + 1;
      document.getElementById('firstTouch').textContent = ['google', 'direct', 'facebook', 'linkedin'][Math.floor(Math.random() * 4)];
      
      log('Device signals captured');
      log('Visitor ID generated: ' + currentVisitorId);
      log('Session initialized: ' + currentSessionId);
      
      // Activate first step
      document.getElementById('step-capture').classList.add('complete');
    }
    
    function getBrowserName() {
      const ua = navigator.userAgent;
      if (ua.includes('Chrome')) return 'Chrome';
      if (ua.includes('Safari')) return 'Safari';
      if (ua.includes('Firefox')) return 'Firefox';
      if (ua.includes('Edge')) return 'Edge';
      return 'Unknown';
    }
    
    // Flow step animation
    function activateStep(stepId, arrowId) {
      if (arrowId) {
        document.getElementById(arrowId).classList.add('active');
      }
      const step = document.getElementById(stepId);
      step.classList.add('active');
      
      return new Promise(resolve => {
        setTimeout(() => {
          step.classList.remove('active');
          step.classList.add('complete');
          resolve();
        }, 800);
      });
    }
    
    // Firebase lookup simulation
    function lookupInFirebase(email, phone) {
      // Search by email first, then phone
      for (const leadId in dummyDatabase.leads) {
        const lead = dummyDatabase.leads[leadId];
        if (lead.email === email || lead.phone === phone) {
          return lead;
        }
      }
      return null;
    }
    
    // Submit test lead
    async function submitTestLead() {
      const email = document.getElementById('testEmail').value;
      const phone = document.getElementById('testPhone').value;
      const name = document.getElementById('testName').value;
      const brand = document.getElementById('brandSelect').value;
      
      if (!email && !phone) {
        alert('Please enter at least an email or phone number');
        return;
      }
      
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = 'PROCESSING...';
      
      // Reset flow
      document.querySelectorAll('.flow-step').forEach(el => {
        el.classList.remove('active', 'complete');
      });
      document.querySelectorAll('.flow-arrow').forEach(el => {
        el.classList.remove('active');
      });
      document.getElementById('step-capture').classList.add('complete');
      
      log('Form submitted - starting identity resolution');
      
      // Step 1: Check Firebase
      await activateStep('step-check', 'arrow-1');
      log('Checking Firebase for existing lead...', 'processing');
      
      document.getElementById('lookupStatus').innerHTML = `
        <div class="processing">
          Checking email: ${email || '(not provided)'}<br>
          Checking phone: ${phone || '(not provided)'}
        </div>
      `;
      
      await new Promise(r => setTimeout(r, 500));
      
      // Step 2: Match lookup
      await activateStep('step-match', 'arrow-2');
      const existingLead = lookupInFirebase(email, phone);
      
      let masterLeadId;
      let isReturning = false;
      let matchedLead = null;
      
      if (existingLead) {
        // Found existing lead
        isReturning = true;
        masterLeadId = existingLead.masterLeadId;
        matchedLead = existingLead;
        
        log('MATCH FOUND: ' + masterLeadId, 'success');
        
        document.getElementById('lookupStatus').innerHTML = '';
        document.getElementById('lookupResult').classList.remove('hidden');
        document.getElementById('lookupResult').className = 'lookup-result match';
        document.getElementById('lookupResult').innerHTML = `
          <strong>✓ MATCH FOUND</strong><br><br>
          Master ID: ${masterLeadId}<br>
          Email: ${existingLead.email}<br>
          Phone: ${existingLead.phone}<br>
          Previous submissions: ${existingLead.totalSubmissions}<br>
          Known devices: ${Object.keys(existingLead.devices).length}<br>
          Brands: ${Object.keys(existingLead.siteIds).join(', ')}
        `;
        
        // Show master record
        document.getElementById('masterRecord').classList.remove('hidden');
        document.getElementById('masterRecord').innerHTML = `
          <div class="master-record">
            <h4>MASTER RECORD</h4>
            <div>First seen: ${new Date(existingLead.firstSeen).toLocaleDateString()}</div>
            <div>Total submissions: ${existingLead.totalSubmissions}</div>
            <div class="device-list">
              <div style="color: #888; margin-bottom: 5px;">KNOWN DEVICES:</div>
              ${Object.entries(existingLead.devices).map(([id, dev]) => `
                <div class="device-item">
                  ${id}<br>
                  ${dev.deviceType} / ${dev.platform} / ${dev.browser}<br>
                  Sessions: ${dev.sessionCount} | Brands: ${dev.brands.join(', ')}
                </div>
              `).join('')}
              <div class="device-item current">
                ${currentDeviceId} (CURRENT)<br>
                ${getDeviceType()} / ${navigator.platform} / ${getBrowserName()}<br>
                <span class="tag">NEW DEVICE</span>
              </div>
            </div>
          </div>
        `;
        
        // Activate link step
        await activateStep('step-link', 'arrow-3');
        log('Device linked to master record');
        
      } else {
        // New lead
        masterLeadId = generateShortId('LEAD');
        
        log('No match found - creating new lead: ' + masterLeadId);
        
        document.getElementById('lookupStatus').innerHTML = '';
        document.getElementById('lookupResult').classList.remove('hidden');
        document.getElementById('lookupResult').className = 'lookup-result no-match';
        document.getElementById('lookupResult').innerHTML = `
          <strong>○ NO MATCH FOUND</strong><br><br>
          Creating new master lead...<br>
          Master ID: ${masterLeadId}
        `;
        
        document.getElementById('masterRecord').classList.remove('hidden');
        document.getElementById('masterRecord').innerHTML = `
          <div class="master-record">
            <h4>NEW MASTER RECORD</h4>
            <div>Email: ${email || '(not provided)'}</div>
            <div>Phone: ${phone || '(not provided)'}</div>
            <div>Created: ${new Date().toLocaleString()}</div>
            <div class="device-list">
              <div style="color: #888; margin-bottom: 5px;">DEVICES:</div>
              <div class="device-item current">
                ${currentDeviceId}<br>
                ${getDeviceType()} / ${navigator.platform} / ${getBrowserName()}<br>
                <span class="tag">FIRST DEVICE</span>
              </div>
            </div>
          </div>
        `;
        
        // Activate new step
        await activateStep('step-new', 'arrow-3');
        log('New lead created in Firebase');
      }
      
      // Step 3: Push data
      await activateStep('step-push', 'arrow-4');
      
      const submissionUid = generateUUID();
      
      // Generate payloads
      const dataLayerPayload = {
        event: 'lead_identified',
        master_lead_id: masterLeadId,
        submission_uid: submissionUid,
        is_returning_lead: isReturning,
        current_device_id: currentDeviceId,
        is_new_device: true,
        known_devices: isReturning ? Object.keys(matchedLead.devices).length + 1 : 1,
        cross_brand_history: isReturning ? Object.keys(matchedLead.siteIds) : [brand],
        total_submissions: isReturning ? matchedLead.totalSubmissions + 1 : 1,
        visitor_id: currentVisitorId,
        session_id: currentSessionId,
        brand: brand
      };
      
      const netsuitePayload = {
        contactRequestId: submissionUid,
        masterLeadId: masterLeadId,
        isReturningLead: isReturning,
        contactEmail: email,
        contactPhone: phone,
        contactName: name,
        sourceBrand: brand,
        deviceId: currentDeviceId,
        visitorId: currentVisitorId,
        previousSubmissions: isReturning ? matchedLead.totalSubmissions : 0,
        knownBrands: isReturning ? Object.keys(matchedLead.siteIds) : [brand]
      };
      
      document.getElementById('dataLayerPayload').textContent = JSON.stringify(dataLayerPayload, null, 2);
      document.getElementById('netsuitePayload').textContent = JSON.stringify(netsuitePayload, null, 2);
      
      log('DataLayer push: lead_identified', 'success');
      log('NetSuite payload ready: ' + submissionUid, 'success');
      log('Identity resolution complete', 'success');
      
      btn.disabled = false;
      btn.textContent = 'SUBMIT TEST LEAD';
    }
    
    function getDeviceType() {
      if ('ontouchstart' in window && screen.width < 768) return 'mobile';
      if ('ontouchstart' in window) return 'tablet';
      return 'desktop';
    }
    
    // Initialize on load
    window.onload = function() {
      initializeSignals();
      
      // Pre-fill with matching email for demo
      document.getElementById('testEmail').value = 'john@example.com';
      document.getElementById('testPhone').value = '0412345678';
      document.getElementById('testName').value = 'John Smith';
    };
  </script>
</body>
</html>
