<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CLG Identity Resolution - Lead Flow</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0a0a0a;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 13px;
      height: 100vh;
      overflow: hidden;
    }

    .app {
      display: grid;
      grid-template-columns: 240px 1fr 240px;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      background: #0d0d0d;
      border-right: 1px solid #1a1a1a;
      padding: 16px;
      overflow-y: auto;
    }

    .sidebar h1 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .sidebar .subtitle {
      font-size: 11px;
      color: #666;
      margin-bottom: 20px;
    }

    .panel-title {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #555;
      margin-bottom: 12px;
    }

    /* Presets Grid */
    .presets {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 20px;
    }
    .preset {
      background: #111;
      border: 1px solid #222;
      border-radius: 6px;
      padding: 10px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    .preset:hover { border-color: #444; }
    .preset.active { border-color: #fff; background: #1a1a1a; }
    .preset-icon { font-size: 18px; margin-bottom: 4px; }
    .preset-label { font-size: 10px; font-weight: 600; color: #888; }

    /* Form */
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      font-size: 10px;
      color: #555;
      margin-bottom: 4px;
      text-transform: uppercase;
    }
    .form-group input, .form-group select {
      width: 100%;
      background: #0a0a0a;
      border: 1px solid #222;
      border-radius: 4px;
      color: #fff;
      padding: 8px 10px;
      font-size: 12px;
    }
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #444;
    }

    /* Playback Controls */
    .playback {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .playback button {
      flex: 1;
      padding: 10px;
      border: 1px solid #222;
      border-radius: 4px;
      background: #111;
      color: #888;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .playback button:hover { border-color: #444; color: #fff; }
    .playback button.active { background: #fff; color: #000; border-color: #fff; }
    .playback button:disabled { opacity: 0.3; cursor: not-allowed; }

    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: #fff; color: #000; }
    .btn-primary:hover { background: #ddd; }
    .btn-primary:disabled { background: #333; color: #666; cursor: not-allowed; }
    .btn-secondary { background: transparent; color: #666; border: 1px solid #333; margin-top: 8px; }
    .btn-secondary:hover { border-color: #666; color: #999; }

    /* IDs Panel */
    .ids-panel { margin-top: 20px; }
    .id-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #1a1a1a;
    }
    .id-row:last-child { border-bottom: none; }
    .id-label { font-size: 10px; color: #555; text-transform: uppercase; }
    .id-value { font-family: monospace; font-size: 11px; color: #444; }
    .id-value.set { color: #0f0; }

    /* Main Flow Area */
    .main-area {
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow: hidden;
    }

    .flow-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
    }

    .flow-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    /* Flow Steps */
    .flow-step {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .step-num {
      width: 28px;
      height: 28px;
      border: 2px solid #333;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: #444;
      flex-shrink: 0;
      transition: all 0.3s;
    }
    .step-num.active {
      border-color: #fff;
      background: #fff;
      color: #000;
      transform: scale(1.15);
    }
    .step-num.done { border-color: #0f0; color: #0f0; }
    .step-num.warning { border-color: #f90; color: #f90; }

    .step-box {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #111;
      border: 2px solid #222;
      border-radius: 8px;
      padding: 12px 16px;
      min-width: 320px;
      transition: all 0.3s;
    }
    .step-box.active {
      border-color: #fff;
      background: #1a1a1a;
      box-shadow: 0 0 20px rgba(255,255,255,0.1);
      transform: scale(1.02);
    }
    .step-box.done { border-color: #333; opacity: 0.7; }
    .step-box.warning { border-color: #f90; background: #1a1500; }

    .step-icon {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    .step-icon.firebase { background: #2e2a1a; }
    .step-icon.site { background: #1a1a2e; }
    .step-icon.adapter { background: #1a2e1a; }
    .step-icon.netsuite { background: #2e1a1a; }
    .step-icon.iterable { background: #2e1a2e; }
    .step-icon.amplitude { background: #2e2e1a; }
    .step-icon.sales { background: #2e2a1a; }

    .step-content { flex: 1; min-width: 0; }
    .step-name { font-weight: 600; font-size: 13px; margin-bottom: 2px; }
    .step-desc { font-size: 11px; color: #666; }

    .step-badge {
      font-size: 9px;
      padding: 3px 6px;
      border-radius: 3px;
      text-transform: uppercase;
      font-weight: 600;
      flex-shrink: 0;
    }
    .step-badge.datalayer { background: #0ff2; color: #0ff; }
    .step-badge.sdk { background: #ff02; color: #ff0; }

    .flow-connector {
      width: 2px;
      height: 12px;
      background: #222;
      margin-left: 13px;
    }
    .flow-connector.active { background: #fff; }
    .flow-connector.done { background: #333; }

    /* Branch */
    .flow-branch {
      display: flex;
      gap: 20px;
      margin: 8px 0;
    }
    .branch-box {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #111;
      border: 2px solid #222;
      border-radius: 8px;
      padding: 10px 14px;
      transition: all 0.3s;
    }
    .branch-box.active { border-color: #fff; background: #1a1a1a; }
    .branch-box.done { border-color: #333; opacity: 0.7; }
    .branch-icon { font-size: 14px; }
    .branch-name { font-weight: 600; font-size: 12px; }

    /* Duplicate Alert */
    .dup-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px dashed #f90;
      display: none;
    }
    .dup-section.show { display: block; }
    .dup-label {
      text-align: center;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #f90;
      margin-bottom: 12px;
    }

    /* Annotation */
    .annotation {
      background: #111;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 16px 20px;
      margin-top: 16px;
      min-height: 100px;
    }
    .annotation-title {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #555;
      margin-bottom: 10px;
    }
    .annotation-text {
      font-size: 16px;
      color: #888;
      line-height: 1.5;
    }
    .annotation-text.active { color: #fff; }
    .annotation-text code {
      font-family: monospace;
      font-size: 13px;
      background: #1a1a1a;
      padding: 2px 6px;
      border-radius: 3px;
      color: #0ff;
    }

    /* Logs Panel */
    .logs-panel {
      background: #0d0d0d;
      border-left: 1px solid #1a1a1a;
      display: flex;
      flex-direction: column;
    }
    .logs-header {
      padding: 16px;
      border-bottom: 1px solid #1a1a1a;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logs-header h3 {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #555;
    }
    .clear-btn {
      background: transparent;
      border: 1px solid #222;
      color: #555;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 10px;
      cursor: pointer;
    }
    .clear-btn:hover { border-color: #444; color: #888; }

    .log-container {
      flex: 1;
      overflow-y: auto;
      font-family: monospace;
      font-size: 10px;
    }
    .log-entry {
      padding: 6px 12px;
      border-bottom: 1px solid #111;
      display: flex;
      gap: 8px;
    }
    .log-time { color: #333; width: 55px; flex-shrink: 0; }
    .log-source {
      width: 55px;
      flex-shrink: 0;
      padding: 1px 4px;
      border-radius: 2px;
      text-align: center;
      font-size: 8px;
      font-weight: 600;
    }
    .log-source.firebase { background: #2e2a1a; color: #fa0; }
    .log-source.site { background: #1a1a2e; color: #88f; }
    .log-source.datalayer { background: #1a2e2e; color: #0ff; }
    .log-source.adapter { background: #1a2e1a; color: #8f8; }
    .log-source.netsuite { background: #2e1a1a; color: #f88; }
    .log-source.iterable { background: #2e1a2e; color: #f8f; }
    .log-source.amplitude { background: #2e2e1a; color: #ff8; }
    .log-source.sales { background: #2e2a1a; color: #fa8; }
    .log-message { color: #666; flex: 1; }
  </style>
</head>
<body>
  <div class="app">
    <!-- Left Sidebar -->
    <div class="sidebar">
      <h1>Identity Resolution</h1>
      <p class="subtitle">CLG Lead Flow Demo</p>

      <div class="panel-title">Scenario</div>
      <div class="presets">
        <div class="preset active" data-scenario="new" onclick="selectPreset(this)">
          <div class="preset-icon">üë§</div>
          <div class="preset-label">New User</div>
        </div>
        <div class="preset" data-scenario="device" onclick="selectPreset(this)">
          <div class="preset-icon">üì±</div>
          <div class="preset-label">Same Device</div>
        </div>
        <div class="preset" data-scenario="email" onclick="selectPreset(this)">
          <div class="preset-icon">üìß</div>
          <div class="preset-label">Same Email</div>
        </div>
        <div class="preset" data-scenario="phone" onclick="selectPreset(this)">
          <div class="preset-icon">üìû</div>
          <div class="preset-label">Same Phone</div>
        </div>
        <div class="preset" data-scenario="crossbrand" onclick="selectPreset(this)">
          <div class="preset-icon">üè¢</div>
          <div class="preset-label">Cross-Brand</div>
        </div>
        <div class="preset" data-scenario="duplicate" onclick="selectPreset(this)">
          <div class="preset-icon">‚ö†Ô∏è</div>
          <div class="preset-label">Full Duplicate</div>
        </div>
      </div>

      <div class="panel-title">Lead Details</div>
      <div class="form-group">
        <label>Brand</label>
        <select id="brand">
          <option value="access-hire">Access Hire</option>
          <option value="access-express">Access Express</option>
          <option value="clg">CLG Landing Page</option>
        </select>
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" value="newlead@company.com">
      </div>
      <div class="form-group">
        <label>Phone</label>
        <input type="tel" id="phone" value="0400111222">
      </div>
      <div class="form-group">
        <label>Name</label>
        <input type="text" id="name" value="New Lead">
      </div>

      <div class="panel-title">Playback</div>
      <div class="playback">
        <button id="autoBtn" class="active" onclick="setMode('auto')">Auto</button>
        <button id="manualBtn" onclick="setMode('manual')">Manual</button>
      </div>

      <button class="btn btn-primary" id="runBtn" onclick="runFlow()">
        Run Flow
      </button>
      <button class="btn btn-secondary" id="nextBtn" onclick="nextStep()" disabled style="display:none">
        Next Step ‚Üí
      </button>
      <button class="btn btn-secondary" onclick="resetDemo()">Reset</button>

      <div class="ids-panel">
        <div class="panel-title">Generated IDs</div>
        <div class="id-row">
          <span class="id-label">UID</span>
          <span class="id-value" id="displayUid">‚Äî</span>
        </div>
        <div class="id-row">
          <span class="id-label">NS Lead</span>
          <span class="id-value" id="displayNsId">‚Äî</span>
        </div>
        <div class="id-row">
          <span class="id-label">Amplitude</span>
          <span class="id-value" id="displayAmpId">‚Äî</span>
        </div>
      </div>
    </div>

    <!-- Main Flow Area -->
    <div class="main-area">
      <div class="flow-wrapper">
        <div class="flow-container">
          <!-- Step 1: Firebase SDK -->
          <div class="flow-step">
            <div class="step-num" id="num-1">1</div>
            <div class="step-box" id="box-firebase">
              <div class="step-icon firebase">üî•</div>
              <div class="step-content">
                <div class="step-name">Firebase SDK</div>
                <div class="step-desc">Generate UID, check device fingerprint</div>
              </div>
              <div class="step-badge sdk">SDK</div>
            </div>
          </div>

          <div class="flow-connector" id="conn-1"></div>

          <!-- Step 2: Form Submit -->
          <div class="flow-step">
            <div class="step-num" id="num-2">2</div>
            <div class="step-box" id="box-form">
              <div class="step-icon site">üìù</div>
              <div class="step-content">
                <div class="step-name">Form Submission</div>
                <div class="step-desc">User submits lead form with UID attached</div>
              </div>
              <div class="step-badge datalayer">form_submit</div>
            </div>
          </div>

          <div class="flow-connector" id="conn-2"></div>

          <!-- Step 3: NS Adapter -->
          <div class="flow-step">
            <div class="step-num" id="num-3">3</div>
            <div class="step-box" id="box-adapter">
              <div class="step-icon adapter">‚ö°</div>
              <div class="step-content">
                <div class="step-name">NS Adapter</div>
                <div class="step-desc">Transform data, check email/phone duplicates</div>
              </div>
            </div>
          </div>

          <div class="flow-connector" id="conn-3"></div>

          <!-- Step 4: NetSuite -->
          <div class="flow-step">
            <div class="step-num" id="num-4">4</div>
            <div class="step-box" id="box-netsuite">
              <div class="step-icon netsuite">üè¢</div>
              <div class="step-content">
                <div class="step-name">NetSuite</div>
                <div class="step-desc">Create lead record in CRM</div>
              </div>
              <div class="step-badge datalayer">lead_created</div>
            </div>
          </div>

          <div class="flow-connector" id="conn-4"></div>

          <!-- Step 5: Branch -->
          <div class="flow-branch" id="branch-sync">
            <div class="branch-box" id="box-iterable">
              <span class="branch-icon">üìß</span>
              <span class="branch-name">Iterable</span>
            </div>
            <div class="branch-box" id="box-amplitude">
              <span class="branch-icon">üìä</span>
              <span class="branch-name">Amplitude</span>
            </div>
          </div>

          <div class="flow-connector" id="conn-5"></div>

          <!-- Step 6: Enrichment -->
          <div class="flow-step">
            <div class="step-num" id="num-6">6</div>
            <div class="step-box" id="box-enrich">
              <div class="step-icon site">‚ú®</div>
              <div class="step-content">
                <div class="step-name">Enrichment Webhook</div>
                <div class="step-desc">Amplitude sends enriched profile back</div>
              </div>
              <div class="step-badge datalayer">lead_enriched</div>
            </div>
          </div>

          <!-- Duplicate Alert Section -->
          <div class="dup-section" id="dup-section">
            <div class="dup-label">‚ö†Ô∏è Duplicate Alert Flow</div>

            <div class="flow-step">
              <div class="step-num" id="num-7">7</div>
              <div class="step-box" id="box-amp-event">
                <div class="step-icon amplitude">üìä</div>
                <div class="step-content">
                  <div class="step-name">Amplitude Event</div>
                  <div class="step-desc">Push duplicate_detected event</div>
                </div>
              </div>
            </div>

            <div class="flow-connector" id="conn-7"></div>

            <div class="flow-step">
              <div class="step-num" id="num-8">8</div>
              <div class="step-box" id="box-iterable-journey">
                <div class="step-icon iterable">üìß</div>
                <div class="step-content">
                  <div class="step-name">Iterable Journey</div>
                  <div class="step-desc">Trigger sales notification workflow</div>
                </div>
              </div>
            </div>

            <div class="flow-connector" id="conn-8"></div>

            <div class="flow-step">
              <div class="step-num" id="num-9">9</div>
              <div class="step-box" id="box-sales">
                <div class="step-icon sales">üë§</div>
                <div class="step-content">
                  <div class="step-name">Sales Alert</div>
                  <div class="step-desc">Email sent to sales team with duplicate info</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Annotation -->
      <div class="annotation">
        <div class="annotation-title">What's Happening</div>
        <div class="annotation-text" id="annotation">
          Select a scenario and click "Run Flow" to see the identity resolution process in action.
        </div>
      </div>
    </div>

    <!-- Right Logs Panel -->
    <div class="logs-panel">
      <div class="logs-header">
        <h3>Event Log</h3>
        <button class="clear-btn" onclick="clearLog()">Clear</button>
      </div>
      <div class="log-container" id="eventLog"></div>
    </div>
  </div>

  <script>
    const scenarios = {
      'new': {
        email: 'newlead@company.com', phone: '0400111222', name: 'New Lead',
        deviceMatch: false, emailMatch: false, phoneMatch: false,
        desc: 'Brand new user, no matches found anywhere'
      },
      'device': {
        email: 'returning@company.com', phone: '0400222333', name: 'Returning User',
        deviceMatch: true, emailMatch: false, phoneMatch: false,
        desc: 'Same device fingerprint detected by Firebase SDK'
      },
      'email': {
        email: 'existing@company.com', phone: '0400333444', name: 'Email Match',
        deviceMatch: false, emailMatch: true, phoneMatch: false,
        desc: 'Email already exists in NetSuite (detected by NS Adapter)'
      },
      'phone': {
        email: 'phoneuser@company.com', phone: '0412345678', name: 'Phone Match',
        deviceMatch: false, emailMatch: false, phoneMatch: true,
        desc: 'Phone number already exists in NetSuite (detected by NS Adapter)'
      },
      'crossbrand': {
        email: 'crossbrand@company.com', phone: '0400555666', name: 'Cross Brand',
        deviceMatch: true, emailMatch: true, phoneMatch: false,
        desc: 'User from different brand site with same device and email'
      },
      'duplicate': {
        email: 'john.smith@existing.com', phone: '0412345678', name: 'John Smith',
        deviceMatch: true, emailMatch: true, phoneMatch: true,
        desc: 'Full duplicate: device, email, and phone all match existing records'
      }
    };

    let mode = 'auto';
    let currentStep = 0;
    let stepQueue = [];
    let currentScenario = scenarios['new'];

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16).toUpperCase();
      });
    }

    function log(source, message) {
      const el = document.getElementById('eventLog');
      const time = new Date().toLocaleTimeString('en-AU', { hour12: false });
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `
        <span class="log-time">${time}</span>
        <span class="log-source ${source.toLowerCase()}">${source}</span>
        <span class="log-message">${message}</span>
      `;
      el.insertBefore(entry, el.firstChild);
    }

    function clearLog() {
      document.getElementById('eventLog').innerHTML = '';
    }

    function setAnnotation(text, active = true) {
      const el = document.getElementById('annotation');
      el.innerHTML = text;
      el.className = 'annotation-text' + (active ? ' active' : '');
    }

    function selectPreset(el) {
      document.querySelectorAll('.preset').forEach(p => p.classList.remove('active'));
      el.classList.add('active');
      const s = scenarios[el.dataset.scenario];
      currentScenario = s;
      document.getElementById('email').value = s.email;
      document.getElementById('phone').value = s.phone;
      document.getElementById('name').value = s.name;
      setAnnotation(`<strong>${el.querySelector('.preset-label').textContent}:</strong> ${s.desc}`, false);
    }

    function setMode(m) {
      mode = m;
      document.getElementById('autoBtn').classList.toggle('active', m === 'auto');
      document.getElementById('manualBtn').classList.toggle('active', m === 'manual');
      document.getElementById('nextBtn').style.display = m === 'manual' ? 'block' : 'none';
    }

    function activateStep(num) {
      const el = document.getElementById('num-' + num);
      if (el) el.classList.add('active');
    }

    function completeStep(num, warning = false) {
      const el = document.getElementById('num-' + num);
      if (el) {
        el.classList.remove('active');
        el.classList.add(warning ? 'warning' : 'done');
      }
    }

    async function activateBox(id, warning = false) {
      const box = document.getElementById(id);
      if (!box) return;
      box.classList.add('active');
      if (warning) box.classList.add('warning');
      return new Promise(r => setTimeout(() => {
        box.classList.remove('active');
        box.classList.add('done');
        r();
      }, mode === 'auto' ? 500 : 200));
    }

    function activateConnector(id) {
      const el = document.getElementById(id);
      if (el) {
        el.classList.add('active');
        setTimeout(() => {
          el.classList.remove('active');
          el.classList.add('done');
        }, 200);
      }
    }

    async function executeStep(step) {
      await step.fn();
      if (mode === 'manual') {
        document.getElementById('nextBtn').disabled = false;
      }
    }

    function nextStep() {
      if (stepQueue.length > 0) {
        document.getElementById('nextBtn').disabled = true;
        const step = stepQueue.shift();
        executeStep(step);
      }
    }

    async function runFlow() {
      const s = currentScenario;
      const brand = document.getElementById('brand').value;
      const uid = generateUUID();
      const nsId = 'NS-' + Math.floor(Math.random() * 100000);
      const ampId = 'AMP-' + uid.substring(0, 8);

      const hasDuplicate = s.deviceMatch || s.emailMatch || s.phoneMatch;

      document.getElementById('runBtn').disabled = true;
      document.getElementById('nextBtn').disabled = true;

      // Reset UI
      document.querySelectorAll('.step-num').forEach(el => el.classList.remove('active', 'done', 'warning'));
      document.querySelectorAll('.step-box, .branch-box').forEach(el => el.classList.remove('active', 'done', 'warning'));
      document.querySelectorAll('.flow-connector').forEach(el => el.classList.remove('active', 'done'));
      document.getElementById('dup-section').classList.remove('show');

      // Build step queue
      stepQueue = [
        // Step 1: Firebase
        {
          fn: async () => {
            activateStep(1);
            setAnnotation(`<strong>Step 1: Firebase SDK initializes</strong><br>Generating unique identifier (UID) on the frontend using Firebase SDK. Also checking device fingerprint against known devices.`);
            log('FIREBASE', 'SDK initialized on page load');
            log('FIREBASE', `Generated UID: ${uid.substring(0, 8)}...`);
            document.getElementById('displayUid').textContent = uid.substring(0, 18) + '...';
            document.getElementById('displayUid').classList.add('set');

            if (s.deviceMatch) {
              log('FIREBASE', '‚ö†Ô∏è Device fingerprint MATCH detected');
              setAnnotation(`<strong>Step 1: Firebase SDK</strong><br>‚ö†Ô∏è <span style="color:#f90">Device match detected!</span> This device has submitted leads before. Adding <code>duplicate_alert: device_match</code> to the payload.`);
              await activateBox('box-firebase', true);
              completeStep(1, true);
            } else {
              log('FIREBASE', 'Device fingerprint: no match');
              await activateBox('box-firebase');
              completeStep(1);
            }
            activateConnector('conn-1');
          }
        },
        // Step 2: Form Submit
        {
          fn: async () => {
            activateStep(2);
            setAnnotation(`<strong>Step 2: Form Submission</strong><br>User submits lead form. DataLayer receives <code>form_submit</code> event with UID, email, phone, and any duplicate alerts attached.`);
            log('SITE', `Form submitted on ${brand}`);
            log('DATALAYER', `Push: form_submit { uid: "${uid.substring(0, 8)}...", email, phone${s.deviceMatch ? ', duplicate_alert: "device"' : ''} }`);
            await activateBox('box-form', s.deviceMatch);
            completeStep(2, s.deviceMatch);
            activateConnector('conn-2');
          }
        },
        // Step 3: NS Adapter
        {
          fn: async () => {
            activateStep(3);
            setAnnotation(`<strong>Step 3: NS Adapter Processing</strong><br>Adapter receives lead data and checks for duplicates by email and phone against NetSuite records.`);
            log('ADAPTER', 'Received lead data from site');
            log('ADAPTER', 'Checking email against existing records...');

            const adapterWarning = s.emailMatch || s.phoneMatch;

            if (s.emailMatch) {
              log('ADAPTER', '‚ö†Ô∏è Email MATCH found in NetSuite');
            } else {
              log('ADAPTER', 'Email: no match');
            }

            log('ADAPTER', 'Checking phone against existing records...');
            if (s.phoneMatch) {
              log('ADAPTER', '‚ö†Ô∏è Phone MATCH found in NetSuite');
            } else {
              log('ADAPTER', 'Phone: no match');
            }

            if (adapterWarning) {
              setAnnotation(`<strong>Step 3: NS Adapter</strong><br>‚ö†Ô∏è <span style="color:#f90">Duplicate detected!</span> ${s.emailMatch ? 'Email' : ''}${s.emailMatch && s.phoneMatch ? ' and ' : ''}${s.phoneMatch ? 'Phone' : ''} match found. Lead will still be created but flagged for review.`);
            }

            log('ADAPTER', 'Transforming payload for NetSuite API');
            await activateBox('box-adapter', adapterWarning);
            completeStep(3, adapterWarning);
            activateConnector('conn-3');
          }
        },
        // Step 4: NetSuite
        {
          fn: async () => {
            activateStep(4);
            setAnnotation(`<strong>Step 4: NetSuite Lead Creation</strong><br>Creating new lead record in NetSuite CRM. The UID ensures uniqueness even for duplicates. DataLayer receives <code>lead_created</code> event.`);
            log('NETSUITE', 'API: Creating lead record');
            await new Promise(r => setTimeout(r, 300));

            document.getElementById('displayNsId').textContent = nsId;
            document.getElementById('displayNsId').classList.add('set');
            log('NETSUITE', `Lead created: ${nsId}`);

            if (hasDuplicate) {
              log('NETSUITE', '‚ö†Ô∏è Lead created with duplicate flag');
              if (s.deviceMatch) log('NETSUITE', `Alert in record: "Device previously seen"`);
            }

            log('DATALAYER', `Push: lead_created { nsId: "${nsId}", uid: "${uid.substring(0, 8)}..." }`);
            await activateBox('box-netsuite', hasDuplicate);
            completeStep(4, hasDuplicate);
            activateConnector('conn-4');
          }
        },
        // Step 5: Sync to Iterable + Amplitude
        {
          fn: async () => {
            setAnnotation(`<strong>Step 5: Platform Sync</strong><br>NetSuite sends lead data to both Iterable (for email marketing) and Amplitude (for analytics) simultaneously.`);
            log('NETSUITE', '‚Üí Webhook: Sending to Iterable');
            log('NETSUITE', '‚Üí Webhook: Sending to Amplitude');

            await activateBox('box-iterable');
            log('ITERABLE', 'Contact created');
            log('ITERABLE', 'Added to welcome sequence');

            document.getElementById('displayAmpId').textContent = ampId;
            document.getElementById('displayAmpId').classList.add('set');
            await activateBox('box-amplitude');
            log('AMPLITUDE', `User profile created: ${ampId}`);

            activateConnector('conn-5');
          }
        },
        // Step 6: Enrichment
        {
          fn: async () => {
            activateStep(6);
            setAnnotation(`<strong>Step 6: Enrichment Webhook</strong><br>Amplitude computes user properties and sends enriched profile back to the site via webhook. DataLayer receives <code>lead_enriched</code> event for personalization.`);
            log('AMPLITUDE', '‚Üí Webhook: Sending enriched data to site');
            log('SITE', 'Received enrichment webhook');
            log('DATALAYER', 'Push: lead_enriched { segment, predicted_value, interests }');
            await activateBox('box-enrich');
            completeStep(6);
          }
        }
      ];

      // Add duplicate alert steps if needed
      if (hasDuplicate) {
        stepQueue.push(
          // Step 7: Amplitude Event
          {
            fn: async () => {
              document.getElementById('dup-section').classList.add('show');
              activateStep(7);
              const source = s.deviceMatch ? 'Firebase (device)' : s.emailMatch ? 'NS Adapter (email)' : 'NS Adapter (phone)';
              setAnnotation(`<strong>Step 7: Duplicate Event</strong><br>Amplitude receives <code>duplicate_detected</code> event with source: ${source}. This triggers the sales alert workflow.`);
              log('AMPLITUDE', `Event: duplicate_detected { source: "${source}" }`);
              await activateBox('box-amp-event');
              completeStep(7);
              activateConnector('conn-7');
            }
          },
          // Step 8: Iterable Journey
          {
            fn: async () => {
              activateStep(8);
              setAnnotation(`<strong>Step 8: Iterable Journey</strong><br>Amplitude event triggers an Iterable journey that sends a notification to the sales team about the potential duplicate.`);
              log('ITERABLE', 'Journey triggered: "Duplicate Lead Alert"');
              log('ITERABLE', 'Building notification email...');
              await activateBox('box-iterable-journey');
              completeStep(8);
              activateConnector('conn-8');
            }
          },
          // Step 9: Sales Alert
          {
            fn: async () => {
              activateStep(9);
              setAnnotation(`<strong>Step 9: Sales Alert</strong><br>Sales team receives email alert with duplicate information. They can review and merge records if needed.`);
              log('SALES', 'Email sent: "Potential Duplicate Lead Detected"');
              log('SALES', `New: ${document.getElementById('name').value} <${document.getElementById('email').value}>`);
              if (s.emailMatch || s.phoneMatch) {
                log('SALES', 'Matches existing NS record');
              }
              if (s.deviceMatch) {
                log('SALES', 'Same device as previous submission');
              }
              await activateBox('box-sales');
              completeStep(9);
            }
          }
        );
      }

      // Final step
      stepQueue.push({
        fn: async () => {
          log('SITE', '‚úì Flow complete');
          setAnnotation(hasDuplicate
            ? `<strong>Flow Complete</strong><br>Lead created and sales team notified of potential duplicate. They can review and merge records in NetSuite.`
            : `<strong>Flow Complete</strong><br>New lead successfully created and synced across all platforms. Ready for personalization.`
          );
          document.getElementById('runBtn').disabled = false;
        }
      });

      // Execute based on mode
      if (mode === 'auto') {
        for (const step of stepQueue) {
          await step.fn();
          await new Promise(r => setTimeout(r, 400));
        }
        stepQueue = [];
      } else {
        document.getElementById('nextBtn').disabled = false;
        const firstStep = stepQueue.shift();
        executeStep(firstStep);
      }
    }

    function resetDemo() {
      stepQueue = [];
      document.querySelectorAll('.step-num').forEach(el => el.classList.remove('active', 'done', 'warning'));
      document.querySelectorAll('.step-box, .branch-box').forEach(el => el.classList.remove('active', 'done', 'warning'));
      document.querySelectorAll('.flow-connector').forEach(el => el.classList.remove('active', 'done'));
      document.getElementById('dup-section').classList.remove('show');

      document.getElementById('displayUid').textContent = '‚Äî';
      document.getElementById('displayUid').classList.remove('set');
      document.getElementById('displayNsId').textContent = '‚Äî';
      document.getElementById('displayNsId').classList.remove('set');
      document.getElementById('displayAmpId').textContent = '‚Äî';
      document.getElementById('displayAmpId').classList.remove('set');

      document.getElementById('runBtn').disabled = false;
      document.getElementById('nextBtn').disabled = true;

      clearLog();
      setAnnotation('Select a scenario and click "Run Flow" to see the identity resolution process in action.', false);
      log('SITE', 'Demo reset');
    }

    // Keyboard support
    document.addEventListener('keydown', e => {
      if (e.code === 'Space' && mode === 'manual' && !document.getElementById('nextBtn').disabled) {
        e.preventDefault();
        nextStep();
      }
      if (e.code === 'KeyR' && !e.metaKey && !e.ctrlKey) {
        resetDemo();
      }
    });

    window.onload = () => {
      log('SITE', 'System ready');
      setAnnotation('Select a scenario and click "Run Flow" to see the identity resolution process in action.', false);
    };
  </script>
</body>
</html>
