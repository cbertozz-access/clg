<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Identity Resolution Architecture POC</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #000;
      color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.4;
      padding: 15px;
      min-height: 100vh;
    }
    .container { max-width: 1600px; margin: 0 auto; }
    header {
      border: 1px solid #fff;
      padding: 12px 20px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { font-size: 16px; font-weight: normal; }
    .brand-select {
      background: #000;
      color: #fff;
      border: 1px solid #fff;
      padding: 5px 10px;
      font-family: inherit;
      font-size: 13px;
    }
    .main-grid {
      display: grid;
      grid-template-columns: 280px 1fr 300px;
      gap: 15px;
    }
    .panel {
      border: 1px solid #fff;
      padding: 12px;
    }
    .panel-title {
      font-size: 11px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #333;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .form-group { margin-bottom: 10px; }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-size: 11px;
      color: #888;
    }
    .form-group input, .form-group select {
      width: 100%;
      background: #000;
      border: 1px solid #fff;
      color: #fff;
      padding: 6px 8px;
      font-family: inherit;
      font-size: 12px;
    }
    .btn {
      background: #fff;
      color: #000;
      border: none;
      padding: 10px 15px;
      font-family: inherit;
      font-size: 13px;
      cursor: pointer;
      width: 100%;
    }
    .btn:hover { background: #ccc; }
    .btn:disabled { background: #333; color: #666; }
    .btn-sm {
      padding: 6px 10px;
      font-size: 11px;
      margin-top: 8px;
    }
    
    /* Architecture Diagram */
    .arch-diagram {
      display: grid;
      grid-template-rows: auto auto auto auto;
      gap: 10px;
      padding: 15px;
      min-height: 500px;
    }
    .arch-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    .arch-node {
      border: 1px solid #333;
      padding: 10px 15px;
      text-align: center;
      min-width: 120px;
      font-size: 11px;
      position: relative;
      transition: all 0.3s;
    }
    .arch-node.active {
      border-color: #fff;
      background: #fff;
      color: #000;
    }
    .arch-node.complete {
      border-color: #fff;
    }
    .arch-node.waiting {
      border-color: #444;
      color: #666;
    }
    .arch-node-label {
      font-size: 9px;
      color: #666;
      margin-bottom: 4px;
      text-transform: uppercase;
    }
    .arch-node.active .arch-node-label { color: #666; }
    .arch-node-title { font-weight: normal; }
    .arch-connector {
      color: #333;
      font-size: 16px;
    }
    .arch-connector.active { color: #fff; }
    .arch-connector.down { transform: rotate(90deg); }
    
    .arch-section {
      border: 1px dashed #333;
      padding: 15px;
      margin: 5px 0;
    }
    .arch-section-label {
      font-size: 9px;
      color: #444;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    /* Data boxes */
    .data-box {
      background: #111;
      border: 1px solid #333;
      padding: 10px;
      margin-top: 10px;
      font-size: 10px;
      max-height: 150px;
      overflow-y: auto;
    }
    .data-box.highlight { border-color: #fff; }
    .data-box pre {
      white-space: pre-wrap;
      word-break: break-all;
    }
    .data-label {
      font-size: 9px;
      color: #666;
      margin-bottom: 5px;
      text-transform: uppercase;
    }
    
    /* Event log */
    .event-log {
      height: 200px;
      overflow-y: auto;
      background: #111;
      padding: 8px;
      font-size: 10px;
    }
    .log-entry {
      margin-bottom: 4px;
      display: flex;
      gap: 8px;
      padding: 3px 0;
      border-bottom: 1px solid #1a1a1a;
    }
    .log-time { color: #444; flex-shrink: 0; width: 60px; }
    .log-source {
      flex-shrink: 0;
      width: 70px;
      font-size: 9px;
      padding: 1px 4px;
      border: 1px solid #333;
      text-align: center;
    }
    .log-source.frontend { border-color: #666; }
    .log-source.firebase { border-color: #f90; color: #f90; }
    .log-source.netsuite { border-color: #0af; color: #0af; }
    .log-source.amplitude { border-color: #f0a; color: #f0a; }
    .log-source.iterable { border-color: #0fa; color: #0fa; }
    .log-source.datalayer { border-color: #ff0; color: #ff0; }
    .log-message { color: #fff; }
    
    /* Status indicators */
    .status-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #222;
      font-size: 11px;
    }
    .status-label { color: #888; }
    .status-value { color: #fff; }
    .status-value.pending { color: #444; }
    .status-value.active { color: #fff; animation: pulse 1s infinite; }
    .status-value.done { color: #fff; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    .tag {
      display: inline-block;
      border: 1px solid #fff;
      padding: 2px 6px;
      font-size: 9px;
      margin: 2px;
    }
    .tag.new { background: #fff; color: #000; }
    .tag.enriched { border-color: #f0a; color: #f0a; }
    
    .webhook-indicator {
      background: #111;
      border: 1px solid #333;
      padding: 8px;
      margin-top: 10px;
      font-size: 10px;
    }
    .webhook-indicator.received {
      border-color: #fff;
      animation: flash 0.5s;
    }
    @keyframes flash {
      0% { background: #fff; color: #000; }
      100% { background: #111; color: #fff; }
    }
    
    .datalayer-state {
      background: #111;
      border: 1px solid #ff0;
      padding: 10px;
      margin-top: 10px;
      font-size: 10px;
    }
    .datalayer-state h4 {
      color: #ff0;
      font-size: 10px;
      margin-bottom: 8px;
      font-weight: normal;
    }
    
    .clear-btn {
      background: transparent;
      color: #666;
      border: 1px solid #333;
      padding: 4px 8px;
      font-size: 10px;
      cursor: pointer;
      float: right;
    }
    .clear-btn:hover { border-color: #fff; color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>■ IDENTITY RESOLUTION ARCHITECTURE</h1>
      <div style="display: flex; gap: 10px; align-items: center;">
        <span style="color: #888; font-size: 11px;">Brand:</span>
        <select class="brand-select" id="brandSelect">
          <option value="clg">CLG</option>
          <option value="access-hire">Access Hire</option>
          <option value="access-express">Access Express</option>
        </select>
      </div>
    </header>
    
    <div class="main-grid">
      <!-- Left: Form & Status -->
      <div class="left-col">
        <div class="panel">
          <div class="panel-title">■ Test Lead</div>
          <div class="form-group">
            <label>Scenario</label>
            <select id="scenarioSelect" onchange="loadScenario()">
              <option value="returning">↻ Returning User</option>
              <option value="new">+ New User</option>
              <option value="duplicate">⚠ Duplicate Submit</option>
            </select>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="testEmail">
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="testPhone">
          </div>
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="testName">
          </div>
          <button class="btn" id="submitBtn" onclick="submitLead()">SUBMIT LEAD</button>
          <button class="btn btn-sm" onclick="resetDemo()" style="background: transparent; color: #fff; border: 1px solid #444;">RESET</button>
        </div>
        
        <div class="panel" style="margin-top: 15px;">
          <div class="panel-title">■ System Status</div>
          <div class="status-row">
            <span class="status-label">Firebase</span>
            <span class="status-value" id="statusFirebase">Ready</span>
          </div>
          <div class="status-row">
            <span class="status-label">NetSuite</span>
            <span class="status-value" id="statusNetsuite">Waiting</span>
          </div>
          <div class="status-row">
            <span class="status-label">Amplitude</span>
            <span class="status-value" id="statusAmplitude">Waiting</span>
          </div>
          <div class="status-row">
            <span class="status-label">Iterable</span>
            <span class="status-value" id="statusIterable">Waiting</span>
          </div>
          <div class="status-row">
            <span class="status-label">DataLayer</span>
            <span class="status-value" id="statusDatalayer">Ready</span>
          </div>
        </div>
        
        <div class="panel" style="margin-top: 15px;">
          <div class="panel-title">■ Webhooks Received</div>
          <div class="webhook-indicator" id="webhookNS">
            <strong>NetSuite:</strong> <span id="webhookNSStatus">Waiting...</span>
          </div>
          <div class="webhook-indicator" id="webhookAmp">
            <strong>Amplitude:</strong> <span id="webhookAmpStatus">Waiting...</span>
          </div>
          <div class="webhook-indicator" id="webhookIter">
            <strong>Iterable:</strong> <span id="webhookIterStatus">Waiting...</span>
          </div>
        </div>
      </div>
      
      <!-- Center: Architecture Diagram -->
      <div class="center-col">
        <div class="panel" style="height: 100%;">
          <div class="panel-title">■ Data Flow Architecture</div>
          
          <div class="arch-diagram">
            <!-- Row 1: Frontend -->
            <div class="arch-section">
              <div class="arch-section-label">Frontend (Browser)</div>
              <div class="arch-row">
                <div class="arch-node" id="node-form">
                  <div class="arch-node-label">User Action</div>
                  <div class="arch-node-title">FORM<br>SUBMIT</div>
                </div>
                <span class="arch-connector" id="conn-1">→</span>
                <div class="arch-node" id="node-datalayer">
                  <div class="arch-node-label">GTM</div>
                  <div class="arch-node-title">DATALAYER<br>PUSH</div>
                </div>
                <span class="arch-connector" id="conn-2">→</span>
                <div class="arch-node" id="node-visitor">
                  <div class="arch-node-label">SDK</div>
                  <div class="arch-node-title">VISITOR<br>IDENTIFY</div>
                </div>
              </div>
            </div>
            
            <div class="arch-row">
              <span class="arch-connector down" id="conn-3">→</span>
            </div>
            
            <!-- Row 2: Firebase -->
            <div class="arch-section">
              <div class="arch-section-label">Firebase / GCP</div>
              <div class="arch-row">
                <div class="arch-node" id="node-firebase">
                  <div class="arch-node-label">Firestore</div>
                  <div class="arch-node-title">DEDUPE<br>LOOKUP</div>
                </div>
                <span class="arch-connector" id="conn-4">→</span>
                <div class="arch-node" id="node-master">
                  <div class="arch-node-label">Identity</div>
                  <div class="arch-node-title">MASTER<br>RECORD</div>
                </div>
                <span class="arch-connector" id="conn-5">→</span>
                <div class="arch-node" id="node-uid">
                  <div class="arch-node-label">Generate</div>
                  <div class="arch-node-title">UNIQUE<br>UID</div>
                </div>
              </div>
            </div>
            
            <div class="arch-row">
              <span class="arch-connector down" id="conn-6">→</span>
            </div>
            
            <!-- Row 3: External Systems -->
            <div class="arch-section">
              <div class="arch-section-label">External Systems</div>
              <div class="arch-row">
                <div class="arch-node" id="node-netsuite">
                  <div class="arch-node-label">CRM</div>
                  <div class="arch-node-title">NETSUITE<br>LEAD</div>
                </div>
                <span class="arch-connector" id="conn-7">→</span>
                <div class="arch-node" id="node-amplitude">
                  <div class="arch-node-label">CDP</div>
                  <div class="arch-node-title">AMPLITUDE<br>ENRICH</div>
                </div>
                <span class="arch-connector" id="conn-8">→</span>
                <div class="arch-node" id="node-iterable">
                  <div class="arch-node-label">Marketing</div>
                  <div class="arch-node-title">ITERABLE<br>RECORD</div>
                </div>
              </div>
            </div>
            
            <div class="arch-row">
              <span class="arch-connector down" id="conn-9">→</span>
              <span style="color: #666; font-size: 10px; margin: 0 20px;">WEBHOOKS BACK</span>
              <span class="arch-connector down" id="conn-10">→</span>
            </div>
            
            <!-- Row 4: Webhook Returns -->
            <div class="arch-section">
              <div class="arch-section-label">Webhook Response → Frontend Update</div>
              <div class="arch-row">
                <div class="arch-node" id="node-ns-webhook">
                  <div class="arch-node-label">Webhook</div>
                  <div class="arch-node-title">NS LEAD<br>CREATED</div>
                </div>
                <span class="arch-connector" id="conn-11">→</span>
                <div class="arch-node" id="node-amp-webhook">
                  <div class="arch-node-label">Webhook</div>
                  <div class="arch-node-title">AMPLITUDE<br>ENRICHED</div>
                </div>
                <span class="arch-connector" id="conn-12">→</span>
                <div class="arch-node" id="node-datalayer-update">
                  <div class="arch-node-label">Update</div>
                  <div class="arch-node-title">DATALAYER<br>ENRICH</div>
                </div>
                <span class="arch-connector" id="conn-13">→</span>
                <div class="arch-node" id="node-personalize">
                  <div class="arch-node-label">Action</div>
                  <div class="arch-node-title">PERSONALIZE<br>SITE</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Right: DataLayer & Logs -->
      <div class="right-col">
        <div class="panel">
          <div class="panel-title">■ DataLayer State</div>
          <div class="datalayer-state">
            <h4>window.dataLayer</h4>
            <pre id="datalayerContent">// Empty - submit a lead</pre>
          </div>
          <div class="data-box" id="enrichedData" style="display: none;">
            <div class="data-label">Amplitude Enrichment</div>
            <pre id="enrichedContent"></pre>
          </div>
        </div>
        
        <div class="panel" style="margin-top: 15px;">
          <div class="panel-title">
            ■ Event Stream
            <button class="clear-btn" onclick="clearLog()">CLEAR</button>
          </div>
          <div class="event-log" id="eventLog"></div>
        </div>
        
        <div class="panel" style="margin-top: 15px;">
          <div class="panel-title">■ Payloads</div>
          <div class="data-label">To NetSuite</div>
          <div class="data-box">
            <pre id="nsPayload">// Waiting...</pre>
          </div>
          <div class="data-label" style="margin-top: 10px;">To Amplitude</div>
          <div class="data-box">
            <pre id="ampPayload">// Waiting...</pre>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Database simulation
    const db = {
      leads: {
        'LEAD-ABC123': {
          masterLeadId: 'LEAD-ABC123',
          email: 'john@example.com',
          phone: '0412345678',
          name: 'John Smith',
          siteIds: { 'access-hire': ['UID-001'], 'access-express': ['UID-002'] },
          totalSubmissions: 2
        }
      }
    };
    
    const scenarios = {
      'returning': { email: 'john@example.com', phone: '0412345678', name: 'John Smith' },
      'new': { email: 'newuser@test.com', phone: '0400111222', name: 'New User' },
      'duplicate': { email: 'john@example.com', phone: '0412345678', name: 'John Smith' }
    };
    
    let sessionSubmissions = [];
    let currentDataLayer = [];
    
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16).toUpperCase();
      });
    }
    
    function generateId(prefix) {
      return prefix + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();
    }
    
    function log(source, message) {
      const el = document.getElementById('eventLog');
      const time = new Date().toLocaleTimeString('en-AU', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `
        <span class="log-time">${time}</span>
        <span class="log-source ${source.toLowerCase()}">${source}</span>
        <span class="log-message">${message}</span>
      `;
      el.insertBefore(entry, el.firstChild);
    }
    
    function clearLog() {
      document.getElementById('eventLog').innerHTML = '';
    }
    
    function setStatus(system, status) {
      const el = document.getElementById('status' + system);
      el.textContent = status;
      el.className = 'status-value ' + (status === 'Waiting' ? 'pending' : status === 'Processing...' ? 'active' : 'done');
    }
    
    function activateNode(id) {
      document.getElementById(id).classList.add('active');
      return new Promise(r => setTimeout(() => {
        document.getElementById(id).classList.remove('active');
        document.getElementById(id).classList.add('complete');
        r();
      }, 400));
    }
    
    function activateConnector(id) {
      document.getElementById(id).classList.add('active');
    }
    
    function loadScenario() {
      const s = scenarios[document.getElementById('scenarioSelect').value];
      document.getElementById('testEmail').value = s.email;
      document.getElementById('testPhone').value = s.phone;
      document.getElementById('testName').value = s.name;
    }
    
    function updateDataLayer(event) {
      currentDataLayer.push(event);
      document.getElementById('datalayerContent').textContent = JSON.stringify(currentDataLayer, null, 2);
    }
    
    async function submitLead() {
      const email = document.getElementById('testEmail').value;
      const phone = document.getElementById('testPhone').value;
      const name = document.getElementById('testName').value;
      const brand = document.getElementById('brandSelect').value;
      
      if (!email && !phone) { alert('Enter email or phone'); return; }
      
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = 'PROCESSING...';
      
      // Reset nodes
      document.querySelectorAll('.arch-node').forEach(n => n.classList.remove('active', 'complete'));
      document.querySelectorAll('.arch-connector').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.webhook-indicator').forEach(w => w.classList.remove('received'));
      document.getElementById('enrichedData').style.display = 'none';
      
      // 1. Form Submit
      log('FRONTEND', 'Form submitted');
      await activateNode('node-form');
      activateConnector('conn-1');
      
      // 2. Initial DataLayer Push
      const initialEvent = {
        event: 'form_submit',
        form_name: 'lead_enquiry',
        brand: brand,
        timestamp: new Date().toISOString()
      };
      updateDataLayer(initialEvent);
      log('DATALAYER', 'Push: form_submit');
      setStatus('Datalayer', 'Updated');
      await activateNode('node-datalayer');
      activateConnector('conn-2');
      
      // 3. Visitor Identify
      log('FRONTEND', 'Calling visitor SDK');
      await activateNode('node-visitor');
      activateConnector('conn-3');
      
      // 4. Firebase Dedupe
      setStatus('Firebase', 'Processing...');
      log('FIREBASE', 'Querying for email/phone match...');
      await activateNode('node-firebase');
      activateConnector('conn-4');
      
      // Check for match
      let masterLead = null;
      let isReturning = false;
      for (const id in db.leads) {
        if (db.leads[id].email === email || db.leads[id].phone === phone) {
          masterLead = db.leads[id];
          isReturning = true;
          break;
        }
      }
      
      // Check session duplicate
      const isDuplicate = sessionSubmissions.some(s => s.email === email || s.phone === phone);
      
      let masterId;
      if (masterLead) {
        masterId = masterLead.masterLeadId;
        log('FIREBASE', `MATCH FOUND: ${masterId}`);
        if (isDuplicate) log('FIREBASE', '⚠ Duplicate in session');
      } else {
        masterId = generateId('LEAD');
        log('FIREBASE', `NEW LEAD: ${masterId}`);
        db.leads[masterId] = { masterLeadId: masterId, email, phone, name, siteIds: {}, totalSubmissions: 0 };
      }
      
      setStatus('Firebase', 'Complete');
      await activateNode('node-master');
      activateConnector('conn-5');
      
      // 5. Generate Unique UID
      const uid = generateUUID();
      log('FIREBASE', `Generated UID: ${uid.substring(0,8)}...`);
      await activateNode('node-uid');
      activateConnector('conn-6');
      
      // Update DB
      if (!db.leads[masterId].siteIds[brand]) db.leads[masterId].siteIds[brand] = [];
      db.leads[masterId].siteIds[brand].push(uid);
      db.leads[masterId].totalSubmissions++;
      
      // Track session
      sessionSubmissions.push({ uid, masterId, email, phone, brand });
      
      // 6. Send to NetSuite
      setStatus('Netsuite', 'Processing...');
      const nsPayload = {
        contactRequestId: uid,
        masterLeadId: masterId,
        email, phone, name, brand,
        isReturning, isDuplicate
      };
      document.getElementById('nsPayload').textContent = JSON.stringify(nsPayload, null, 2);
      log('NETSUITE', 'Sending lead...');
      await activateNode('node-netsuite');
      activateConnector('conn-7');
      
      // 7. Send to Amplitude
      setStatus('Amplitude', 'Processing...');
      const ampPayload = {
        event_type: 'lead_captured',
        user_id: masterId,
        device_id: generateId('DEV'),
        event_properties: { brand, form: 'enquiry', uid },
        user_properties: { email, phone, name }
      };
      document.getElementById('ampPayload').textContent = JSON.stringify(ampPayload, null, 2);
      log('AMPLITUDE', 'Sending event...');
      await activateNode('node-amplitude');
      activateConnector('conn-8');
      
      // 8. Iterable (from NetSuite)
      setStatus('Iterable', 'Processing...');
      log('ITERABLE', 'Record created from NetSuite');
      await activateNode('node-iterable');
      activateConnector('conn-9');
      activateConnector('conn-10');
      
      // 9. Webhooks return
      await new Promise(r => setTimeout(r, 500));
      
      // NetSuite webhook
      setStatus('Netsuite', 'Lead Created');
      document.getElementById('webhookNS').classList.add('received');
      document.getElementById('webhookNSStatus').textContent = `Lead ID: NS-${Math.random().toString(36).substr(2,6).toUpperCase()}`;
      log('NETSUITE', '← Webhook: Lead created');
      await activateNode('node-ns-webhook');
      activateConnector('conn-11');
      
      // Amplitude webhook with enriched data
      await new Promise(r => setTimeout(r, 400));
      setStatus('Amplitude', 'Enriched');
      const enrichedData = {
        user_id: masterId,
        computed_properties: {
          lifetime_value_score: Math.floor(Math.random() * 100),
          engagement_level: ['high', 'medium', 'low'][Math.floor(Math.random() * 3)],
          predicted_conversion: (Math.random() * 0.8 + 0.1).toFixed(2),
          industry_segment: 'Construction',
          company_size: 'SMB',
          behavioral_cohort: 'active_researcher'
        },
        audiences: ['high_intent', 'equipment_rental', 'returning_visitor'],
        last_30_days: {
          sessions: Math.floor(Math.random() * 10) + 1,
          pages_viewed: Math.floor(Math.random() * 50) + 5,
          products_viewed: Math.floor(Math.random() * 20) + 1
        }
      };
      document.getElementById('webhookAmp').classList.add('received');
      document.getElementById('webhookAmpStatus').textContent = 'Enrichment received';
      document.getElementById('enrichedData').style.display = 'block';
      document.getElementById('enrichedContent').textContent = JSON.stringify(enrichedData, null, 2);
      log('AMPLITUDE', '← Webhook: Enriched data');
      await activateNode('node-amp-webhook');
      activateConnector('conn-12');
      
      // Iterable confirmation
      setStatus('Iterable', 'Subscribed');
      document.getElementById('webhookIter').classList.add('received');
      document.getElementById('webhookIterStatus').textContent = 'Contact synced';
      log('ITERABLE', '← Confirmed: Contact in list');
      
      // 10. Update DataLayer with enrichment
      const enrichedEvent = {
        event: 'lead_enriched',
        master_lead_id: masterId,
        submission_uid: uid,
        is_returning: isReturning,
        is_duplicate: isDuplicate,
        amplitude_ltv_score: enrichedData.computed_properties.lifetime_value_score,
        amplitude_engagement: enrichedData.computed_properties.engagement_level,
        amplitude_conversion_prob: enrichedData.computed_properties.predicted_conversion,
        amplitude_audiences: enrichedData.audiences,
        netsuite_lead_created: true,
        iterable_subscribed: true,
        personalization_ready: true
      };
      updateDataLayer(enrichedEvent);
      setStatus('Datalayer', 'Enriched');
      log('DATALAYER', 'Push: lead_enriched (with Amplitude data)');
      await activateNode('node-datalayer-update');
      activateConnector('conn-13');
      
      // 11. Personalization ready
      log('FRONTEND', 'Personalization data available');
      await activateNode('node-personalize');
      
      log('FRONTEND', '✓ Complete - ready for personalization');
      
      btn.disabled = false;
      btn.textContent = 'SUBMIT LEAD';
    }
    
    function resetDemo() {
      sessionSubmissions = [];
      currentDataLayer = [];
      
      // Reset DB
      db.leads = {
        'LEAD-ABC123': {
          masterLeadId: 'LEAD-ABC123',
          email: 'john@example.com',
          phone: '0412345678',
          name: 'John Smith',
          siteIds: { 'access-hire': ['UID-001'], 'access-express': ['UID-002'] },
          totalSubmissions: 2
        }
      };
      
      document.querySelectorAll('.arch-node').forEach(n => n.classList.remove('active', 'complete'));
      document.querySelectorAll('.arch-connector').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.webhook-indicator').forEach(w => w.classList.remove('received'));
      
      ['Firebase', 'Netsuite', 'Amplitude', 'Iterable', 'Datalayer'].forEach(s => {
        setStatus(s, s === 'Firebase' || s === 'Datalayer' ? 'Ready' : 'Waiting');
      });
      
      document.getElementById('webhookNSStatus').textContent = 'Waiting...';
      document.getElementById('webhookAmpStatus').textContent = 'Waiting...';
      document.getElementById('webhookIterStatus').textContent = 'Waiting...';
      
      document.getElementById('datalayerContent').textContent = '// Empty - submit a lead';
      document.getElementById('enrichedData').style.display = 'none';
      document.getElementById('nsPayload').textContent = '// Waiting...';
      document.getElementById('ampPayload').textContent = '// Waiting...';
      
      clearLog();
      log('FRONTEND', 'Demo reset');
    }
    
    window.onload = () => {
      loadScenario();
      log('FRONTEND', 'System ready');
    };
  </script>
</body>
</html>
