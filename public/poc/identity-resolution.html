<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CLG Identity Resolution - Lead Flow</title>
  <!-- Markup.io feedback integration -->
  <script src="https://cdn.markup.io/embed.js" data-api-key="sk_e5c8fbde-1834-4ce2-b8dd-2e4099fc7103_a2f4f0dc51f6700d105409d08c811f87363570ebd6f582914ff2aa120726259fdc0f9cf29b932501057488ecbe0942e9542ed1e67796bd7f1b6cffea50dfde84"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0a0a0a;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 13px;
      height: 100vh;
      overflow: hidden;
    }

    .app {
      display: grid;
      grid-template-columns: 260px 1fr 240px;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      background: #0d0d0d;
      border-right: 1px solid #1a1a1a;
      padding: 16px;
      overflow-y: auto;
    }

    .sidebar h1 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .sidebar .subtitle {
      font-size: 11px;
      color: #666;
      margin-bottom: 20px;
    }

    .panel-title {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #555;
      margin-bottom: 10px;
    }

    /* Presets - single column for longer labels */
    .presets {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 20px;
    }
    .preset {
      background: #111;
      border: 1px solid #222;
      border-radius: 6px;
      padding: 10px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s;
    }
    .preset:hover { border-color: #444; }
    .preset.active { border-color: #fff; background: #1a1a1a; }
    .preset-icon { font-size: 16px; flex-shrink: 0; }
    .preset-text { flex: 1; }
    .preset-label { font-size: 11px; font-weight: 600; color: #ccc; }
    .preset-desc { font-size: 9px; color: #666; margin-top: 2px; }

    /* Form */
    .form-section { margin-bottom: 16px; }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }
    .form-group { }
    .form-group.full { grid-column: span 2; }
    .form-group label {
      display: block;
      font-size: 9px;
      color: #555;
      margin-bottom: 3px;
      text-transform: uppercase;
    }
    .form-group input, .form-group select {
      width: 100%;
      background: #0a0a0a;
      border: 1px solid #222;
      border-radius: 4px;
      color: #fff;
      padding: 7px 9px;
      font-size: 11px;
    }
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #444;
    }

    /* Playback Controls */
    .playback {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .playback button {
      flex: 1;
      padding: 8px;
      border: 1px solid #222;
      border-radius: 4px;
      background: #111;
      color: #888;
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .playback button:hover { border-color: #444; color: #fff; }
    .playback button.active { background: #fff; color: #000; border-color: #fff; }

    .btn {
      width: 100%;
      padding: 11px;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: #fff; color: #000; }
    .btn-primary:hover { background: #ddd; }
    .btn-primary:disabled { background: #333; color: #666; cursor: not-allowed; }
    .btn-secondary { background: transparent; color: #666; border: 1px solid #333; margin-top: 6px; }
    .btn-secondary:hover { border-color: #666; color: #999; }

    /* IDs Panel */
    .ids-panel { margin-top: 16px; }
    .id-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #1a1a1a;
      font-size: 10px;
    }
    .id-row:last-child { border-bottom: none; }
    .id-label { color: #555; text-transform: uppercase; }
    .id-value { font-family: monospace; color: #444; }
    .id-value.set { color: #0f0; }

    /* Main Flow Area */
    .main-area {
      display: flex;
      flex-direction: column;
      padding: 16px 20px;
      overflow: hidden;
    }

    .flow-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 0;
    }

    .flow-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    /* Flow Steps */
    .flow-step {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .step-num {
      width: 26px;
      height: 26px;
      border: 2px solid #333;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: #444;
      flex-shrink: 0;
      transition: all 0.3s;
    }
    .step-num.active {
      border-color: #fff;
      background: #fff;
      color: #000;
      transform: scale(1.15);
    }
    .step-num.done { border-color: #0f0; color: #0f0; }
    .step-num.warning { border-color: #f90; color: #f90; }

    .step-box {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #111;
      border: 2px solid #222;
      border-radius: 6px;
      padding: 10px 14px;
      min-width: 300px;
      transition: all 0.3s;
    }
    .step-box.active {
      border-color: #fff;
      background: #1a1a1a;
      box-shadow: 0 0 20px rgba(255,255,255,0.1);
      transform: scale(1.02);
    }
    .step-box.done { border-color: #333; opacity: 0.7; }
    .step-box.warning { border-color: #f90; background: #1a1500; }

    .step-icon {
      width: 32px;
      height: 32px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }
    .step-icon.user { background: #1a1a2e; }
    .step-icon.firebase { background: #2e2a1a; }
    .step-icon.site { background: #1a1a2e; }
    .step-icon.adapter { background: #1a2e1a; }
    .step-icon.netsuite { background: #2e1a1a; }
    .step-icon.iterable { background: #2e1a2e; }
    .step-icon.amplitude { background: #2e2e1a; }
    .step-icon.sales { background: #2e2a1a; }

    .step-content { flex: 1; min-width: 0; }
    .step-name { font-weight: 600; font-size: 12px; margin-bottom: 1px; }
    .step-desc { font-size: 10px; color: #666; }

    .step-badge {
      font-size: 8px;
      padding: 2px 5px;
      border-radius: 3px;
      text-transform: uppercase;
      font-weight: 600;
      flex-shrink: 0;
    }
    .step-badge.datalayer { background: #0ff2; color: #0ff; }
    .step-badge.sdk { background: #ff02; color: #ff0; }

    .flow-connector {
      width: 2px;
      height: 10px;
      background: #222;
      margin-left: 12px;
    }
    .flow-connector.active { background: #fff; }
    .flow-connector.done { background: #333; }

    /* Branch */
    .flow-branch {
      display: flex;
      gap: 16px;
      margin: 6px 0;
    }
    .branch-box {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #111;
      border: 2px solid #222;
      border-radius: 6px;
      padding: 8px 12px;
      transition: all 0.3s;
    }
    .branch-box.active { border-color: #fff; background: #1a1a1a; }
    .branch-box.done { border-color: #333; opacity: 0.7; }
    .branch-icon { font-size: 12px; }
    .branch-name { font-weight: 600; font-size: 11px; }

    /* Duplicate Alert */
    .dup-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed #f90;
      display: none;
    }
    .dup-section.show { display: block; }
    .dup-label {
      text-align: center;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #f90;
      margin-bottom: 10px;
    }

    /* Annotation */
    .annotation {
      background: #111;
      border: 1px solid #222;
      border-radius: 8px;
      padding: 14px 18px;
      margin-top: 12px;
      min-height: 90px;
    }
    .annotation-title {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #555;
      margin-bottom: 8px;
    }
    .annotation-text {
      font-size: 15px;
      color: #888;
      line-height: 1.5;
    }
    .annotation-text.active { color: #fff; }
    .annotation-text code {
      font-family: monospace;
      font-size: 12px;
      background: #1a1a1a;
      padding: 2px 5px;
      border-radius: 3px;
      color: #0ff;
    }

    /* Logs Panel */
    .logs-panel {
      background: #0d0d0d;
      border-left: 1px solid #1a1a1a;
      display: flex;
      flex-direction: column;
    }
    .logs-header {
      padding: 12px 14px;
      border-bottom: 1px solid #1a1a1a;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logs-header h3 {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #555;
    }
    .clear-btn {
      background: transparent;
      border: 1px solid #222;
      color: #555;
      padding: 3px 7px;
      border-radius: 3px;
      font-size: 9px;
      cursor: pointer;
    }
    .clear-btn:hover { border-color: #444; color: #888; }

    .log-container {
      flex: 1;
      overflow-y: auto;
      font-family: monospace;
      font-size: 9px;
    }
    .log-entry {
      padding: 5px 10px;
      border-bottom: 1px solid #111;
      display: flex;
      gap: 6px;
    }
    .log-time { color: #333; width: 50px; flex-shrink: 0; }
    .log-source {
      width: 50px;
      flex-shrink: 0;
      padding: 1px 3px;
      border-radius: 2px;
      text-align: center;
      font-size: 7px;
      font-weight: 600;
    }
    .log-source.user { background: #1a1a2e; color: #88f; }
    .log-source.firebase { background: #2e2a1a; color: #fa0; }
    .log-source.site { background: #1a1a2e; color: #88f; }
    .log-source.datalayer { background: #1a2e2e; color: #0ff; }
    .log-source.adapter { background: #1a2e1a; color: #8f8; }
    .log-source.netsuite { background: #2e1a1a; color: #f88; }
    .log-source.iterable { background: #2e1a2e; color: #f8f; }
    .log-source.amplitude { background: #2e2e1a; color: #ff8; }
    .log-source.sales { background: #2e2a1a; color: #fa8; }
    .log-message { color: #666; flex: 1; }
  </style>
</head>
<body>
  <div class="app">
    <!-- Left Sidebar -->
    <div class="sidebar">
      <h1>Identity Resolution</h1>
      <p class="subtitle">CLG Lead Flow Demo</p>

      <div class="panel-title">Scenario</div>
      <div class="presets">
        <div class="preset active" data-scenario="new_first" onclick="selectPreset(this)">
          <div class="preset-icon">üë§</div>
          <div class="preset-text">
            <div class="preset-label">New User - First Visit</div>
            <div class="preset-desc">Never visited any brand before</div>
          </div>
        </div>
        <div class="preset" data-scenario="new_cross" onclick="selectPreset(this)">
          <div class="preset-icon">üîÄ</div>
          <div class="preset-text">
            <div class="preset-label">New to Brand A, Visited B</div>
            <div class="preset-desc">Same device, different brand site</div>
          </div>
        </div>
        <div class="preset" data-scenario="return_same" onclick="selectPreset(this)">
          <div class="preset-icon">üîÑ</div>
          <div class="preset-text">
            <div class="preset-label">Returning - Same Device</div>
            <div class="preset-desc">Known user, same device as before</div>
          </div>
        </div>
        <div class="preset" data-scenario="return_new_device" onclick="selectPreset(this)">
          <div class="preset-icon">üì±</div>
          <div class="preset-text">
            <div class="preset-label">Returning - New Device</div>
            <div class="preset-desc">Known email/phone, different device</div>
          </div>
        </div>
        <div class="preset" data-scenario="return_cross_device" onclick="selectPreset(this)">
          <div class="preset-icon">üíª</div>
          <div class="preset-text">
            <div class="preset-label">Cross-Device Both Brands</div>
            <div class="preset-desc">Different devices on Brand A and B</div>
          </div>
        </div>
        <div class="preset" data-scenario="ns_dupe" onclick="selectPreset(this)">
          <div class="preset-icon">‚ö†Ô∏è</div>
          <div class="preset-text">
            <div class="preset-label">NS Detects Duplicate</div>
            <div class="preset-desc">Appears new but NS finds match</div>
          </div>
        </div>
        <div class="preset" data-scenario="custom" onclick="selectPreset(this)">
          <div class="preset-icon">‚öôÔ∏è</div>
          <div class="preset-text">
            <div class="preset-label">Custom Scenario</div>
            <div class="preset-desc">Configure your own test case</div>
          </div>
        </div>
      </div>

      <div class="panel-title">Lead Details</div>
      <div class="form-section">
        <div class="form-row">
          <div class="form-group">
            <label>Current Brand</label>
            <select id="brand">
              <option value="access-hire">Access Hire</option>
              <option value="access-express">Access Express</option>
            </select>
          </div>
          <div class="form-group">
            <label>Visit Type</label>
            <select id="visitType">
              <option value="new">New Visit</option>
              <option value="return">Return Visit</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group full">
            <label>Email</label>
            <input type="email" id="email" value="newlead@company.com">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="phone" value="0400111222">
          </div>
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="name" value="New Lead">
          </div>
        </div>
      </div>

      <div class="panel-title">Playback</div>
      <div class="playback">
        <button id="autoBtn" class="active" onclick="setMode('auto')">Auto</button>
        <button id="manualBtn" onclick="setMode('manual')">Manual</button>
      </div>

      <button class="btn btn-primary" id="runBtn" onclick="runFlow()">Run Flow</button>
      <button class="btn btn-secondary" id="nextBtn" onclick="nextStep()" disabled style="display:none">Next Step ‚Üí</button>
      <button class="btn btn-secondary" onclick="resetDemo()">Reset</button>

      <div class="ids-panel">
        <div class="panel-title">Generated IDs</div>
        <div class="id-row">
          <span class="id-label">UID</span>
          <span class="id-value" id="displayUid">‚Äî</span>
        </div>
        <div class="id-row">
          <span class="id-label">NS Lead</span>
          <span class="id-value" id="displayNsId">‚Äî</span>
        </div>
        <div class="id-row">
          <span class="id-label">Amplitude</span>
          <span class="id-value" id="displayAmpId">‚Äî</span>
        </div>
      </div>
    </div>

    <!-- Main Flow Area -->
    <div class="main-area">
      <div class="flow-wrapper">
        <div class="flow-container">
          <!-- Step 1: User Arrives -->
          <div class="flow-step">
            <div class="step-num" id="num-1">1</div>
            <div class="step-box" id="box-arrive">
              <div class="step-icon user">üåê</div>
              <div class="step-content">
                <div class="step-name">User Arrives</div>
                <div class="step-desc">Page load on brand site</div>
              </div>
              <div class="step-badge datalayer">page_view</div>
            </div>
          </div>

          <div class="flow-connector" id="conn-1"></div>

          <!-- Step 2: Firebase SDK -->
          <div class="flow-step">
            <div class="step-num" id="num-2">2</div>
            <div class="step-box" id="box-firebase">
              <div class="step-icon firebase">üî•</div>
              <div class="step-content">
                <div class="step-name">Firebase SDK</div>
                <div class="step-desc">Generate/retrieve UID, check device</div>
              </div>
              <div class="step-badge sdk">SDK</div>
            </div>
          </div>

          <div class="flow-connector" id="conn-2"></div>

          <!-- Step 3: Form Submit -->
          <div class="flow-step">
            <div class="step-num" id="num-3">3</div>
            <div class="step-box" id="box-form">
              <div class="step-icon site">üìù</div>
              <div class="step-content">
                <div class="step-name">Form Submission</div>
                <div class="step-desc">Lead form with UID attached</div>
              </div>
              <div class="step-badge datalayer">form_submit</div>
            </div>
          </div>

          <div class="flow-connector" id="conn-3"></div>

          <!-- Step 4: NS Adapter -->
          <div class="flow-step">
            <div class="step-num" id="num-4">4</div>
            <div class="step-box" id="box-adapter">
              <div class="step-icon adapter">‚ö°</div>
              <div class="step-content">
                <div class="step-name">NS Adapter</div>
                <div class="step-desc">Check email/phone duplicates</div>
              </div>
            </div>
          </div>

          <div class="flow-connector" id="conn-4"></div>

          <!-- Step 5: NetSuite -->
          <div class="flow-step">
            <div class="step-num" id="num-5">5</div>
            <div class="step-box" id="box-netsuite">
              <div class="step-icon netsuite">üè¢</div>
              <div class="step-content">
                <div class="step-name">NetSuite</div>
                <div class="step-desc">Create lead record</div>
              </div>
              <div class="step-badge datalayer">lead_created</div>
            </div>
          </div>

          <div class="flow-connector" id="conn-5"></div>

          <!-- Step 6: Branch -->
          <div class="flow-branch" id="branch-sync">
            <div class="branch-box" id="box-iterable">
              <span class="branch-icon">üìß</span>
              <span class="branch-name">Iterable</span>
            </div>
            <div class="branch-box" id="box-amplitude">
              <span class="branch-icon">üìä</span>
              <span class="branch-name">Amplitude</span>
            </div>
          </div>

          <div class="flow-connector" id="conn-6"></div>

          <!-- Step 7: Enrichment -->
          <div class="flow-step">
            <div class="step-num" id="num-7">7</div>
            <div class="step-box" id="box-enrich">
              <div class="step-icon site">‚ú®</div>
              <div class="step-content">
                <div class="step-name">Enrichment Webhook</div>
                <div class="step-desc">Profile data returned to site</div>
              </div>
              <div class="step-badge datalayer">lead_enriched</div>
            </div>
          </div>

          <!-- Duplicate Alert Section -->
          <div class="dup-section" id="dup-section">
            <div class="dup-label">‚ö†Ô∏è Duplicate Alert Flow</div>

            <div class="flow-step">
              <div class="step-num" id="num-8">8</div>
              <div class="step-box" id="box-amp-event">
                <div class="step-icon amplitude">üìä</div>
                <div class="step-content">
                  <div class="step-name">Amplitude Event</div>
                  <div class="step-desc">duplicate_detected event</div>
                </div>
              </div>
            </div>

            <div class="flow-connector" id="conn-8"></div>

            <div class="flow-step">
              <div class="step-num" id="num-9">9</div>
              <div class="step-box" id="box-iterable-journey">
                <div class="step-icon iterable">üìß</div>
                <div class="step-content">
                  <div class="step-name">Iterable Journey</div>
                  <div class="step-desc">Sales notification workflow</div>
                </div>
              </div>
            </div>

            <div class="flow-connector" id="conn-9"></div>

            <div class="flow-step">
              <div class="step-num" id="num-10">10</div>
              <div class="step-box" id="box-sales">
                <div class="step-icon sales">üë§</div>
                <div class="step-content">
                  <div class="step-name">Sales Alert</div>
                  <div class="step-desc">Email with duplicate info</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Annotation -->
      <div class="annotation">
        <div class="annotation-title">What's Happening</div>
        <div class="annotation-text" id="annotation">
          Select a scenario and click "Run Flow" to see the identity resolution process in action.
        </div>
      </div>
    </div>

    <!-- Right Logs Panel -->
    <div class="logs-panel">
      <div class="logs-header">
        <h3>Event Log</h3>
        <button class="clear-btn" onclick="clearLog()">Clear</button>
      </div>
      <div class="log-container" id="eventLog"></div>
    </div>
  </div>

  <script>
    const scenarios = {
      'new_first': {
        email: 'brand.new@company.com', phone: '0400111222', name: 'Brand New Lead',
        brand: 'access-hire', visitType: 'new',
        isReturn: false, deviceMatch: false, emailMatch: false, phoneMatch: false,
        crossBrand: false, previousBrand: null,
        desc: 'First time visitor to any CLG brand site. No device fingerprint, email, or phone matches exist.'
      },
      'new_cross': {
        email: 'cross.brand@company.com', phone: '0400222333', name: 'Cross Brand User',
        brand: 'access-hire', visitType: 'new',
        isReturn: false, deviceMatch: true, emailMatch: false, phoneMatch: false,
        crossBrand: true, previousBrand: 'access-express',
        desc: 'First visit to Access Hire, but same device previously visited Access Express. Firebase detects device match.'
      },
      'return_same': {
        email: 'returning@company.com', phone: '0400333444', name: 'Returning User',
        brand: 'access-hire', visitType: 'return',
        isReturn: true, deviceMatch: true, emailMatch: true, phoneMatch: false,
        crossBrand: false, previousBrand: null,
        desc: 'Returning visitor on same device. Firebase recognizes device, NS Adapter finds existing email record.'
      },
      'return_new_device': {
        email: 'known.user@company.com', phone: '0412345678', name: 'Known User',
        brand: 'access-hire', visitType: 'new',
        isReturn: false, deviceMatch: false, emailMatch: true, phoneMatch: true,
        crossBrand: false, previousBrand: null,
        desc: 'User on new device (laptop at work). Firebase sees new device, but NS Adapter matches email and phone.'
      },
      'return_cross_device': {
        email: 'multi.device@company.com', phone: '0400555666', name: 'Multi-Device User',
        brand: 'access-hire', visitType: 'new',
        isReturn: false, deviceMatch: false, emailMatch: true, phoneMatch: false,
        crossBrand: true, previousBrand: 'access-express',
        desc: 'User previously visited Access Express on phone, now on Access Hire on desktop. Different device, NS finds email match.'
      },
      'ns_dupe': {
        email: 'hidden.dupe@company.com', phone: '0412999888', name: 'Sneaky Duplicate',
        brand: 'access-hire', visitType: 'new',
        isReturn: false, deviceMatch: false, emailMatch: false, phoneMatch: true,
        crossBrand: false, previousBrand: null,
        desc: 'Appears completely new (new device, new email) but NS Adapter finds phone number already in system from previous submission.'
      },
      'custom': {
        email: 'custom@company.com', phone: '0400000000', name: 'Custom Test',
        brand: 'access-hire', visitType: 'new',
        isReturn: false, deviceMatch: false, emailMatch: false, phoneMatch: false,
        crossBrand: false, previousBrand: null,
        desc: 'Configure your own scenario using the form fields below.'
      }
    };

    let mode = 'auto';
    let stepQueue = [];
    let currentScenario = scenarios['new_first'];

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16).toUpperCase();
      });
    }

    function log(source, message) {
      const el = document.getElementById('eventLog');
      const time = new Date().toLocaleTimeString('en-AU', { hour12: false });
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `
        <span class="log-time">${time}</span>
        <span class="log-source ${source.toLowerCase()}">${source}</span>
        <span class="log-message">${message}</span>
      `;
      el.insertBefore(entry, el.firstChild);
    }

    function clearLog() {
      document.getElementById('eventLog').innerHTML = '';
    }

    function setAnnotation(text, active = true) {
      const el = document.getElementById('annotation');
      el.innerHTML = text;
      el.className = 'annotation-text' + (active ? ' active' : '');
    }

    function selectPreset(el) {
      document.querySelectorAll('.preset').forEach(p => p.classList.remove('active'));
      el.classList.add('active');
      const s = scenarios[el.dataset.scenario];
      currentScenario = s;
      document.getElementById('email').value = s.email;
      document.getElementById('phone').value = s.phone;
      document.getElementById('name').value = s.name;
      document.getElementById('brand').value = s.brand;
      document.getElementById('visitType').value = s.visitType;
      setAnnotation(`<strong>${el.querySelector('.preset-label').textContent}:</strong><br>${s.desc}`, false);
    }

    function setMode(m) {
      mode = m;
      document.getElementById('autoBtn').classList.toggle('active', m === 'auto');
      document.getElementById('manualBtn').classList.toggle('active', m === 'manual');
      document.getElementById('nextBtn').style.display = m === 'manual' ? 'block' : 'none';
    }

    function activateStep(num) {
      const el = document.getElementById('num-' + num);
      if (el) el.classList.add('active');
    }

    function completeStep(num, warning = false) {
      const el = document.getElementById('num-' + num);
      if (el) {
        el.classList.remove('active');
        el.classList.add(warning ? 'warning' : 'done');
      }
    }

    async function activateBox(id, warning = false) {
      const box = document.getElementById(id);
      if (!box) return;
      box.classList.add('active');
      if (warning) box.classList.add('warning');
      return new Promise(r => setTimeout(() => {
        box.classList.remove('active');
        box.classList.add('done');
        r();
      }, mode === 'auto' ? 450 : 200));
    }

    function activateConnector(id) {
      const el = document.getElementById(id);
      if (el) {
        el.classList.add('active');
        setTimeout(() => {
          el.classList.remove('active');
          el.classList.add('done');
        }, 150);
      }
    }

    async function executeStep(step) {
      await step.fn();
      if (mode === 'manual') {
        document.getElementById('nextBtn').disabled = false;
      }
    }

    function nextStep() {
      if (stepQueue.length > 0) {
        document.getElementById('nextBtn').disabled = true;
        const step = stepQueue.shift();
        executeStep(step);
      }
    }

    async function runFlow() {
      const s = currentScenario;
      const brand = document.getElementById('brand').value;
      const visitType = document.getElementById('visitType').value;
      const email = document.getElementById('email').value;
      const name = document.getElementById('name').value;
      const uid = generateUUID();
      const nsId = 'NS-' + Math.floor(Math.random() * 100000);
      const ampId = 'AMP-' + uid.substring(0, 8);

      const hasDuplicate = s.deviceMatch || s.emailMatch || s.phoneMatch;

      document.getElementById('runBtn').disabled = true;
      document.getElementById('nextBtn').disabled = true;

      // Reset UI
      document.querySelectorAll('.step-num').forEach(el => el.classList.remove('active', 'done', 'warning'));
      document.querySelectorAll('.step-box, .branch-box').forEach(el => el.classList.remove('active', 'done', 'warning'));
      document.querySelectorAll('.flow-connector').forEach(el => el.classList.remove('active', 'done'));
      document.getElementById('dup-section').classList.remove('show');

      // Build step queue
      stepQueue = [
        // Step 1: User Arrives
        {
          fn: async () => {
            activateStep(1);
            const visitDesc = s.isReturn ? 'returning to' : (s.crossBrand ? 'arriving at (first visit to this brand)' : 'arriving at (first visit ever)');
            setAnnotation(`<strong>Step 1: User Arrives</strong><br>User ${visitDesc} <strong>${brand}</strong>. Browser loads the page and fires <code>page_view</code> event.${s.crossBrand ? `<br><em>Previously visited: ${s.previousBrand}</em>` : ''}`);
            log('USER', `Navigating to ${brand}`);
            log('DATALAYER', `Push: page_view { brand: "${brand}", url: "/" }`);
            await activateBox('box-arrive');
            completeStep(1);
            activateConnector('conn-1');
          }
        },
        // Step 2: Firebase SDK
        {
          fn: async () => {
            activateStep(2);
            log('FIREBASE', 'SDK initializing...');

            if (s.isReturn && s.deviceMatch) {
              // Returning user, same device - retrieve existing UID
              setAnnotation(`<strong>Step 2: Firebase SDK</strong><br>Firebase recognizes this device. Retrieving existing UID from local storage. User was here before.`);
              log('FIREBASE', '‚úì Existing device fingerprint found');
              log('FIREBASE', `Retrieved existing UID: ${uid.substring(0, 8)}...`);
              document.getElementById('displayUid').textContent = uid.substring(0, 18) + '...';
              document.getElementById('displayUid').classList.add('set');
              await activateBox('box-firebase');
              completeStep(2);
            } else if (s.deviceMatch && s.crossBrand) {
              // Cross-brand: device seen on other brand
              setAnnotation(`<strong>Step 2: Firebase SDK</strong><br>‚ö†Ô∏è <span style="color:#f90">Device recognized from ${s.previousBrand}!</span> This device submitted a lead on another brand. Generating new UID but flagging as <code>cross_brand_device</code>.`);
              log('FIREBASE', `‚ö†Ô∏è Device fingerprint matches ${s.previousBrand}`);
              log('FIREBASE', `Generated new UID: ${uid.substring(0, 8)}...`);
              log('FIREBASE', 'Flag: cross_brand_device = true');
              document.getElementById('displayUid').textContent = uid.substring(0, 18) + '...';
              document.getElementById('displayUid').classList.add('set');
              await activateBox('box-firebase', true);
              completeStep(2, true);
            } else if (s.deviceMatch) {
              // Device match on same brand
              setAnnotation(`<strong>Step 2: Firebase SDK</strong><br>‚ö†Ô∏è <span style="color:#f90">Device match!</span> This device has submitted leads before on this brand. Adding <code>duplicate_alert: device_match</code> to payload.`);
              log('FIREBASE', '‚ö†Ô∏è Device fingerprint MATCH on this brand');
              log('FIREBASE', `Generated UID: ${uid.substring(0, 8)}...`);
              document.getElementById('displayUid').textContent = uid.substring(0, 18) + '...';
              document.getElementById('displayUid').classList.add('set');
              await activateBox('box-firebase', true);
              completeStep(2, true);
            } else {
              // New device
              setAnnotation(`<strong>Step 2: Firebase SDK</strong><br>New device detected. Generating fresh UID and storing device fingerprint for future recognition.`);
              log('FIREBASE', 'New device - no fingerprint match');
              log('FIREBASE', `Generated UID: ${uid.substring(0, 8)}...`);
              log('FIREBASE', 'Storing device fingerprint');
              document.getElementById('displayUid').textContent = uid.substring(0, 18) + '...';
              document.getElementById('displayUid').classList.add('set');
              await activateBox('box-firebase');
              completeStep(2);
            }
            activateConnector('conn-2');
          }
        },
        // Step 3: Form Submit
        {
          fn: async () => {
            activateStep(3);
            const hasDeviceFlag = s.deviceMatch;
            setAnnotation(`<strong>Step 3: Form Submission</strong><br>User fills and submits lead form. DataLayer receives <code>form_submit</code> with UID${hasDeviceFlag ? ' and device duplicate flag' : ''}.`);
            log('SITE', 'User completing form...');
            log('SITE', `Form submitted on ${brand}`);
            log('DATALAYER', `Push: form_submit { uid: "${uid.substring(0, 8)}...", email: "${email}"${hasDeviceFlag ? ', device_flag: true' : ''} }`);
            await activateBox('box-form', hasDeviceFlag);
            completeStep(3, hasDeviceFlag);
            activateConnector('conn-3');
          }
        },
        // Step 4: NS Adapter
        {
          fn: async () => {
            activateStep(4);
            setAnnotation(`<strong>Step 4: NS Adapter</strong><br>Adapter receives lead data and checks for duplicates by email and phone against existing NetSuite records.`);
            log('ADAPTER', 'Received lead data from site');

            const adapterWarning = s.emailMatch || s.phoneMatch;

            log('ADAPTER', 'Checking email against NS records...');
            if (s.emailMatch) {
              log('ADAPTER', '‚ö†Ô∏è EMAIL MATCH found in NetSuite');
            } else {
              log('ADAPTER', 'Email: no match');
            }

            log('ADAPTER', 'Checking phone against NS records...');
            if (s.phoneMatch) {
              log('ADAPTER', '‚ö†Ô∏è PHONE MATCH found in NetSuite');
            } else {
              log('ADAPTER', 'Phone: no match');
            }

            if (adapterWarning) {
              const matchType = s.emailMatch && s.phoneMatch ? 'Email AND Phone' : (s.emailMatch ? 'Email' : 'Phone');
              setAnnotation(`<strong>Step 4: NS Adapter</strong><br>‚ö†Ô∏è <span style="color:#f90">Duplicate detected!</span> ${matchType} match found in NetSuite. Lead will be created but flagged for sales review.`);
            }

            log('ADAPTER', 'Transforming payload for NetSuite API');
            await activateBox('box-adapter', adapterWarning);
            completeStep(4, adapterWarning);
            activateConnector('conn-4');
          }
        },
        // Step 5: NetSuite
        {
          fn: async () => {
            activateStep(5);
            setAnnotation(`<strong>Step 5: NetSuite Lead Creation</strong><br>Creating lead record in NetSuite. UID ensures uniqueness even if duplicate. DataLayer receives <code>lead_created</code>.`);
            log('NETSUITE', 'API: Creating lead record...');
            await new Promise(r => setTimeout(r, 250));

            document.getElementById('displayNsId').textContent = nsId;
            document.getElementById('displayNsId').classList.add('set');
            log('NETSUITE', `Lead created: ${nsId}`);

            if (hasDuplicate) {
              log('NETSUITE', '‚ö†Ô∏è Lead flagged for duplicate review');
              if (s.deviceMatch) log('NETSUITE', 'Alert: "Device previously seen"');
              if (s.emailMatch) log('NETSUITE', 'Alert: "Email exists in system"');
              if (s.phoneMatch) log('NETSUITE', 'Alert: "Phone exists in system"');
            }

            log('DATALAYER', `Push: lead_created { nsId: "${nsId}" }`);
            await activateBox('box-netsuite', hasDuplicate);
            completeStep(5, hasDuplicate);
            activateConnector('conn-5');
          }
        },
        // Step 6: Sync to Iterable + Amplitude
        {
          fn: async () => {
            setAnnotation(`<strong>Step 6: Platform Sync</strong><br>NetSuite webhooks send lead data to Iterable (email) and Amplitude (analytics) simultaneously.`);
            log('NETSUITE', '‚Üí Webhook: Sending to Iterable');
            log('NETSUITE', '‚Üí Webhook: Sending to Amplitude');

            await activateBox('box-iterable');
            log('ITERABLE', 'Contact created');
            log('ITERABLE', 'Added to welcome sequence');

            document.getElementById('displayAmpId').textContent = ampId;
            document.getElementById('displayAmpId').classList.add('set');
            await activateBox('box-amplitude');
            log('AMPLITUDE', `User profile created: ${ampId}`);

            activateConnector('conn-6');
          }
        },
        // Step 7: Enrichment
        {
          fn: async () => {
            activateStep(7);
            setAnnotation(`<strong>Step 7: Enrichment Webhook</strong><br>Amplitude computes user properties and sends enriched profile back to site for personalization.`);
            log('AMPLITUDE', '‚Üí Webhook: Sending enriched data');
            log('SITE', 'Received enrichment webhook');
            log('DATALAYER', 'Push: lead_enriched { segment, value, interests }');
            await activateBox('box-enrich');
            completeStep(7);
          }
        }
      ];

      // Add duplicate alert steps if needed
      if (hasDuplicate) {
        stepQueue.push(
          {
            fn: async () => {
              document.getElementById('dup-section').classList.add('show');
              activateStep(8);
              const sources = [];
              if (s.deviceMatch) sources.push('Firebase (device)');
              if (s.emailMatch) sources.push('NS Adapter (email)');
              if (s.phoneMatch) sources.push('NS Adapter (phone)');
              setAnnotation(`<strong>Step 8: Duplicate Event</strong><br>Amplitude receives <code>duplicate_detected</code> event.<br>Sources: ${sources.join(', ')}`);
              log('AMPLITUDE', `Event: duplicate_detected`);
              log('AMPLITUDE', `Sources: ${sources.join(', ')}`);
              await activateBox('box-amp-event');
              completeStep(8);
              activateConnector('conn-8');
            }
          },
          {
            fn: async () => {
              activateStep(9);
              setAnnotation(`<strong>Step 9: Iterable Journey</strong><br>Amplitude event triggers Iterable journey to notify sales team about potential duplicate.`);
              log('ITERABLE', 'Journey triggered: "Duplicate Lead Alert"');
              log('ITERABLE', 'Building notification...');
              await activateBox('box-iterable-journey');
              completeStep(9);
              activateConnector('conn-9');
            }
          },
          {
            fn: async () => {
              activateStep(10);
              setAnnotation(`<strong>Step 10: Sales Alert</strong><br>Sales team receives email with duplicate details. They can review and merge in NetSuite if needed.`);
              log('SALES', 'Email: "Potential Duplicate Lead"');
              log('SALES', `New: ${name} <${email}>`);
              if (s.emailMatch || s.phoneMatch) log('SALES', 'Matches existing NS record');
              if (s.deviceMatch && s.crossBrand) log('SALES', `Same device as ${s.previousBrand} lead`);
              else if (s.deviceMatch) log('SALES', 'Same device as previous submission');
              await activateBox('box-sales');
              completeStep(10);
            }
          }
        );
      }

      // Final step
      stepQueue.push({
        fn: async () => {
          log('SITE', '‚úì Flow complete');
          setAnnotation(hasDuplicate
            ? `<strong>Flow Complete</strong><br>Lead created and sales notified of duplicate. They can review and merge records in NetSuite.`
            : `<strong>Flow Complete</strong><br>New lead created and synced across all platforms. Ready for personalization.`
          );
          document.getElementById('runBtn').disabled = false;
        }
      });

      // Execute
      if (mode === 'auto') {
        for (const step of stepQueue) {
          await step.fn();
          await new Promise(r => setTimeout(r, 350));
        }
        stepQueue = [];
      } else {
        document.getElementById('nextBtn').disabled = false;
        const firstStep = stepQueue.shift();
        executeStep(firstStep);
      }
    }

    function resetDemo() {
      stepQueue = [];
      document.querySelectorAll('.step-num').forEach(el => el.classList.remove('active', 'done', 'warning'));
      document.querySelectorAll('.step-box, .branch-box').forEach(el => el.classList.remove('active', 'done', 'warning'));
      document.querySelectorAll('.flow-connector').forEach(el => el.classList.remove('active', 'done'));
      document.getElementById('dup-section').classList.remove('show');

      document.getElementById('displayUid').textContent = '‚Äî';
      document.getElementById('displayUid').classList.remove('set');
      document.getElementById('displayNsId').textContent = '‚Äî';
      document.getElementById('displayNsId').classList.remove('set');
      document.getElementById('displayAmpId').textContent = '‚Äî';
      document.getElementById('displayAmpId').classList.remove('set');

      document.getElementById('runBtn').disabled = false;
      document.getElementById('nextBtn').disabled = true;

      clearLog();
      setAnnotation('Select a scenario and click "Run Flow" to see the identity resolution process in action.', false);
      log('SITE', 'Demo reset');
    }

    // Keyboard support
    document.addEventListener('keydown', e => {
      if (e.code === 'Space' && mode === 'manual' && !document.getElementById('nextBtn').disabled) {
        e.preventDefault();
        nextStep();
      }
      if (e.code === 'KeyR' && !e.metaKey && !e.ctrlKey) {
        resetDemo();
      }
    });

    window.onload = () => {
      log('SITE', 'System ready');
      setAnnotation('Select a scenario and click "Run Flow" to see the identity resolution process in action.', false);
    };
  </script>
</body>
</html>
