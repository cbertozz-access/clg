<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CLG Identity Resolution - Lead Flow</title>
  <!-- Marker.io feedback widget -->
  <script>
    window.markerConfig = {
      project: '6979f1c4cd39869705a0b56d',
      source: 'snippet',
    }
  </script>
  <script>
    !function(e,r,a){if(!e.__Marker){e.__Marker={};var t=[],n={__cs:t};["show","hide","isVisible","capture","cancelCapture","unload","reload","isExtensionInstalled","setReporter","clearReporter","setCustomData","on","off"].forEach(function(e){n[e]=function(){var r=Array.prototype.slice.call(arguments);r.unshift(e),t.push(r)}}),e.Marker=n;var s=r.createElement("script");s.async=1,s.src="https://edge.marker.io/latest/shim.js";var i=r.getElementsByTagName("script")[0];i.parentNode.insertBefore(s,i)}}(window,document);
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #0a0a0a;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    .app {
      display: grid;
      grid-template-columns: 300px 1fr 380px;
      height: 100vh;
      overflow: hidden;
    }

    /* ==================== LEFT SIDEBAR ==================== */
    .sidebar {
      background: #0d0d0d;
      border-right: 1px solid #1a1a1a;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 24px 24px 20px;
      border-bottom: 1px solid #1a1a1a;
    }
    .sidebar-header h1 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .sidebar-header p {
      font-size: 13px;
      color: #666;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px 24px;
    }

    .section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #555;
      margin-bottom: 16px;
    }

    /* Scenario Description */
    .scenario-description {
      font-size: 12px;
      color: #888;
      line-height: 1.5;
      padding: 12px;
      background: #111;
      border-radius: 8px;
      margin-top: 10px;
      border-left: 3px solid #333;
    }

    /* Form Section */
    .form-section {
      margin-bottom: 28px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #888;
      margin-bottom: 8px;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      background: #111;
      border: 2px solid #222;
      border-radius: 8px;
      color: #fff;
      padding: 12px 14px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #444;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* Controls */
    .controls {
      padding: 20px 24px;
      border-top: 1px solid #1a1a1a;
      background: #0d0d0d;
      flex-shrink: 0;
    }

    .playback-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
    }
    .playback-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid #222;
      border-radius: 8px;
      background: #111;
      color: #888;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .playback-btn:hover {
      border-color: #444;
      color: #fff;
    }
    .playback-btn.active {
      background: #fff;
      color: #000;
      border-color: #fff;
    }

    .speed-control {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }
    .speed-label {
      font-size: 12px;
      color: #666;
    }
    .speed-btns {
      display: flex;
      gap: 6px;
    }
    .speed-btn {
      padding: 6px 12px;
      border: 1px solid #333;
      border-radius: 6px;
      background: transparent;
      color: #666;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .speed-btn:hover { border-color: #555; color: #999; }
    .speed-btn.active { background: #333; color: #fff; border-color: #333; }

    .btn-run {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 10px;
      background: #fff;
      color: #000;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 10px;
    }
    .btn-run:hover { background: #e0e0e0; }
    .btn-run:disabled { background: #333; color: #666; cursor: not-allowed; }

    .btn-next {
      width: 100%;
      padding: 14px;
      border: 2px solid #333;
      border-radius: 10px;
      background: transparent;
      color: #888;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: none;
    }
    .btn-next:hover:not(:disabled) { border-color: #666; color: #fff; }
    .btn-next:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-next.show { display: block; }

    .btn-reset {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: #555;
      font-size: 13px;
      cursor: pointer;
      transition: color 0.2s;
    }
    .btn-reset:hover { color: #999; }

    /* ==================== MAIN FLOW AREA ==================== */
    .main-area {
      display: flex;
      flex-direction: column;
      background: #0a0a0a;
      overflow: hidden;
      min-height: 0; /* Important for flex children */
    }

    /* Progress Bar */
    .progress-bar {
      height: 4px;
      background: #1a1a1a;
      flex-shrink: 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #00ff88, #00ffff);
      width: 0%;
      transition: width 0.3s ease;
    }

    /* Flow Container */
    .flow-area {
      flex: 1;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      overflow-y: auto;
      min-height: 0;
      padding: 24px 40px;
    }

    .flow-diagram {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0;
    }

    /* Flow Steps */
    .flow-step {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .step-number {
      width: 36px;
      height: 36px;
      border: 2px solid #333;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: #444;
      flex-shrink: 0;
      transition: all 0.3s ease;
      background: #0a0a0a;
    }
    .step-number.active {
      border-color: #fff;
      background: #fff;
      color: #000;
      transform: scale(1.2);
      box-shadow: 0 0 30px rgba(255,255,255,0.3);
    }
    .step-number.done {
      border-color: #00ff88;
      color: #00ff88;
    }
    .step-number.warning {
      border-color: #ff9900;
      color: #ff9900;
    }

    .step-card {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #111;
      border: 2px solid #222;
      border-radius: 10px;
      padding: 12px 16px;
      min-width: 340px;
      transition: all 0.3s ease;
    }
    .step-card.active {
      border-color: #fff;
      background: #1a1a1a;
      transform: scale(1.03);
      box-shadow: 0 8px 40px rgba(255,255,255,0.1);
    }
    .step-card.done {
      border-color: #333;
      opacity: 0.85;
    }
    .step-card.warning {
      border-color: #ff9900;
      background: #1a1500;
    }

    .step-icon {
      width: 38px;
      height: 38px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    .step-icon.user { background: linear-gradient(135deg, #1a1a3e, #2a2a5e); }
    .step-icon.firebase { background: linear-gradient(135deg, #3e2a1a, #5e3a1a); }
    .step-icon.site { background: linear-gradient(135deg, #1a1a3e, #2a2a5e); }
    .step-icon.adapter { background: linear-gradient(135deg, #1a3e1a, #1a5e2a); }
    .step-icon.netsuite { background: linear-gradient(135deg, #3e1a1a, #5e1a1a); }
    .step-icon.iterable { background: linear-gradient(135deg, #3e1a3e, #5e1a5e); }
    .step-icon.amplitude { background: linear-gradient(135deg, #3e3e1a, #5e5e1a); }
    .step-icon.sales { background: linear-gradient(135deg, #3e2a1a, #5e3a1a); }

    .step-content { flex: 1; }
    .step-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .step-subtitle {
      font-size: 11px;
      color: #666;
    }

    .step-badge {
      font-size: 10px;
      padding: 5px 10px;
      border-radius: 6px;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .step-badge.datalayer { background: rgba(0,255,255,0.15); color: #0ff; }
    .step-badge.sdk { background: rgba(255,200,0,0.15); color: #fc0; }

    /* Connectors */
    .connector {
      width: 2px;
      height: 16px;
      background: #222;
      margin-left: 17px;
      transition: all 0.3s;
      position: relative;
    }
    .connector::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 0%;
      background: linear-gradient(180deg, #00ff88, #00ffff);
      transition: height 0.3s ease;
    }
    .connector.active::before,
    .connector.done::before {
      height: 100%;
    }

    /* Branch */
    .flow-branch {
      display: flex;
      gap: 16px;
      margin: 10px 0;
      position: relative;
    }
    .flow-branch::before {
      content: '';
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 160px;
      height: 2px;
      background: #222;
    }

    .branch-card {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #111;
      border: 2px solid #222;
      border-radius: 8px;
      padding: 10px 14px;
      transition: all 0.3s;
    }
    .branch-card.active {
      border-color: #fff;
      background: #1a1a1a;
      transform: scale(1.05);
    }
    .branch-card.done {
      border-color: #333;
      opacity: 0.85;
    }
    .branch-icon { font-size: 18px; }
    .branch-name { font-size: 14px; font-weight: 600; }

    /* Duplicate Section */
    .dup-section {
      margin-top: 14px;
      padding-top: 16px;
      border-top: 2px dashed #ff9900;
      display: none;
    }
    .dup-section.show { display: block; }
    .dup-label {
      text-align: center;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #ff9900;
      margin-bottom: 14px;
      font-weight: 600;
    }

    /* Annotation */
    .annotation {
      background: #1a1a1a;
      border-top: 3px solid #444;
      padding: 20px 40px;
      min-height: 110px;
      flex-shrink: 0;
    }
    .annotation-label {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #888;
      margin-bottom: 10px;
      font-weight: 600;
    }
    .annotation-text {
      font-size: 17px;
      color: #aaa;
      line-height: 1.6;
    }
    .annotation-text.active { color: #fff; }
    .annotation-text code {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 14px;
      background: #1a1a1a;
      padding: 3px 8px;
      border-radius: 4px;
      color: #0ff;
    }
    .annotation-text strong { color: #fff; }

    /* ==================== RIGHT PANEL - LOGS ==================== */
    .logs-panel {
      background: #0d0d0d;
      border-left: 1px solid #1a1a1a;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .logs-header {
      padding: 20px 20px 16px;
      border-bottom: 1px solid #1a1a1a;
      display: flex;
      flex-shrink: 0;
      justify-content: space-between;
      align-items: center;
    }
    .logs-header h3 {
      font-size: 14px;
      font-weight: 600;
      color: #888;
    }
    .logs-actions {
      display: flex;
      gap: 8px;
    }
    .log-action-btn {
      padding: 6px 12px;
      border: 1px solid #333;
      border-radius: 6px;
      background: transparent;
      color: #666;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .log-action-btn:hover { border-color: #555; color: #999; }

    /* IDs Section */
    .ids-section {
      padding: 16px 20px;
      border-bottom: 1px solid #1a1a1a;
      flex-shrink: 0;
    }
    .ids-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #555;
      margin-bottom: 12px;
    }
    .id-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #151515;
    }
    .id-item:last-child { border-bottom: none; }
    .id-label {
      font-size: 12px;
      color: #666;
    }
    .id-value {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 12px;
      color: #444;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .id-value.set { color: #00ff88; }
    .id-value .copy-btn {
      padding: 4px 8px;
      border: 1px solid #333;
      border-radius: 4px;
      background: transparent;
      color: #666;
      font-size: 10px;
      cursor: pointer;
      opacity: 0;
      transition: all 0.2s;
    }
    .id-value:hover .copy-btn { opacity: 1; }
    .id-value .copy-btn:hover { border-color: #555; color: #999; }

    /* Log Container */
    .log-container {
      flex: 1;
      overflow-y: auto;
      padding: 12px 0;
      min-height: 0;
    }
    .log-entry {
      padding: 10px 20px;
      border-bottom: 1px solid #111;
      display: flex;
      gap: 12px;
      align-items: flex-start;
      font-size: 13px;
    }
    .log-time {
      color: #555;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      flex-shrink: 0;
    }
    .log-source {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      flex-shrink: 0;
      min-width: 70px;
      text-align: center;
    }
    .log-source.user { background: #1a1a3e; color: #88f; }
    .log-source.firebase { background: #3e2a1a; color: #fa0; }
    .log-source.site { background: #1a1a3e; color: #88f; }
    .log-source.datalayer { background: #1a3e3e; color: #0ff; }
    .log-source.adapter { background: #1a3e1a; color: #8f8; }
    .log-source.netsuite { background: #3e1a1a; color: #f88; }
    .log-source.iterable { background: #3e1a3e; color: #f8f; }
    .log-source.amplitude { background: #3e3e1a; color: #ff8; }
    .log-source.sales { background: #3e2a1a; color: #fa8; }
    .log-message {
      color: #999;
      flex: 1;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Left Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>Identity Resolution</h1>
        <p>CLG Lead Flow Demo</p>
      </div>

      <div class="sidebar-content">
        <div class="form-group">
          <label>Scenario</label>
          <select id="scenarioSelect" onchange="selectScenario(this.value)">
            <option value="new_first">New User - First Visit</option>
            <option value="new_cross">New to Brand A, Visited B</option>
            <option value="return_same">Returning - Same Device</option>
            <option value="return_new_device">Returning - New Device</option>
            <option value="ns_dupe">NS Detects Duplicate</option>
            <option value="custom">Custom Scenario</option>
          </select>
        </div>
        <div class="scenario-description" id="scenarioDesc">
          First time visitor to any CLG brand site. No device fingerprint, email, or phone matches exist.
        </div>

        <div class="section-title" style="margin-top: 20px;">Lead Details</div>
        <div class="form-section">
          <div class="form-row">
            <div class="form-group">
              <label>Brand</label>
              <select id="brand">
                <option value="access-hire">Access Hire</option>
                <option value="access-express">Access Express</option>
              </select>
            </div>
            <div class="form-group">
              <label>Visit Type</label>
              <select id="visitType">
                <option value="new">New Visit</option>
                <option value="return">Return Visit</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="email" value="newlead@company.com">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="phone" value="0400111222">
            </div>
            <div class="form-group">
              <label>Name</label>
              <input type="text" id="name" value="New Lead">
            </div>
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="playback-controls">
          <button class="playback-btn active" id="autoBtn" onclick="setMode('auto')">Auto Play</button>
          <button class="playback-btn" id="manualBtn" onclick="setMode('manual')">Step-by-Step</button>
        </div>

        <div class="speed-control" id="speedControl">
          <span class="speed-label">Speed:</span>
          <div class="speed-btns">
            <button class="speed-btn" data-speed="0.5" onclick="setSpeed(0.5)">0.5x</button>
            <button class="speed-btn active" data-speed="1" onclick="setSpeed(1)">1x</button>
            <button class="speed-btn" data-speed="2" onclick="setSpeed(2)">2x</button>
          </div>
        </div>

        <button class="btn-run" id="runBtn" onclick="runFlow()">Run Flow</button>
        <button class="btn-next" id="nextBtn" onclick="nextStep()">Next Step ‚Üí</button>
        <button class="btn-reset" onclick="resetDemo()">Reset Demo</button>
      </div>
    </div>

    <!-- Main Flow Area -->
    <div class="main-area">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>

      <div class="flow-area">
        <div class="flow-diagram">
          <!-- Step 1: Page Load - SDK Init -->
          <div class="flow-step">
            <div class="step-number" id="num-1">1</div>
            <div class="step-card" id="box-sdk">
              <div class="step-icon firebase">üî•</div>
              <div class="step-content">
                <div class="step-title">Page Load - SDK Init</div>
                <div class="step-subtitle">Generate/retrieve UID, check device</div>
              </div>
              <div class="step-badge sdk">SDK</div>
            </div>
          </div>

          <div class="connector" id="conn-1"></div>

          <!-- Step 2: DataLayer page_view -->
          <div class="flow-step">
            <div class="step-number" id="num-2">2</div>
            <div class="step-card" id="box-pageview">
              <div class="step-icon user">üåê</div>
              <div class="step-content">
                <div class="step-title">DataLayer Push</div>
                <div class="step-subtitle">page_view with UID attached</div>
              </div>
              <div class="step-badge datalayer">page_view</div>
            </div>
          </div>

          <div class="connector" id="conn-2"></div>

          <!-- Step 3: Form Submit -->
          <div class="flow-step">
            <div class="step-number" id="num-3">3</div>
            <div class="step-card" id="box-form">
              <div class="step-icon site">üìù</div>
              <div class="step-content">
                <div class="step-title">User Submits Form</div>
                <div class="step-subtitle">Lead form with UID attached</div>
              </div>
              <div class="step-badge datalayer">form_submit</div>
            </div>
          </div>

          <div class="connector" id="conn-3"></div>

          <!-- Step 4: NS Adapter -->
          <div class="flow-step">
            <div class="step-number" id="num-4">4</div>
            <div class="step-card" id="box-adapter">
              <div class="step-icon adapter">‚ö°</div>
              <div class="step-content">
                <div class="step-title">NS Adapter</div>
                <div class="step-subtitle">Check email/phone duplicates</div>
              </div>
            </div>
          </div>

          <div class="connector" id="conn-4"></div>

          <!-- Step 5: NetSuite -->
          <div class="flow-step">
            <div class="step-number" id="num-5">5</div>
            <div class="step-card" id="box-netsuite">
              <div class="step-icon netsuite">üè¢</div>
              <div class="step-content">
                <div class="step-title">NetSuite</div>
                <div class="step-subtitle">Create lead record</div>
              </div>
              <div class="step-badge datalayer">lead_created</div>
            </div>
          </div>

          <div class="connector" id="conn-5"></div>

          <!-- Step 6: Branch -->
          <div class="flow-branch" id="branch-sync">
            <div class="branch-card" id="box-iterable">
              <span class="branch-icon">üìß</span>
              <span class="branch-name">Iterable</span>
            </div>
            <div class="branch-card" id="box-amplitude">
              <span class="branch-icon">üìä</span>
              <span class="branch-name">Amplitude</span>
            </div>
          </div>

          <div class="connector" id="conn-6"></div>

          <!-- Step 7: Enrichment -->
          <div class="flow-step">
            <div class="step-number" id="num-7">7</div>
            <div class="step-card" id="box-enrich">
              <div class="step-icon site">‚ú®</div>
              <div class="step-content">
                <div class="step-title">Enrichment Webhook</div>
                <div class="step-subtitle">Profile data returned to site</div>
              </div>
              <div class="step-badge datalayer">lead_enriched</div>
            </div>
          </div>

          <!-- Duplicate Section -->
          <div class="dup-section" id="dup-section">
            <div class="dup-label">‚ö†Ô∏è Duplicate Alert Flow</div>

            <div class="flow-step">
              <div class="step-number" id="num-8">8</div>
              <div class="step-card" id="box-amp-event">
                <div class="step-icon amplitude">üìä</div>
                <div class="step-content">
                  <div class="step-title">Amplitude Event</div>
                  <div class="step-subtitle">duplicate_detected event</div>
                </div>
              </div>
            </div>

            <div class="connector" id="conn-8"></div>

            <div class="flow-step">
              <div class="step-number" id="num-9">9</div>
              <div class="step-card" id="box-iterable-journey">
                <div class="step-icon iterable">üìß</div>
                <div class="step-content">
                  <div class="step-title">Iterable Journey</div>
                  <div class="step-subtitle">Sales notification workflow</div>
                </div>
              </div>
            </div>

            <div class="connector" id="conn-9"></div>

            <div class="flow-step">
              <div class="step-number" id="num-10">10</div>
              <div class="step-card" id="box-sales">
                <div class="step-icon sales">üë§</div>
                <div class="step-content">
                  <div class="step-title">Sales Alert</div>
                  <div class="step-subtitle">Email with duplicate info</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Annotation -->
      <div class="annotation">
        <div class="annotation-label">What's Happening</div>
        <div class="annotation-text" id="annotation">
          Select a scenario and click <strong>Run Flow</strong> to see the identity resolution process in action.
        </div>
      </div>
    </div>

    <!-- Right Panel - Logs -->
    <div class="logs-panel">
      <div class="logs-header">
        <h3>Event Log</h3>
        <div class="logs-actions">
          <button class="log-action-btn" onclick="clearLog()">Clear</button>
        </div>
      </div>

      <div class="ids-section">
        <div class="ids-title">Generated IDs</div>
        <div class="id-item">
          <span class="id-label">UID</span>
          <span class="id-value" id="displayUid">
            <span class="id-text">Awaiting...</span>
            <button class="copy-btn" onclick="copyId('displayUid')">Copy</button>
          </span>
        </div>
        <div class="id-item">
          <span class="id-label">NS Lead</span>
          <span class="id-value" id="displayNsId">
            <span class="id-text">Awaiting...</span>
            <button class="copy-btn" onclick="copyId('displayNsId')">Copy</button>
          </span>
        </div>
        <div class="id-item">
          <span class="id-label">Amplitude</span>
          <span class="id-value" id="displayAmpId">
            <span class="id-text">Awaiting...</span>
            <button class="copy-btn" onclick="copyId('displayAmpId')">Copy</button>
          </span>
        </div>
      </div>

      <div class="log-container" id="eventLog"></div>
    </div>
  </div>

  <script>
    const scenarios = {
      'new_first': {
        email: 'brand.new@company.com', phone: '0400111222', name: 'Brand New Lead',
        brand: 'access-hire', visitType: 'new',
        isReturn: false, deviceMatch: false, emailMatch: false, phoneMatch: false,
        crossBrand: false, previousBrand: null,
        desc: 'First time visitor to any CLG brand site. No device fingerprint, email, or phone matches exist.'
      },
      'new_cross': {
        email: 'cross.brand@company.com', phone: '0400222333', name: 'Cross Brand User',
        brand: 'access-hire', visitType: 'new',
        isReturn: false, deviceMatch: true, emailMatch: false, phoneMatch: false,
        crossBrand: true, previousBrand: 'access-express',
        desc: 'First visit to Access Hire, but same device previously visited Access Express.'
      },
      'return_same': {
        email: 'returning@company.com', phone: '0400333444', name: 'Returning User',
        brand: 'access-hire', visitType: 'return',
        isReturn: true, deviceMatch: true, emailMatch: true, phoneMatch: false,
        crossBrand: false, previousBrand: null,
        desc: 'Returning visitor on same device. Firebase recognizes device, NS finds email.'
      },
      'return_new_device': {
        email: 'known.user@company.com', phone: '0412345678', name: 'Known User',
        brand: 'access-hire', visitType: 'new',
        isReturn: false, deviceMatch: false, emailMatch: true, phoneMatch: true,
        crossBrand: false, previousBrand: null,
        desc: 'User on new device. Firebase sees new device, but NS matches email and phone.'
      },
      'ns_dupe': {
        email: 'hidden.dupe@company.com', phone: '0412999888', name: 'Sneaky Duplicate',
        brand: 'access-hire', visitType: 'new',
        isReturn: false, deviceMatch: false, emailMatch: false, phoneMatch: true,
        crossBrand: false, previousBrand: null,
        desc: 'Appears completely new but NS Adapter finds phone number in system.'
      },
      'custom': {
        email: 'custom@company.com', phone: '0400000000', name: 'Custom Test',
        brand: 'access-hire', visitType: 'new',
        isReturn: false, deviceMatch: false, emailMatch: false, phoneMatch: false,
        crossBrand: false, previousBrand: null,
        desc: 'Configure your own scenario using the form fields.'
      }
    };

    let mode = 'auto';
    let speed = 1;
    let stepQueue = [];
    let totalSteps = 7;
    let currentStepNum = 0;
    let currentScenario = scenarios['new_first'];

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16).toUpperCase();
      });
    }

    function log(source, message) {
      const el = document.getElementById('eventLog');
      const time = new Date().toLocaleTimeString('en-AU', { hour12: false });
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `
        <span class="log-time">${time}</span>
        <span class="log-source ${source.toLowerCase()}">${source}</span>
        <span class="log-message">${message}</span>
      `;
      el.appendChild(entry);
      el.scrollTop = el.scrollHeight;
    }

    function clearLog() {
      document.getElementById('eventLog').innerHTML = '';
    }

    function setAnnotation(text, active = true) {
      const el = document.getElementById('annotation');
      el.innerHTML = text;
      el.className = 'annotation-text' + (active ? ' active' : '');
    }

    function updateProgress(step, total) {
      const pct = (step / total) * 100;
      document.getElementById('progressFill').style.width = pct + '%';
    }

    function setId(elId, value) {
      const el = document.getElementById(elId);
      el.querySelector('.id-text').textContent = value;
      el.classList.add('set');
    }

    function copyId(elId) {
      const text = document.getElementById(elId).querySelector('.id-text').textContent;
      navigator.clipboard.writeText(text);
    }

    function selectScenario(key) {
      const s = scenarios[key];
      currentScenario = s;
      document.getElementById('email').value = s.email;
      document.getElementById('phone').value = s.phone;
      document.getElementById('name').value = s.name;
      document.getElementById('brand').value = s.brand;
      document.getElementById('visitType').value = s.visitType;
      document.getElementById('scenarioDesc').textContent = s.desc;
      setAnnotation(`<strong>${document.getElementById('scenarioSelect').selectedOptions[0].text}</strong><br>${s.desc}`, false);
    }

    function setMode(m) {
      mode = m;
      document.getElementById('autoBtn').classList.toggle('active', m === 'auto');
      document.getElementById('manualBtn').classList.toggle('active', m === 'manual');
      document.getElementById('speedControl').style.display = m === 'auto' ? 'flex' : 'none';
      document.getElementById('nextBtn').classList.toggle('show', m === 'manual');
    }

    function setSpeed(s) {
      speed = s;
      document.querySelectorAll('.speed-btn').forEach(btn => {
        btn.classList.toggle('active', parseFloat(btn.dataset.speed) === s);
      });
    }

    function getDelay() {
      return 500 / speed;
    }

    function activateStep(num) {
      const el = document.getElementById('num-' + num);
      if (el) el.classList.add('active');
      currentStepNum = num;
      updateProgress(num, totalSteps);
    }

    function completeStep(num, warning = false) {
      const el = document.getElementById('num-' + num);
      if (el) {
        el.classList.remove('active');
        el.classList.add(warning ? 'warning' : 'done');
      }
    }

    async function activateBox(id, warning = false) {
      const box = document.getElementById(id);
      if (!box) return;
      box.classList.add('active');
      if (warning) box.classList.add('warning');
      return new Promise(r => setTimeout(() => {
        box.classList.remove('active');
        box.classList.add('done');
        r();
      }, getDelay()));
    }

    function activateConnector(id) {
      const el = document.getElementById(id);
      if (el) {
        el.classList.add('active');
        setTimeout(() => {
          el.classList.remove('active');
          el.classList.add('done');
        }, 150);
      }
    }

    async function executeStep(step) {
      await step.fn();
      if (mode === 'manual') {
        document.getElementById('nextBtn').disabled = false;
      }
    }

    function nextStep() {
      if (stepQueue.length > 0) {
        document.getElementById('nextBtn').disabled = true;
        const step = stepQueue.shift();
        executeStep(step);
      }
    }

    async function runFlow() {
      const s = currentScenario;
      const brand = document.getElementById('brand').value;
      const email = document.getElementById('email').value;
      const name = document.getElementById('name').value;
      const uid = generateUUID();
      const nsId = 'NS-' + Math.floor(Math.random() * 100000);
      const ampId = 'AMP-' + uid.substring(0, 8);

      const hasDuplicate = s.deviceMatch || s.emailMatch || s.phoneMatch;
      totalSteps = hasDuplicate ? 10 : 7;

      document.getElementById('runBtn').disabled = true;
      document.getElementById('nextBtn').disabled = true;
      updateProgress(0, totalSteps);

      // Reset UI
      document.querySelectorAll('.step-number').forEach(el => el.classList.remove('active', 'done', 'warning'));
      document.querySelectorAll('.step-card, .branch-card').forEach(el => el.classList.remove('active', 'done', 'warning'));
      document.querySelectorAll('.connector').forEach(el => el.classList.remove('active', 'done'));
      document.getElementById('dup-section').classList.remove('show');

      // Reset IDs
      ['displayUid', 'displayNsId', 'displayAmpId'].forEach(id => {
        const el = document.getElementById(id);
        el.querySelector('.id-text').textContent = 'Awaiting...';
        el.classList.remove('set');
      });

      // Build steps
      stepQueue = [
        {
          fn: async () => {
            activateStep(1);
            log('USER', 'Navigates to site');
            log('FIREBASE', 'Push UID to Datalayer');

            if (s.isReturn && s.deviceMatch) {
              setAnnotation(`<strong>Step 1: Page Load - SDK Init</strong><br>Firebase recognizes this device. Retrieving existing UID from storage.`);
              log('FIREBASE', '‚úì Device fingerprint found');
              log('FIREBASE', `Retrieved UID: ${uid.substring(0, 8)}...`);
              setId('displayUid', uid.substring(0, 20) + '...');
              await activateBox('box-sdk');
              completeStep(1);
            } else if (s.deviceMatch && s.crossBrand) {
              setAnnotation(`<strong>Step 1: Page Load - SDK Init</strong><br>‚ö†Ô∏è <span style="color:#f90">Device from ${s.previousBrand}!</span> Flagging as cross-brand visitor.`);
              log('FIREBASE', `‚ö†Ô∏è Device matches ${s.previousBrand}`);
              log('FIREBASE', `Generated UID: ${uid.substring(0, 8)}...`);
              setId('displayUid', uid.substring(0, 20) + '...');
              await activateBox('box-sdk', true);
              completeStep(1, true);
            } else if (s.deviceMatch) {
              setAnnotation(`<strong>Step 1: Page Load - SDK Init</strong><br>‚ö†Ô∏è <span style="color:#f90">Device match!</span> This device submitted before.`);
              log('FIREBASE', '‚ö†Ô∏è Device MATCH on this brand');
              log('FIREBASE', `UID: ${uid.substring(0, 8)}...`);
              setId('displayUid', uid.substring(0, 20) + '...');
              await activateBox('box-sdk', true);
              completeStep(1, true);
            } else {
              setAnnotation(`<strong>Step 1: Page Load - SDK Init</strong><br>New device detected. Generating fresh UID and storing fingerprint.`);
              log('FIREBASE', 'New device - no match');
              log('FIREBASE', `Generated UID: ${uid.substring(0, 8)}...`);
              setId('displayUid', uid.substring(0, 20) + '...');
              await activateBox('box-sdk');
              completeStep(1);
            }
            activateConnector('conn-1');
          }
        },
        {
          fn: async () => {
            activateStep(2);
            const visitDesc = s.isReturn ? 'returning to' : (s.crossBrand ? 'first visit to (came from ' + s.previousBrand + ')' : 'first ever visit to');
            setAnnotation(`<strong>Step 2: DataLayer Push</strong><br>User ${visitDesc} <strong>${brand}</strong>. <code>page_view</code> fires with UID attached.`);
            log('DATALAYER', `Push: page_view { brand: "${brand}", uid: "${uid.substring(0, 8)}..." }`);
            await activateBox('box-pageview', s.deviceMatch);
            completeStep(2, s.deviceMatch);
            activateConnector('conn-2');
          }
        },
        {
          fn: async () => {
            activateStep(3);
            setAnnotation(`<strong>Step 3: User Submits Form</strong><br>User submits lead form. <code>form_submit</code> event with UID attached.`);
            log('SITE', 'Form submitted');
            log('DATALAYER', `Push: form_submit { uid, email: "${email}" }`);
            await activateBox('box-form', s.deviceMatch);
            completeStep(3, s.deviceMatch);
            activateConnector('conn-3');
          }
        },
        {
          fn: async () => {
            activateStep(4);
            setAnnotation(`<strong>Step 4: NS Adapter</strong><br>Checking email and phone against NetSuite records.`);
            log('ADAPTER', 'Received lead data');

            const adapterWarning = s.emailMatch || s.phoneMatch;

            if (s.emailMatch) {
              log('ADAPTER', '‚ö†Ô∏è EMAIL MATCH in NetSuite');
            } else {
              log('ADAPTER', 'Email: no match');
            }

            if (s.phoneMatch) {
              log('ADAPTER', '‚ö†Ô∏è PHONE MATCH in NetSuite');
            } else {
              log('ADAPTER', 'Phone: no match');
            }

            if (adapterWarning) {
              const matchType = s.emailMatch && s.phoneMatch ? 'Email AND Phone' : (s.emailMatch ? 'Email' : 'Phone');
              setAnnotation(`<strong>Step 4: NS Adapter</strong><br>‚ö†Ô∏è <span style="color:#f90">${matchType} match!</span> Lead flagged for review.`);
            }

            await activateBox('box-adapter', adapterWarning);
            completeStep(4, adapterWarning);
            activateConnector('conn-4');
          }
        },
        {
          fn: async () => {
            activateStep(5);
            setAnnotation(`<strong>Step 5: NetSuite</strong><br>Creating lead record. UID ensures uniqueness.`);
            log('NETSUITE', 'Creating lead...');
            await new Promise(r => setTimeout(r, 200));

            setId('displayNsId', nsId);
            log('NETSUITE', `Lead created: ${nsId}`);

            if (hasDuplicate) {
              log('NETSUITE', '‚ö†Ô∏è Flagged for duplicate review');
            }

            log('DATALAYER', `Push: lead_created { nsId: "${nsId}" }`);
            await activateBox('box-netsuite', hasDuplicate);
            completeStep(5, hasDuplicate);
            activateConnector('conn-5');
          }
        },
        {
          fn: async () => {
            setAnnotation(`<strong>Step 6: Platform Sync</strong><br>NetSuite sends to Iterable and Amplitude simultaneously.`);
            log('NETSUITE', '‚Üí Webhook to Iterable');
            log('NETSUITE', '‚Üí Webhook to Amplitude');

            await activateBox('box-iterable');
            log('ITERABLE', 'Contact created');

            setId('displayAmpId', ampId);
            await activateBox('box-amplitude');
            log('AMPLITUDE', `Profile created: ${ampId}`);

            activateConnector('conn-6');
          }
        },
        {
          fn: async () => {
            activateStep(7);
            setAnnotation(`<strong>Step 7: Enrichment</strong><br>Amplitude sends enriched profile back for personalization.`);
            log('AMPLITUDE', '‚Üí Enrichment webhook');
            log('DATALAYER', 'Push: lead_enriched');
            await activateBox('box-enrich');
            completeStep(7);
          }
        }
      ];

      if (hasDuplicate) {
        stepQueue.push(
          {
            fn: async () => {
              document.getElementById('dup-section').classList.add('show');
              activateStep(8);
              const sources = [];
              if (s.deviceMatch) sources.push('Firebase');
              if (s.emailMatch) sources.push('Email');
              if (s.phoneMatch) sources.push('Phone');
              setAnnotation(`<strong>Step 8: Duplicate Event</strong><br>Amplitude receives <code>duplicate_detected</code>. Sources: ${sources.join(', ')}`);
              log('AMPLITUDE', `Event: duplicate_detected`);
              await activateBox('box-amp-event');
              completeStep(8);
              activateConnector('conn-8');
            }
          },
          {
            fn: async () => {
              activateStep(9);
              setAnnotation(`<strong>Step 9: Iterable Journey</strong><br>Triggering sales notification workflow.`);
              log('ITERABLE', 'Journey: "Duplicate Alert"');
              await activateBox('box-iterable-journey');
              completeStep(9);
              activateConnector('conn-9');
            }
          },
          {
            fn: async () => {
              activateStep(10);
              setAnnotation(`<strong>Step 10: Sales Alert</strong><br>Sales team receives email with duplicate details.`);
              log('SALES', 'Email sent: Duplicate Lead Alert');
              log('SALES', `New: ${name} <${email}>`);
              await activateBox('box-sales');
              completeStep(10);
            }
          }
        );
      }

      stepQueue.push({
        fn: async () => {
          updateProgress(totalSteps, totalSteps);
          log('SITE', '‚úì Flow complete');
          setAnnotation(hasDuplicate
            ? `<strong>Complete</strong><br>Lead created and sales notified of duplicate.`
            : `<strong>Complete</strong><br>New lead created and synced across all platforms.`
          );
          document.getElementById('runBtn').disabled = false;
        }
      });

      if (mode === 'auto') {
        for (const step of stepQueue) {
          await step.fn();
          await new Promise(r => setTimeout(r, getDelay() * 0.7));
        }
        stepQueue = [];
      } else {
        document.getElementById('nextBtn').disabled = false;
        executeStep(stepQueue.shift());
      }
    }

    function resetDemo() {
      stepQueue = [];
      currentStepNum = 0;
      updateProgress(0, 7);

      document.querySelectorAll('.step-number').forEach(el => el.classList.remove('active', 'done', 'warning'));
      document.querySelectorAll('.step-card, .branch-card').forEach(el => el.classList.remove('active', 'done', 'warning'));
      document.querySelectorAll('.connector').forEach(el => el.classList.remove('active', 'done'));
      document.getElementById('dup-section').classList.remove('show');

      ['displayUid', 'displayNsId', 'displayAmpId'].forEach(id => {
        const el = document.getElementById(id);
        el.querySelector('.id-text').textContent = 'Awaiting...';
        el.classList.remove('set');
      });

      document.getElementById('runBtn').disabled = false;
      document.getElementById('nextBtn').disabled = true;

      clearLog();
      setAnnotation('Select a scenario and click <strong>Run Flow</strong> to see the identity resolution process.', false);
      log('SITE', 'Demo reset');
    }

    document.addEventListener('keydown', e => {
      if (e.code === 'Space' && mode === 'manual' && !document.getElementById('nextBtn').disabled) {
        e.preventDefault();
        nextStep();
      }
      if (e.code === 'KeyR' && !e.metaKey && !e.ctrlKey) {
        resetDemo();
      }
    });

    window.onload = () => {
      log('SITE', 'System ready');
    };
  </script>
</body>
</html>
