<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CLG Identity Resolution - Lead Flow</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; }
    body {
      background: #0a0a0a;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 12px;
    }

    .app-layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      grid-template-rows: 1fr auto;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      background: #111;
      border-right: 1px solid #222;
      padding: 12px;
      overflow-y: auto;
      grid-row: 1 / 3;
    }
    .sidebar h1 { font-size: 12px; margin-bottom: 2px; }
    .sidebar-sub { font-size: 9px; color: #666; margin-bottom: 12px; }

    /* Presets */
    .presets {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
      margin-bottom: 10px;
    }
    .preset-btn {
      background: transparent;
      border: 1px solid #333;
      border-radius: 3px;
      padding: 6px 4px;
      text-align: center;
      cursor: pointer;
      font-size: 8px;
      font-weight: 600;
      color: #999;
    }
    .preset-btn:hover { border-color: #555; background: #1a1a1a; }
    .preset-btn.active { border-color: #fff; background: #1a1a1a; color: #fff; }

    /* Form */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-bottom: 10px;
    }
    .form-group label {
      display: block;
      font-size: 8px;
      color: #555;
      margin-bottom: 2px;
      text-transform: uppercase;
    }
    .form-group input, .form-group select {
      width: 100%;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 3px;
      color: #fff;
      padding: 5px 6px;
      font-size: 10px;
    }
    .form-group.full { grid-column: span 2; }

    /* Playback */
    .playback {
      background: #1a1a1a;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 10px;
    }
    .playback-row {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
    }
    .mode-toggle {
      display: flex;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 3px;
    }
    .mode-btn {
      padding: 4px 8px;
      font-size: 9px;
      font-weight: 600;
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
    }
    .mode-btn.active { background: #fff; color: #000; }
    .step-ind {
      flex: 1;
      text-align: center;
      font-size: 9px;
      color: #666;
      padding: 4px;
      background: #0a0a0a;
      border: 1px solid #222;
      border-radius: 3px;
    }
    .step-ind span { color: #fff; font-weight: 600; }
    .btn {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      background: #fff;
      color: #000;
    }
    .btn:disabled { background: #333; color: #666; }
    .btn-next {
      background: #1a3a1a;
      border: 1px solid #2a5a2a;
      color: #8f8;
      margin-top: 6px;
      display: none;
    }
    .btn-next.visible { display: block; }
    .btn-reset {
      background: transparent;
      border: 1px solid #333;
      color: #666;
      margin-top: 6px;
    }
    .kbd-hint {
      font-size: 8px;
      color: #444;
      text-align: center;
      margin-top: 6px;
      display: none;
    }
    .kbd-hint.visible { display: block; }

    /* Status/IDs inline */
    .status-ids {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .mini-box {
      background: #0a0a0a;
      border: 1px solid #222;
      border-radius: 3px;
      padding: 4px 6px;
      flex: 1;
      min-width: 45px;
    }
    .mini-label { font-size: 7px; color: #555; text-transform: uppercase; }
    .mini-value { font-size: 9px; color: #444; font-weight: 600; font-family: monospace; }
    .mini-value.ready { color: #fff; }
    .mini-value.active { color: #0f0; }
    .mini-value.done { color: #0f0; }
    .mini-value.warning { color: #f90; }

    /* Main Flow Panel */
    .main-panel {
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .flow-header {
      padding: 8px 16px;
      border-bottom: 1px solid #222;
      background: #111;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .flow-header h2 { font-size: 11px; }
    .flow-header-sub { font-size: 9px; color: #666; }

    /* Horizontal Flow */
    .flow-area {
      flex: 1;
      padding: 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .h-flow {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      flex-wrap: nowrap;
    }

    .h-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 70px;
      max-width: 90px;
    }
    .h-num {
      width: 20px;
      height: 20px;
      border: 2px solid #333;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 600;
      color: #444;
      margin-bottom: 4px;
    }
    .h-num.active { border-color: #fff; background: #fff; color: #000; }
    .h-num.done { border-color: #0f0; color: #0f0; }

    .h-box {
      border: 1px solid #222;
      border-radius: 4px;
      padding: 6px 8px;
      text-align: center;
      width: 100%;
      transition: all 0.2s;
    }
    .h-box.active { border-color: #fff; background: #1a1a1a; }
    .h-box.done { border-color: #333; }

    .h-icon { font-size: 14px; margin-bottom: 2px; }
    .h-name { font-size: 9px; font-weight: 600; white-space: nowrap; }
    .h-badge {
      font-size: 7px;
      padding: 1px 3px;
      border-radius: 2px;
      margin-top: 2px;
      display: inline-block;
    }
    .h-badge.dl { background: #0ff2; color: #0ff; }
    .h-badge.wh { background: #f0f2; color: #f0f; }

    .h-conn {
      width: 20px;
      height: 2px;
      background: #222;
      flex-shrink: 0;
    }
    .h-conn.active { background: #fff; }
    .h-conn.done { background: #444; }

    /* Branch */
    .h-branch {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .h-branch-row {
      display: flex;
      gap: 8px;
    }
    .h-branch-label {
      font-size: 7px;
      color: #555;
    }

    /* Duplicate flow row */
    .dup-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #222;
      display: none;
    }
    .dup-section.visible { display: block; }
    .dup-label {
      text-align: center;
      font-size: 8px;
      color: #f90;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Log Panel */
    .log-panel {
      border-top: 1px solid #222;
      background: #111;
      grid-column: 2;
    }
    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 12px;
      cursor: pointer;
    }
    .log-title { font-size: 8px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
    .log-container {
      height: 60px;
      overflow-y: auto;
      background: #0a0a0a;
      font-family: monospace;
      font-size: 8px;
    }
    .log-panel.collapsed .log-container { height: 0; }
    .log-entry {
      padding: 2px 8px;
      display: flex;
      gap: 6px;
      border-bottom: 1px solid #111;
    }
    .log-time { color: #333; width: 40px; }
    .log-src {
      width: 45px;
      padding: 0 3px;
      border-radius: 2px;
      text-align: center;
      font-size: 7px;
      font-weight: 600;
    }
    .log-src.site { background: #1a1a2e; color: #88f; }
    .log-src.sdk { background: #2e1a2a; color: #f8a; }
    .log-src.adapter { background: #1a2e1a; color: #8f8; }
    .log-src.netsuite { background: #2e1a1a; color: #f88; }
    .log-src.iterable { background: #2e1a2e; color: #f8f; }
    .log-src.amplitude { background: #2e2e1a; color: #ff8; }
    .log-src.sales { background: #2e2a1a; color: #fa8; }
    .log-src.datalayer { background: #1a2e2e; color: #8ff; }
    .log-msg { color: #777; flex: 1; }
    .clear-btn {
      background: transparent;
      border: 1px solid #333;
      color: #555;
      padding: 1px 5px;
      border-radius: 2px;
      font-size: 7px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <div class="sidebar">
      <h1>Identity Resolution POC</h1>
      <div class="sidebar-sub">Lead Flow Demo</div>

      <div class="presets">
        <button class="preset-btn active" onclick="loadPreset('new-user')" id="preset-new-user">New User</button>
        <button class="preset-btn" onclick="loadPreset('same-device')" id="preset-same-device">Same Device</button>
        <button class="preset-btn" onclick="loadPreset('same-email')" id="preset-same-email">Same Email</button>
        <button class="preset-btn" onclick="loadPreset('same-phone')" id="preset-same-phone">Same Phone</button>
        <button class="preset-btn" onclick="loadPreset('cross-brand')" id="preset-cross-brand">Cross-Brand</button>
        <button class="preset-btn" onclick="loadPreset('full-match')" id="preset-full-match">Duplicate</button>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>Brand</label>
          <select id="brand">
            <option value="access-hire">Access Hire</option>
            <option value="access-express">Access Express</option>
            <option value="clg">CLG</option>
          </select>
        </div>
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="name" value="New Lead">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="email" value="newlead@company.com">
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="phone" value="0400111222">
        </div>
        <div class="form-group full">
          <label>Device ID</label>
          <input type="text" id="deviceId" readonly style="color:#555;font-size:8px;">
        </div>
      </div>

      <div class="playback">
        <div class="playback-row">
          <div class="mode-toggle">
            <button class="mode-btn active" id="mode-auto" onclick="setMode('auto')">Auto</button>
            <button class="mode-btn" id="mode-manual" onclick="setMode('manual')">Manual</button>
          </div>
          <div class="step-ind" id="stepInd">Step <span>-</span> / <span>-</span></div>
        </div>
        <button class="btn" id="submitBtn" onclick="runFlow()">Submit Lead</button>
        <button class="btn btn-next" id="nextBtn" onclick="nextStep()">Next Step ‚Üí</button>
        <button class="btn btn-reset" onclick="resetDemo()">Reset</button>
        <div class="kbd-hint" id="kbdHint"><kbd>Space</kbd> or <kbd>‚Üí</kbd> next</div>
      </div>

      <div class="status-ids">
        <div class="mini-box"><div class="mini-label">Site</div><div class="mini-value ready" id="stat-site">Ready</div></div>
        <div class="mini-box"><div class="mini-label">Adapter</div><div class="mini-value" id="stat-adapter">‚Äî</div></div>
        <div class="mini-box"><div class="mini-label">NS</div><div class="mini-value" id="stat-netsuite">‚Äî</div></div>
        <div class="mini-box"><div class="mini-label">Iter</div><div class="mini-value" id="stat-iterable">‚Äî</div></div>
        <div class="mini-box"><div class="mini-label">Amp</div><div class="mini-value" id="stat-amplitude">‚Äî</div></div>
      </div>
      <div class="status-ids">
        <div class="mini-box"><div class="mini-label">UID</div><div class="mini-value" id="dispUid">‚Äî</div></div>
        <div class="mini-box"><div class="mini-label">NS ID</div><div class="mini-value" id="dispNsId">‚Äî</div></div>
        <div class="mini-box"><div class="mini-label">Amp ID</div><div class="mini-value" id="dispAmpId">‚Äî</div></div>
      </div>
    </div>

    <div class="main-panel">
      <div class="flow-header">
        <h2>Data Flow</h2>
        <div class="flow-header-sub">Site ‚Üí Adapter ‚Üí NetSuite ‚Üí Iterable + Amplitude</div>
      </div>
      <div class="flow-area">
        <!-- Main horizontal flow -->
        <div class="h-flow" id="mainFlow">
          <div class="h-step">
            <div class="h-num" id="n1">1</div>
            <div class="h-box" id="b1">
              <div class="h-icon">üìù</div>
              <div class="h-name">Form</div>
              <div class="h-badge dl">submit</div>
            </div>
          </div>
          <div class="h-conn" id="c1"></div>
          <div class="h-step">
            <div class="h-num" id="n2">2</div>
            <div class="h-box" id="b2">
              <div class="h-icon">‚ö°</div>
              <div class="h-name">Adapter</div>
            </div>
          </div>
          <div class="h-conn" id="c2"></div>
          <div class="h-step">
            <div class="h-num" id="n3">3</div>
            <div class="h-box" id="b3">
              <div class="h-icon">üè¢</div>
              <div class="h-name">NetSuite</div>
              <div class="h-badge dl">created</div>
            </div>
          </div>
          <div class="h-conn" id="c3"></div>
          <div class="h-branch">
            <div class="h-branch-label">parallel</div>
            <div class="h-branch-row">
              <div class="h-box" id="b-iter" style="min-width:60px;">
                <div class="h-icon">üìß</div>
                <div class="h-name">Iterable</div>
              </div>
              <div class="h-box" id="b-amp" style="min-width:60px;">
                <div class="h-icon">üìä</div>
                <div class="h-name">Amplitude</div>
              </div>
            </div>
          </div>
          <div class="h-conn" id="c4"></div>
          <div class="h-step">
            <div class="h-num" id="n4">4</div>
            <div class="h-box" id="b4">
              <div class="h-icon">üîî</div>
              <div class="h-name">Webhook</div>
              <div class="h-badge wh">back</div>
            </div>
          </div>
          <div class="h-conn" id="c5"></div>
          <div class="h-step">
            <div class="h-num" id="n5">5</div>
            <div class="h-box" id="b5">
              <div class="h-icon">‚ú®</div>
              <div class="h-name">Personalize</div>
              <div class="h-badge dl">enriched</div>
            </div>
          </div>
        </div>

        <!-- Duplicate detection flow -->
        <div class="dup-section" id="dupSection">
          <div class="dup-label">‚ö†Ô∏è Duplicate Detected</div>
          <div class="h-flow">
            <div class="h-step">
              <div class="h-num" id="n6">6</div>
              <div class="h-box" id="b6">
                <div class="h-icon">üìä</div>
                <div class="h-name">Amp Event</div>
                <div class="h-badge dl">dup_detect</div>
              </div>
            </div>
            <div class="h-conn" id="c6"></div>
            <div class="h-step">
              <div class="h-num" id="n7">7</div>
              <div class="h-box" id="b7">
                <div class="h-icon">üìß</div>
                <div class="h-name">Iterable</div>
                <div class="h-badge wh">journey</div>
              </div>
            </div>
            <div class="h-conn" id="c7"></div>
            <div class="h-step">
              <div class="h-num" id="n8">8</div>
              <div class="h-box" id="b8">
                <div class="h-icon">üë§</div>
                <div class="h-name">Sales Alert</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="log-panel" id="logPanel">
      <div class="log-header" onclick="toggleLog()">
        <span class="log-title">Event Log</span>
        <button class="clear-btn" onclick="event.stopPropagation();clearLog()">Clear</button>
      </div>
      <div class="log-container" id="logContainer"></div>
    </div>
  </div>

  <script>
    const existing = { email:'john.smith@acme.com.au', phone:'0412 345 678', name:'John Smith', deviceId:'DEV-EXISTING-ABC123' };
    const presets = {
      'new-user': { email:'sarah@newco.com', phone:'0498765432', name:'Sarah Jones', brand:'clg', deviceId:()=>'DEV-'+rnd(), matchType:'none' },
      'same-device': { email:'diff@other.com', phone:'0411222333', name:'Mystery', brand:'access-hire', deviceId:()=>existing.deviceId, matchType:'device' },
      'same-email': { email:existing.email, phone:'0499888777', name:'John S', brand:'access-express', deviceId:()=>'DEV-'+rnd(), matchType:'email' },
      'same-phone': { email:'j.smith@work.com', phone:existing.phone, name:'J Smith', brand:'clg', deviceId:()=>'DEV-'+rnd(), matchType:'phone' },
      'cross-brand': { email:existing.email, phone:existing.phone, name:existing.name, brand:'access-express', deviceId:()=>'DEV-'+rnd(), matchType:'cross-brand' },
      'full-match': { email:existing.email, phone:existing.phone, name:existing.name, brand:'access-hire', deviceId:()=>existing.deviceId, matchType:'duplicate' }
    };

    let preset='new-user', devId='', mode='auto', stepIdx=0, resolver=null, running=false, total=5;

    function rnd() { return Math.random().toString(36).substr(2,6).toUpperCase(); }
    function uuid() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;return(c==='x'?r:(r&0x3|0x8)).toString(16).toUpperCase();}); }

    function log(src, msg) {
      const el = document.getElementById('logContainer');
      const t = new Date().toLocaleTimeString('en-AU',{hour12:false});
      el.insertAdjacentHTML('afterbegin', `<div class="log-entry"><span class="log-time">${t}</span><span class="log-src ${src.toLowerCase()}">${src}</span><span class="log-msg">${msg}</span></div>`);
    }
    function clearLog() { document.getElementById('logContainer').innerHTML=''; }
    function toggleLog() { document.getElementById('logPanel').classList.toggle('collapsed'); }

    function stat(id,txt,cls='') { const e=document.getElementById('stat-'+id); e.textContent=txt; e.className='mini-value '+cls; }
    function updStep(c,t) { document.getElementById('stepInd').innerHTML=`Step <span>${c}</span> / <span>${t}</span>`; }

    function actNum(n) { document.getElementById('n'+n).classList.add('active'); }
    function doneNum(n) { const e=document.getElementById('n'+n); e.classList.remove('active'); e.classList.add('done'); }
    async function actBox(id) { const b=document.getElementById(id); b.classList.add('active'); return new Promise(r=>setTimeout(()=>{b.classList.remove('active');b.classList.add('done');r();},400)); }
    function actConn(id) { const c=document.getElementById(id); if(c){c.classList.add('active');setTimeout(()=>{c.classList.remove('active');c.classList.add('done');},200);} }

    function loadPreset(p) {
      preset = p;
      const d = presets[p];
      document.getElementById('email').value = d.email;
      document.getElementById('phone').value = d.phone;
      document.getElementById('name').value = d.name;
      document.getElementById('brand').value = d.brand;
      devId = typeof d.deviceId==='function' ? d.deviceId() : d.deviceId;
      document.getElementById('deviceId').value = devId;
      document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
      document.getElementById('preset-'+p).classList.add('active');
      total = d.matchType !== 'none' ? 8 : 5;
      updStep('-', total);
      clearLog();
      log('SITE', `Scenario: ${p.replace('-',' ')}`);
      log('SITE', 'Ready');
    }

    function setMode(m) {
      mode = m;
      document.getElementById('mode-auto').classList.toggle('active', m==='auto');
      document.getElementById('mode-manual').classList.toggle('active', m==='manual');
      document.getElementById('kbdHint').classList.toggle('visible', m==='manual');
    }

    function waitNext() {
      if (mode==='auto') return Promise.resolve();
      return new Promise(r => { resolver=r; document.getElementById('nextBtn').disabled=false; });
    }
    function nextStep() { if(resolver){document.getElementById('nextBtn').disabled=true;resolver();resolver=null;} }
    document.addEventListener('keydown', e => {
      if(!running||mode!=='manual') return;
      if(e.code==='Space'||e.code==='ArrowRight') { e.preventDefault(); nextStep(); }
    });

    async function runFlow() {
      const email=document.getElementById('email').value, name=document.getElementById('name').value;
      const brand=document.getElementById('brand').value, phone=document.getElementById('phone').value;
      const p=presets[preset], mt=p?p.matchType:'none', hasMatch=mt!=='none';
      const firebaseMatch = mt==='device'||mt==='duplicate';
      const adapterMatch = mt==='email'||mt==='phone'||mt==='cross-brand'||mt==='duplicate';
      const anyMatch = firebaseMatch || adapterMatch;

      running=true; total=hasMatch?8:5;
      const btn=document.getElementById('submitBtn'), nxt=document.getElementById('nextBtn');
      btn.disabled=true; btn.textContent='Running...';
      if(mode==='manual') nxt.classList.add('visible');

      // Reset
      document.querySelectorAll('.h-num').forEach(e=>e.classList.remove('active','done'));
      document.querySelectorAll('.h-box').forEach(e=>e.classList.remove('active','done'));
      document.querySelectorAll('.h-conn').forEach(e=>e.classList.remove('active','done'));
      document.getElementById('dupSection').classList.remove('visible');

      const uid=uuid(), nsId='NS-'+Math.floor(Math.random()*100000), ampId='AMP-'+uid.substr(0,8);

      // Step 1
      stepIdx=1; updStep(1,total); await waitNext();
      actNum(1); stat('site','Send','active');
      log('SDK','Generating UID');
      document.getElementById('dispUid').textContent=uid.substr(0,10)+'...';
      document.getElementById('dispUid').classList.add('done');
      if(firebaseMatch) { log('SDK','‚ö†Ô∏è Device match: '+devId); log('SDK','Adding dup flag'); }
      log('SITE','Form submitted on '+brand);
      log('DATALAYER','form_submit');
      await actBox('b1'); doneNum(1); stat('site','‚úì','done'); actConn('c1');

      // Step 2
      stepIdx=2; updStep(2,total); await waitNext();
      actNum(2); stat('adapter','Proc','active');
      log('ADAPTER','Received UID: '+uid.substr(0,8));
      if(firebaseMatch) log('ADAPTER','üìã Firebase dup flag');
      if(mode==='auto') await new Promise(r=>setTimeout(r,200));
      log('ADAPTER','Checking email/phone...');
      if(mt==='none') log('ADAPTER','‚úì No match');
      else if(mt==='device') log('ADAPTER','‚úì No email/phone (device only)');
      else if(mt==='email') log('ADAPTER','üîó Email match');
      else if(mt==='phone') log('ADAPTER','üîó Phone match');
      else if(mt==='cross-brand') log('ADAPTER','üîó Cross-brand');
      else if(mt==='duplicate') log('ADAPTER','‚ö†Ô∏è Full duplicate');
      await actBox('b2'); doneNum(2); stat('adapter','‚úì','done'); actConn('c2');

      // Step 3
      stepIdx=3; updStep(3,total); await waitNext();
      actNum(3); stat('netsuite','Create','active');
      log('NETSUITE','Creating lead...');
      if(mode==='auto') await new Promise(r=>setTimeout(r,200));
      document.getElementById('dispNsId').textContent=nsId;
      document.getElementById('dispNsId').classList.add('done');
      log('NETSUITE','Lead: '+nsId);
      if(firebaseMatch) { log('NETSUITE','üìã Dup alert in record'); log('NETSUITE','Device: '+devId); }
      if(anyMatch) { stat('netsuite','Alert','warning'); log('NETSUITE','‚ö†Ô∏è Dup indicator set'); }
      else stat('netsuite','‚úì','done');
      log('DATALAYER','lead_created');
      await actBox('b3'); doneNum(3); actConn('c3');

      // Branch
      stat('iterable','Sync','active'); log('NETSUITE','‚Üí Iterable');
      if(mode==='auto') await new Promise(r=>setTimeout(r,100));
      log('ITERABLE','Contact created');
      await actBox('b-iter'); stat('iterable','‚úì','done');
      stat('amplitude','Sync','active'); log('NETSUITE','‚Üí Amplitude');
      if(mode==='auto') await new Promise(r=>setTimeout(r,100));
      document.getElementById('dispAmpId').textContent=ampId;
      document.getElementById('dispAmpId').classList.add('done');
      log('AMPLITUDE','Profile: '+ampId);
      await actBox('b-amp'); stat('amplitude','‚úì','done');
      actConn('c4');

      // Step 4
      stepIdx=4; updStep(4,total); await waitNext();
      actNum(4);
      log('AMPLITUDE','‚Üí Webhook back');
      log('SITE','Received enriched data');
      await actBox('b4'); doneNum(4); actConn('c5');

      // Step 5
      stepIdx=5; updStep(5,total); await waitNext();
      actNum(5);
      log('DATALAYER','lead_enriched');
      log('SITE','Ready for personalization');
      await actBox('b5'); doneNum(5);

      // Duplicate flow
      if(anyMatch) {
        if(mode==='auto') await new Promise(r=>setTimeout(r,300));
        document.getElementById('dupSection').classList.add('visible');
        log('SITE','‚îÄ‚îÄ‚îÄ DUPLICATE FLOW ‚îÄ‚îÄ‚îÄ');
        if(firebaseMatch&&adapterMatch) log('SITE','Detected: Firebase + Adapter');
        else if(firebaseMatch) log('SITE','Detected: Firebase (device)');
        else log('SITE','Detected: Adapter (email/phone)');

        stepIdx=6; updStep(6,total); await waitNext();
        actNum(6);
        const src=firebaseMatch?'SDK':'ADAPTER';
        log(src,'‚Üí Push dup_detected to Amplitude');
        log('AMPLITUDE','Event: duplicate_detected');
        await actBox('b6'); doneNum(6); actConn('c6');
        if(mode==='auto') await new Promise(r=>setTimeout(r,200));

        stepIdx=7; updStep(7,total); await waitNext();
        actNum(7);
        log('AMPLITUDE','‚Üí Trigger Iterable journey');
        log('ITERABLE','Journey: Sales Dup Alert');
        if(firebaseMatch) log('ITERABLE','Reason: Device match');
        if(mt==='email') log('ITERABLE','Reason: Same email');
        if(mt==='phone') log('ITERABLE','Reason: Same phone');
        if(mt==='cross-brand') log('ITERABLE','Reason: Cross-brand');
        if(mt==='duplicate') log('ITERABLE','Reason: Full match');
        await actBox('b7'); doneNum(7); actConn('c7');

        stepIdx=8; updStep(8,total); await waitNext();
        actNum(8);
        log('ITERABLE','‚Üí Send alert');
        log('SALES','üìß "Potential Duplicate Lead"');
        log('SALES','New: '+name+' <'+email+'>');
        log('SALES','Match: '+existing.name+' <'+existing.email+'>');
        if(firebaseMatch) log('SALES','Device: '+devId);
        await actBox('b8'); doneNum(8);
      }

      log('SITE','‚úì Complete');
      updStep('‚úì',total);
      running=false;
      btn.disabled=false; btn.textContent='Submit Lead';
      nxt.classList.remove('visible');
    }

    function resetDemo() {
      document.querySelectorAll('.h-num').forEach(e=>e.classList.remove('active','done'));
      document.querySelectorAll('.h-box').forEach(e=>e.classList.remove('active','done'));
      document.querySelectorAll('.h-conn').forEach(e=>e.classList.remove('active','done'));
      document.getElementById('dupSection').classList.remove('visible');
      stat('site','Ready','ready'); stat('adapter','‚Äî',''); stat('netsuite','‚Äî','');
      stat('iterable','‚Äî',''); stat('amplitude','‚Äî','');
      document.getElementById('dispUid').textContent='‚Äî';
      document.getElementById('dispUid').classList.remove('done');
      document.getElementById('dispNsId').textContent='‚Äî';
      document.getElementById('dispNsId').classList.remove('done');
      document.getElementById('dispAmpId').textContent='‚Äî';
      document.getElementById('dispAmpId').classList.remove('done');
      clearLog();
      loadPreset(preset);
    }

    window.onload = () => loadPreset('new-user');
  </script>
</body>
</html>
