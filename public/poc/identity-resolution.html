<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CLG Identity Resolution - Lead Flow</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; }
    body {
      background: #0a0a0a;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 12px;
    }

    .app-layout {
      display: grid;
      grid-template-columns: 220px 1fr 200px;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      background: #111;
      border-right: 1px solid #222;
      padding: 10px;
      overflow-y: auto;
    }
    .sidebar h1 { font-size: 11px; margin-bottom: 2px; }
    .sidebar-sub { font-size: 9px; color: #666; margin-bottom: 10px; }

    .presets {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3px;
      margin-bottom: 8px;
    }
    .preset-btn {
      background: transparent;
      border: 1px solid #333;
      border-radius: 3px;
      padding: 5px 3px;
      text-align: center;
      cursor: pointer;
      font-size: 8px;
      font-weight: 600;
      color: #888;
    }
    .preset-btn:hover { border-color: #555; background: #1a1a1a; }
    .preset-btn.active { border-color: #fff; background: #1a1a1a; color: #fff; }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
      margin-bottom: 8px;
    }
    .form-group label {
      display: block;
      font-size: 7px;
      color: #555;
      margin-bottom: 1px;
      text-transform: uppercase;
    }
    .form-group input, .form-group select {
      width: 100%;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 2px;
      color: #fff;
      padding: 4px 5px;
      font-size: 9px;
    }
    .form-group.full { grid-column: span 2; }

    .playback {
      background: #1a1a1a;
      border-radius: 4px;
      padding: 6px;
      margin-bottom: 8px;
    }
    .playback-row {
      display: flex;
      gap: 4px;
      align-items: center;
      margin-bottom: 4px;
    }
    .mode-toggle {
      display: flex;
      background: #0a0a0a;
      border: 1px solid #333;
      border-radius: 2px;
    }
    .mode-btn {
      padding: 3px 6px;
      font-size: 8px;
      font-weight: 600;
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
    }
    .mode-btn.active { background: #fff; color: #000; }
    .step-ind {
      flex: 1;
      text-align: center;
      font-size: 8px;
      color: #666;
      padding: 3px;
      background: #0a0a0a;
      border: 1px solid #222;
      border-radius: 2px;
    }
    .step-ind span { color: #fff; font-weight: 600; }
    .btn {
      width: 100%;
      padding: 6px;
      border: none;
      border-radius: 2px;
      font-size: 9px;
      font-weight: 600;
      cursor: pointer;
      background: #fff;
      color: #000;
    }
    .btn:disabled { background: #333; color: #666; }
    .btn-next {
      background: #1a3a1a;
      border: 1px solid #2a5a2a;
      color: #8f8;
      margin-top: 4px;
      display: none;
    }
    .btn-next.visible { display: block; }
    .btn-reset {
      background: transparent;
      border: 1px solid #333;
      color: #666;
      margin-top: 4px;
    }
    .kbd-hint {
      font-size: 7px;
      color: #444;
      text-align: center;
      margin-top: 4px;
      display: none;
    }
    .kbd-hint.visible { display: block; }

    .status-row {
      display: flex;
      gap: 3px;
      margin-bottom: 6px;
    }
    .mini-box {
      background: #0a0a0a;
      border: 1px solid #222;
      border-radius: 2px;
      padding: 3px 4px;
      flex: 1;
      text-align: center;
    }
    .mini-label { font-size: 6px; color: #555; text-transform: uppercase; }
    .mini-value { font-size: 8px; color: #444; font-weight: 600; }
    .mini-value.ready { color: #fff; }
    .mini-value.active { color: #0f0; }
    .mini-value.done { color: #0f0; }
    .mini-value.warning { color: #f90; }

    /* Main Panel */
    .main-panel {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: #0a0a0a;
    }

    .flow-header {
      padding: 6px 12px;
      border-bottom: 1px solid #222;
      background: #111;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .flow-header h2 { font-size: 10px; }
    .flow-header-sub { font-size: 8px; color: #666; }

    /* Flow Area */
    .flow-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 12px;
      overflow: hidden;
    }

    .h-flow {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      gap: 0;
      width: 100%;
    }

    .h-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      max-width: 90px;
      min-width: 70px;
    }
    .h-num {
      width: 22px;
      height: 22px;
      border: 2px solid #333;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 600;
      color: #444;
      margin-bottom: 4px;
    }
    .h-num.active { border-color: #fff; background: #fff; color: #000; }
    .h-num.done { border-color: #0f0; color: #0f0; }

    .h-box {
      border: 1px solid #222;
      border-radius: 5px;
      padding: 8px 6px;
      text-align: center;
      width: 100%;
      transition: all 0.2s;
      min-height: 70px;
    }
    .h-box.active { border-color: #fff; background: #1a1a1a; box-shadow: 0 0 15px rgba(255,255,255,0.1); }
    .h-box.done { border-color: #333; }
    .h-box.warning { border-color: #f90; }

    .h-icon { font-size: 16px; margin-bottom: 3px; }
    .h-name { font-size: 9px; font-weight: 600; margin-bottom: 2px; }
    .h-sub { font-size: 7px; color: #666; }
    .h-badge {
      font-size: 6px;
      padding: 2px 3px;
      border-radius: 2px;
      margin-top: 3px;
      display: inline-block;
    }
    .h-badge.dl { background: #0ff2; color: #0ff; }
    .h-badge.wh { background: #f0f2; color: #f0f; }
    .h-badge.alert { background: #f902; color: #f90; }
    .h-badge.firebase { background: #f602; color: #f80; }

    .h-conn {
      width: 16px;
      height: 2px;
      background: #222;
      flex-shrink: 0;
      margin-top: 35px;
    }
    .h-conn.active { background: #fff; }
    .h-conn.done { background: #444; }

    /* Branch step */
    .h-branch-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      max-width: 120px;
    }
    .h-branch-row {
      display: flex;
      gap: 4px;
      width: 100%;
    }
    .h-branch-row .h-box {
      flex: 1;
      padding: 6px 4px;
      min-height: 60px;
    }
    .h-branch-row .h-icon { font-size: 14px; }
    .h-branch-row .h-name { font-size: 8px; }

    /* Duplicate flow */
    .dup-section {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid #333;
      display: none;
      width: 100%;
    }
    .dup-section.visible { display: block; }
    .dup-label {
      text-align: center;
      font-size: 8px;
      color: #f90;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Annotation Area */
    .annotation-area {
      padding: 10px 14px;
      border-top: 1px solid #222;
      background: #111;
      min-height: 55px;
    }
    .annotation-title {
      font-size: 8px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }
    .annotation-text {
      font-size: 10px;
      color: #fff;
      line-height: 1.3;
    }
    .annotation-detail {
      font-size: 8px;
      color: #888;
      margin-top: 3px;
      font-family: monospace;
    }

    /* Log Panel (right side) */
    .log-panel {
      background: #111;
      border-left: 1px solid #222;
      display: flex;
      flex-direction: column;
    }
    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      border-bottom: 1px solid #222;
    }
    .log-title { font-size: 9px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
    .log-container {
      flex: 1;
      overflow-y: auto;
      background: #0a0a0a;
      font-family: monospace;
      font-size: 8px;
    }
    .log-entry {
      padding: 3px 8px;
      border-bottom: 1px solid #111;
    }
    .log-time { color: #333; font-size: 7px; }
    .log-src {
      display: inline-block;
      padding: 1px 4px;
      border-radius: 2px;
      font-size: 7px;
      font-weight: 600;
      margin: 0 4px;
    }
    .log-src.site { background: #1a1a2e; color: #88f; }
    .log-src.firebase { background: #2e2a1a; color: #fa0; }
    .log-src.datalayer { background: #1a2e2e; color: #8ff; }
    .log-src.adapter { background: #1a2e1a; color: #8f8; }
    .log-src.netsuite { background: #2e1a1a; color: #f88; }
    .log-src.iterable { background: #2e1a2e; color: #f8f; }
    .log-src.amplitude { background: #2e2e1a; color: #ff8; }
    .log-src.sales { background: #2e2a1a; color: #fa8; }
    .log-msg { color: #666; }
    .clear-btn {
      background: transparent;
      border: 1px solid #333;
      color: #555;
      padding: 2px 6px;
      border-radius: 2px;
      font-size: 7px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <div class="sidebar">
      <h1>Identity Resolution POC</h1>
      <div class="sidebar-sub">Lead Flow Demo</div>

      <div class="presets">
        <button class="preset-btn active" onclick="loadPreset('new-user')" id="preset-new-user">New User</button>
        <button class="preset-btn" onclick="loadPreset('same-device')" id="preset-same-device">Same Device</button>
        <button class="preset-btn" onclick="loadPreset('same-email')" id="preset-same-email">Same Email</button>
        <button class="preset-btn" onclick="loadPreset('same-phone')" id="preset-same-phone">Same Phone</button>
        <button class="preset-btn" onclick="loadPreset('cross-brand')" id="preset-cross-brand">Cross-Brand</button>
        <button class="preset-btn" onclick="loadPreset('full-match')" id="preset-full-match">Duplicate</button>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label>Brand</label>
          <select id="brand">
            <option value="access-hire">Access Hire</option>
            <option value="access-express">Access Express</option>
            <option value="clg">CLG</option>
          </select>
        </div>
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="name" value="New Lead">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="email" value="newlead@company.com">
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" id="phone" value="0400111222">
        </div>
        <div class="form-group full">
          <label>Device ID</label>
          <input type="text" id="deviceId" readonly style="color:#555;font-size:7px;">
        </div>
      </div>

      <div class="playback">
        <div class="playback-row">
          <div class="mode-toggle">
            <button class="mode-btn active" id="mode-auto" onclick="setMode('auto')">Auto</button>
            <button class="mode-btn" id="mode-manual" onclick="setMode('manual')">Manual</button>
          </div>
          <div class="step-ind" id="stepInd">Step <span>-</span> / <span>-</span></div>
        </div>
        <button class="btn" id="submitBtn" onclick="runFlow()">Submit Lead</button>
        <button class="btn btn-next" id="nextBtn" onclick="nextStep()">Next Step ‚Üí</button>
        <button class="btn btn-reset" onclick="resetDemo()">Reset</button>
        <div class="kbd-hint" id="kbdHint"><kbd>Space</kbd> / <kbd>‚Üí</kbd></div>
      </div>

      <div class="status-row">
        <div class="mini-box"><div class="mini-label">Firebase</div><div class="mini-value" id="stat-firebase">‚Äî</div></div>
        <div class="mini-box"><div class="mini-label">Adapter</div><div class="mini-value" id="stat-adapter">‚Äî</div></div>
        <div class="mini-box"><div class="mini-label">NS</div><div class="mini-value" id="stat-netsuite">‚Äî</div></div>
      </div>
      <div class="status-row">
        <div class="mini-box"><div class="mini-label">Iter</div><div class="mini-value" id="stat-iterable">‚Äî</div></div>
        <div class="mini-box"><div class="mini-label">Amp</div><div class="mini-value" id="stat-amplitude">‚Äî</div></div>
      </div>
      <div class="status-row">
        <div class="mini-box"><div class="mini-label">UID</div><div class="mini-value" id="dispUid" style="font-size:7px;">‚Äî</div></div>
        <div class="mini-box"><div class="mini-label">NS ID</div><div class="mini-value" id="dispNsId">‚Äî</div></div>
      </div>
    </div>

    <div class="main-panel">
      <div class="flow-header">
        <h2>Lead Capture Flow</h2>
        <div class="flow-header-sub">Firebase ‚Üí DataLayer ‚Üí Adapter ‚Üí NetSuite ‚Üí Iterable + Amplitude</div>
      </div>

      <div class="flow-area">
        <div class="h-flow" id="mainFlow">
          <!-- Step 1: Firebase -->
          <div class="h-step">
            <div class="h-num" id="n1">1</div>
            <div class="h-box" id="b1">
              <div class="h-icon">üî•</div>
              <div class="h-name">Firebase</div>
              <div class="h-sub">Generate UID</div>
              <div class="h-badge firebase">SDK</div>
            </div>
          </div>
          <div class="h-conn" id="c1"></div>

          <!-- Step 2: Form + DataLayer -->
          <div class="h-step">
            <div class="h-num" id="n2">2</div>
            <div class="h-box" id="b2">
              <div class="h-icon">üìù</div>
              <div class="h-name">Form Submit</div>
              <div class="h-sub">Push to DataLayer</div>
              <div class="h-badge dl">form_submit</div>
            </div>
          </div>
          <div class="h-conn" id="c2"></div>

          <!-- Step 3: NS Adapter -->
          <div class="h-step">
            <div class="h-num" id="n3">3</div>
            <div class="h-box" id="b3">
              <div class="h-icon">‚ö°</div>
              <div class="h-name">NS Adapter</div>
              <div class="h-sub">Check duplicates</div>
            </div>
          </div>
          <div class="h-conn" id="c3"></div>

          <!-- Step 4: NetSuite -->
          <div class="h-step">
            <div class="h-num" id="n4">4</div>
            <div class="h-box" id="b4">
              <div class="h-icon">üè¢</div>
              <div class="h-name">NetSuite</div>
              <div class="h-sub">Create Lead</div>
              <div class="h-badge dl">lead_created</div>
            </div>
          </div>
          <div class="h-conn" id="c4"></div>

          <!-- Step 5: Parallel sync -->
          <div class="h-branch-step">
            <div class="h-num" id="n5">5</div>
            <div class="h-branch-row">
              <div class="h-box" id="b-iter">
                <div class="h-icon">üìß</div>
                <div class="h-name">Iterable</div>
              </div>
              <div class="h-box" id="b-amp">
                <div class="h-icon">üìä</div>
                <div class="h-name">Amplitude</div>
              </div>
            </div>
          </div>
          <div class="h-conn" id="c5"></div>

          <!-- Step 6: Webhook + Enrich -->
          <div class="h-step">
            <div class="h-num" id="n6">6</div>
            <div class="h-box" id="b6">
              <div class="h-icon">‚ú®</div>
              <div class="h-name">Enrich</div>
              <div class="h-sub">Webhook return</div>
              <div class="h-badge dl">lead_enriched</div>
            </div>
          </div>
        </div>

        <!-- Duplicate Detection Flow -->
        <div class="dup-section" id="dupSection">
          <div class="dup-label" id="dupLabel">‚ö†Ô∏è Duplicate Detection</div>
          <div class="h-flow">
            <div class="h-step">
              <div class="h-num" id="n7">7</div>
              <div class="h-box" id="b7">
                <div class="h-icon">üìä</div>
                <div class="h-name">Amplitude</div>
                <div class="h-sub">dup_detected event</div>
                <div class="h-badge alert">event</div>
              </div>
            </div>
            <div class="h-conn" id="c7"></div>
            <div class="h-step">
              <div class="h-num" id="n8">8</div>
              <div class="h-box" id="b8">
                <div class="h-icon">üìß</div>
                <div class="h-name">Iterable</div>
                <div class="h-sub">Trigger journey</div>
                <div class="h-badge wh">journey</div>
              </div>
            </div>
            <div class="h-conn" id="c8"></div>
            <div class="h-step">
              <div class="h-num" id="n9">9</div>
              <div class="h-box" id="b9">
                <div class="h-icon">üë§</div>
                <div class="h-name">Sales Alert</div>
                <div class="h-sub">Email notification</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="annotation-area">
        <div class="annotation-title">Current Step</div>
        <div class="annotation-text" id="annotationText">Select a scenario and click "Submit Lead" to begin.</div>
        <div class="annotation-detail" id="annotationDetail"></div>
      </div>
    </div>

    <div class="log-panel">
      <div class="log-header">
        <span class="log-title">Event Log</span>
        <button class="clear-btn" onclick="clearLog()">Clear</button>
      </div>
      <div class="log-container" id="logContainer"></div>
    </div>
  </div>

  <script>
    const existing = { email:'john.smith@acme.com.au', phone:'0412 345 678', name:'John Smith', deviceId:'DEV-EXISTING-ABC123' };
    const presets = {
      'new-user': { email:'sarah@newco.com', phone:'0498765432', name:'Sarah Jones', brand:'clg', deviceId:()=>'DEV-'+rnd(), matchType:'none', desc:'Brand new user - no matches anywhere' },
      'same-device': { email:'diff@other.com', phone:'0411222333', name:'Mystery', brand:'access-hire', deviceId:()=>existing.deviceId, matchType:'device', desc:'Firebase detects same device as existing customer' },
      'same-email': { email:existing.email, phone:'0499888777', name:'John S', brand:'access-express', deviceId:()=>'DEV-'+rnd(), matchType:'email', desc:'NS Adapter detects email match' },
      'same-phone': { email:'j.smith@work.com', phone:existing.phone, name:'J Smith', brand:'clg', deviceId:()=>'DEV-'+rnd(), matchType:'phone', desc:'NS Adapter detects phone match' },
      'cross-brand': { email:existing.email, phone:existing.phone, name:existing.name, brand:'access-express', deviceId:()=>'DEV-'+rnd(), matchType:'cross-brand', desc:'NS Adapter detects existing customer on different brand' },
      'full-match': { email:existing.email, phone:existing.phone, name:existing.name, brand:'access-hire', deviceId:()=>existing.deviceId, matchType:'duplicate', desc:'Both Firebase (device) AND NS Adapter (email/phone) detect match' }
    };

    let preset='new-user', devId='', mode='auto', stepIdx=0, resolver=null, running=false, total=6;

    function rnd() { return Math.random().toString(36).substr(2,6).toUpperCase(); }
    function uuid() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;return(c==='x'?r:(r&0x3|0x8)).toString(16).toUpperCase();}); }

    function log(src, msg) {
      const el = document.getElementById('logContainer');
      const t = new Date().toLocaleTimeString('en-AU',{hour12:false});
      el.insertAdjacentHTML('afterbegin', `<div class="log-entry"><span class="log-time">${t}</span><span class="log-src ${src.toLowerCase()}">${src}</span><span class="log-msg">${msg}</span></div>`);
    }
    function clearLog() { document.getElementById('logContainer').innerHTML=''; }

    function annotate(title, detail='') {
      document.getElementById('annotationText').textContent = title;
      document.getElementById('annotationDetail').textContent = detail;
    }

    function stat(id,txt,cls='') { const e=document.getElementById('stat-'+id); e.textContent=txt; e.className='mini-value '+cls; }
    function updStep(c,t) { document.getElementById('stepInd').innerHTML=`Step <span>${c}</span> / <span>${t}</span>`; }

    function actNum(n) { document.getElementById('n'+n).classList.add('active'); }
    function doneNum(n) { const e=document.getElementById('n'+n); e.classList.remove('active'); e.classList.add('done'); }
    async function actBox(id) { const b=document.getElementById(id); b.classList.add('active'); return new Promise(r=>setTimeout(()=>{b.classList.remove('active');b.classList.add('done');r();},350)); }
    function warnBox(id) { document.getElementById(id).classList.add('warning'); }
    function actConn(id) { const c=document.getElementById(id); if(c){c.classList.add('active');setTimeout(()=>{c.classList.remove('active');c.classList.add('done');},150);} }

    function loadPreset(p) {
      preset = p;
      const d = presets[p];
      document.getElementById('email').value = d.email;
      document.getElementById('phone').value = d.phone;
      document.getElementById('name').value = d.name;
      document.getElementById('brand').value = d.brand;
      devId = typeof d.deviceId==='function' ? d.deviceId() : d.deviceId;
      document.getElementById('deviceId').value = devId;
      document.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
      document.getElementById('preset-'+p).classList.add('active');
      total = d.matchType !== 'none' ? 9 : 6;
      updStep('-', total);
      clearLog();
      annotate(d.desc);
      log('SITE', `Scenario: ${p.replace(/-/g,' ')}`);
    }

    function setMode(m) {
      mode = m;
      document.getElementById('mode-auto').classList.toggle('active', m==='auto');
      document.getElementById('mode-manual').classList.toggle('active', m==='manual');
      document.getElementById('kbdHint').classList.toggle('visible', m==='manual');
    }

    function waitNext() {
      if (mode==='auto') return Promise.resolve();
      return new Promise(r => { resolver=r; document.getElementById('nextBtn').disabled=false; });
    }
    function nextStep() { if(resolver){document.getElementById('nextBtn').disabled=true;resolver();resolver=null;} }
    document.addEventListener('keydown', e => {
      if(!running||mode!=='manual') return;
      if(e.code==='Space'||e.code==='ArrowRight') { e.preventDefault(); nextStep(); }
    });

    async function runFlow() {
      const email=document.getElementById('email').value, name=document.getElementById('name').value;
      const brand=document.getElementById('brand').value, phone=document.getElementById('phone').value;
      const p=presets[preset], mt=p?p.matchType:'none', hasMatch=mt!=='none';
      const firebaseMatch = mt==='device'||mt==='duplicate';
      const adapterMatch = mt==='email'||mt==='phone'||mt==='cross-brand'||mt==='duplicate';
      const anyMatch = firebaseMatch || adapterMatch;

      running=true; total=hasMatch?9:6;
      const btn=document.getElementById('submitBtn'), nxt=document.getElementById('nextBtn');
      btn.disabled=true; btn.textContent='Running...';
      if(mode==='manual') nxt.classList.add('visible');

      // Reset UI
      document.querySelectorAll('.h-num').forEach(e=>e.classList.remove('active','done'));
      document.querySelectorAll('.h-box').forEach(e=>e.classList.remove('active','done','warning'));
      document.querySelectorAll('.h-conn').forEach(e=>e.classList.remove('active','done'));
      document.getElementById('dupSection').classList.remove('visible');
      stat('firebase','‚Äî',''); stat('adapter','‚Äî',''); stat('netsuite','‚Äî','');
      stat('iterable','‚Äî',''); stat('amplitude','‚Äî','');

      const uid=uuid(), nsId='NS-'+Math.floor(Math.random()*100000), ampId='AMP-'+uid.substr(0,8);

      // ========== STEP 1: Firebase SDK ==========
      stepIdx=1; updStep(1,total); await waitNext();
      actNum(1); stat('firebase','Init','active');
      annotate('Step 1: Firebase SDK Initialization', 'Firebase generates unique identifier (UID) and checks device ID against existing records');
      log('FIREBASE','Initializing SDK...');
      log('FIREBASE','Generating UID: '+uid.substr(0,12)+'...');
      document.getElementById('dispUid').textContent=uid.substr(0,12)+'...';
      document.getElementById('dispUid').classList.add('done');

      if(firebaseMatch) {
        log('FIREBASE','Checking device ID: '+devId);
        log('FIREBASE','‚ö†Ô∏è DEVICE MATCH FOUND!');
        log('FIREBASE','Matched to existing customer record');
        annotate('Step 1: Firebase SDK - DUPLICATE DETECTED', 'Device ID matches existing customer! Adding duplicate_alert flag to payload.');
        stat('firebase','DUP!','warning');
        warnBox('b1');
      } else {
        log('FIREBASE','Device ID: '+devId+' (new device)');
        stat('firebase','‚úì','done');
      }
      await actBox('b1'); doneNum(1); actConn('c1');

      // ========== STEP 2: Form Submit + DataLayer ==========
      stepIdx=2; updStep(2,total); await waitNext();
      actNum(2);
      annotate('Step 2: Form Submission', 'User submits form. Data pushed to DataLayer with UID'+(firebaseMatch?' and duplicate_alert flag':''));
      log('SITE','User clicks Submit on '+brand);
      log('SITE','Collecting form data: '+name+', '+email+', '+phone);
      if(mode==='auto') await new Promise(r=>setTimeout(r,150));

      const dlPayload = firebaseMatch
        ? '{ uid, email, phone, brand, duplicate_alert: true, matched_device: "'+devId+'" }'
        : '{ uid, email, phone, brand }';
      log('DATALAYER','push: form_submit '+dlPayload);
      log('SITE','‚Üí Sending to NS Adapter API endpoint');
      await actBox('b2'); doneNum(2); actConn('c2');

      // ========== STEP 3: NS Adapter ==========
      stepIdx=3; updStep(3,total); await waitNext();
      actNum(3); stat('adapter','Proc','active');
      annotate('Step 3: NS Adapter Processing', 'Receives data from DataLayer. Checks email/phone against NetSuite for existing matches.');
      log('ADAPTER','Received payload from DataLayer');
      log('ADAPTER','UID: '+uid.substr(0,8)+'...');
      if(firebaseMatch) {
        log('ADAPTER','üìã Firebase already flagged duplicate_alert=true');
      }
      if(mode==='auto') await new Promise(r=>setTimeout(r,200));
      log('ADAPTER','Checking email against NetSuite...');
      log('ADAPTER','Checking phone against NetSuite...');

      if(mt==='none') {
        log('ADAPTER','‚úì No email match');
        log('ADAPTER','‚úì No phone match');
        log('ADAPTER','Result: NEW LEAD');
        stat('adapter','‚úì','done');
        annotate('Step 3: NS Adapter - No Match', 'No duplicates found. Creating new lead in NetSuite.');
      }
      else if(mt==='device') {
        log('ADAPTER','‚úì No email match');
        log('ADAPTER','‚úì No phone match');
        log('ADAPTER','Note: Firebase flagged device match (will include in NS record)');
        stat('adapter','‚úì','done');
        annotate('Step 3: NS Adapter - Device Only', 'No email/phone match, but Firebase detected device match. Passing flag to NetSuite.');
      }
      else if(mt==='email') {
        log('ADAPTER','‚ö†Ô∏è EMAIL MATCH: '+existing.email);
        log('ADAPTER','Matched to: '+existing.name+' (existing customer)');
        stat('adapter','DUP!','warning');
        warnBox('b3');
        annotate('Step 3: NS Adapter - EMAIL DUPLICATE', 'Email matches existing customer: '+existing.name+' <'+existing.email+'>');
      }
      else if(mt==='phone') {
        log('ADAPTER','‚ö†Ô∏è PHONE MATCH: '+existing.phone);
        log('ADAPTER','Matched to: '+existing.name+' (existing customer)');
        stat('adapter','DUP!','warning');
        warnBox('b3');
        annotate('Step 3: NS Adapter - PHONE DUPLICATE', 'Phone matches existing customer: '+existing.name+' ('+existing.phone+')');
      }
      else if(mt==='cross-brand') {
        log('ADAPTER','‚ö†Ô∏è CROSS-BRAND MATCH');
        log('ADAPTER','Email: '+existing.email+' exists on Access Hire');
        log('ADAPTER','Same customer visiting different brand');
        stat('adapter','X-Brand','warning');
        warnBox('b3');
        annotate('Step 3: NS Adapter - CROSS-BRAND', 'Existing Access Hire customer visiting Access Express');
      }
      else if(mt==='duplicate') {
        log('ADAPTER','‚ö†Ô∏è FULL DUPLICATE DETECTED');
        log('ADAPTER','Email match: '+existing.email);
        log('ADAPTER','Phone match: '+existing.phone);
        log('ADAPTER','+ Firebase device match');
        stat('adapter','DUP!','warning');
        warnBox('b3');
        annotate('Step 3: NS Adapter - FULL DUPLICATE', 'Both Firebase (device) AND Adapter (email+phone) detected match!');
      }
      await actBox('b3'); doneNum(3); actConn('c3');

      // ========== STEP 4: NetSuite Lead Creation ==========
      stepIdx=4; updStep(4,total); await waitNext();
      actNum(4); stat('netsuite','Create','active');
      annotate('Step 4: NetSuite Lead Creation', 'Creating lead record. UID ensures record is created even if duplicate (for tracking).');
      log('NETSUITE','Creating lead record...');
      if(mode==='auto') await new Promise(r=>setTimeout(r,200));
      document.getElementById('dispNsId').textContent=nsId;
      document.getElementById('dispNsId').classList.add('done');
      log('NETSUITE','Lead created: '+nsId);

      if(firebaseMatch) {
        log('NETSUITE','üìã Record includes: Duplicate Alert (Firebase device match)');
        log('NETSUITE','üìã Matched device ID: '+devId);
      }
      if(adapterMatch) {
        log('NETSUITE','üìã Record includes: Duplicate Alert (Adapter match)');
        if(mt==='email'||mt==='duplicate') log('NETSUITE','üìã Matched email: '+existing.email);
        if(mt==='phone'||mt==='duplicate') log('NETSUITE','üìã Matched phone: '+existing.phone);
        if(mt==='cross-brand') log('NETSUITE','üìã Cross-brand: Access Hire customer');
      }

      if(anyMatch) {
        stat('netsuite','Alert','warning');
        warnBox('b4');
        log('NETSUITE','‚ö†Ô∏è DUPLICATE INDICATOR set on lead record');
        log('NETSUITE','Sales will see alert when viewing this lead');
      } else {
        stat('netsuite','‚úì','done');
      }
      log('DATALAYER','push: lead_created { nsId: "'+nsId+'" }');
      await actBox('b4'); doneNum(4); actConn('c4');

      // ========== STEP 5: Parallel Sync ==========
      stepIdx=5; updStep(5,total); await waitNext();
      actNum(5);
      annotate('Step 5: Parallel Sync to Marketing + Analytics', 'NetSuite sends lead data to Iterable (marketing) and Amplitude (analytics)');
      stat('iterable','Sync','active');
      stat('amplitude','Sync','active');
      log('NETSUITE','‚Üí Sending to Iterable');
      log('NETSUITE','‚Üí Sending to Amplitude');
      if(mode==='auto') await new Promise(r=>setTimeout(r,150));
      log('ITERABLE','Contact created');
      log('ITERABLE','Added to Welcome Journey');
      await actBox('b-iter'); stat('iterable','‚úì','done');
      if(mode==='auto') await new Promise(r=>setTimeout(r,100));
      log('AMPLITUDE','User profile created: '+ampId);
      log('AMPLITUDE','Properties: { nsId, email, brand, leadSource }');
      await actBox('b-amp'); stat('amplitude','‚úì','done');
      doneNum(5); actConn('c5');

      // ========== STEP 6: Webhook + Enrichment ==========
      stepIdx=6; updStep(6,total); await waitNext();
      actNum(6);
      annotate('Step 6: Enrichment via Webhook', 'Amplitude sends enriched data back to site. DataLayer updated for personalization.');
      log('AMPLITUDE','‚Üí Webhook: Sending enriched profile back');
      log('SITE','Received enriched data from Amplitude');
      if(mode==='auto') await new Promise(r=>setTimeout(r,100));
      log('DATALAYER','push: lead_enriched { segment, interests, predictedValue, nsId }');
      log('SITE','DataLayer updated - ready for personalization');
      await actBox('b6'); doneNum(6);

      // ========== DUPLICATE DETECTION FLOW ==========
      if(anyMatch) {
        if(mode==='auto') await new Promise(r=>setTimeout(r,300));
        document.getElementById('dupSection').classList.add('visible');

        // Update label based on detection source
        let dupSource = '';
        if(firebaseMatch && adapterMatch) dupSource = 'Detected by: Firebase (device) + NS Adapter (email/phone)';
        else if(firebaseMatch) dupSource = 'Detected by: Firebase SDK (device match)';
        else dupSource = 'Detected by: NS Adapter ('+mt+' match)';
        document.getElementById('dupLabel').textContent = '‚ö†Ô∏è '+dupSource;

        log('SITE','‚ïê‚ïê‚ïê DUPLICATE ALERT FLOW ‚ïê‚ïê‚ïê');
        log('SITE', dupSource);

        // Step 7: Push to Amplitude
        stepIdx=7; updStep(7,total); await waitNext();
        actNum(7);
        const eventSource = firebaseMatch ? 'Firebase' : 'NS Adapter';
        annotate('Step 7: Duplicate Event to Amplitude', eventSource+' pushes duplicate_detected event to Amplitude');
        log(firebaseMatch?'FIREBASE':'ADAPTER','‚Üí Pushing duplicate_detected event');
        log('AMPLITUDE','Event: duplicate_detected');
        log('AMPLITUDE','{ matchType: "'+mt+'", source: "'+eventSource+'", newLead: "'+nsId+'" }');
        await actBox('b7'); doneNum(7); actConn('c7');
        if(mode==='auto') await new Promise(r=>setTimeout(r,200));

        // Step 8: Iterable Journey
        stepIdx=8; updStep(8,total); await waitNext();
        actNum(8);
        annotate('Step 8: Iterable Journey Triggered', 'Amplitude event triggers Sales Duplicate Alert journey in Iterable');
        log('AMPLITUDE','‚Üí Triggering Iterable journey');
        log('ITERABLE','Journey triggered: Sales Duplicate Alert');
        if(firebaseMatch) log('ITERABLE','Include: Device match details');
        if(mt==='email'||mt==='duplicate'||mt==='cross-brand') log('ITERABLE','Include: Email match ('+existing.email+')');
        if(mt==='phone'||mt==='duplicate') log('ITERABLE','Include: Phone match ('+existing.phone+')');
        await actBox('b8'); doneNum(8); actConn('c8');

        // Step 9: Sales Alert
        stepIdx=9; updStep(9,total); await waitNext();
        actNum(9);
        annotate('Step 9: Sales Team Notified', 'Sales receives email with duplicate details for review and potential merge');
        log('ITERABLE','‚Üí Sending alert email');
        log('SALES','üìß "Potential Duplicate Lead Detected"');
        log('SALES','New Lead: '+name+' <'+email+'>');
        log('SALES','Potential Match: '+existing.name+' <'+existing.email+'>');
        if(firebaseMatch) log('SALES','Device Match: '+devId);
        log('SALES','NetSuite ID: '+nsId);
        log('SALES','Action: Review and merge if appropriate');
        await actBox('b9'); doneNum(9);
      }

      // Complete
      log('SITE','‚úì Flow complete');
      annotate('Flow Complete', anyMatch
        ? 'Lead created with duplicate alert. Sales team notified for review.'
        : 'New lead created and synced across all systems.');
      updStep('‚úì',total);
      running=false;
      btn.disabled=false; btn.textContent='Submit Lead';
      nxt.classList.remove('visible');
    }

    function resetDemo() {
      document.querySelectorAll('.h-num').forEach(e=>e.classList.remove('active','done'));
      document.querySelectorAll('.h-box').forEach(e=>e.classList.remove('active','done','warning'));
      document.querySelectorAll('.h-conn').forEach(e=>e.classList.remove('active','done'));
      document.getElementById('dupSection').classList.remove('visible');
      stat('firebase','‚Äî',''); stat('adapter','‚Äî',''); stat('netsuite','‚Äî','');
      stat('iterable','‚Äî',''); stat('amplitude','‚Äî','');
      document.getElementById('dispUid').textContent='‚Äî';
      document.getElementById('dispUid').classList.remove('done');
      document.getElementById('dispNsId').textContent='‚Äî';
      document.getElementById('dispNsId').classList.remove('done');
      clearLog();
      loadPreset(preset);
    }

    window.onload = () => loadPreset('new-user');
  </script>
</body>
</html>
