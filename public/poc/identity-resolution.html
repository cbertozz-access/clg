<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lead Flow Architecture</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #000;
      color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    
    header {
      border: 1px solid #fff;
      padding: 15px 20px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { font-size: 16px; font-weight: normal; }
    
    .main-layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 20px;
    }
    
    .panel {
      border: 1px solid #fff;
      padding: 15px;
      margin-bottom: 15px;
    }
    .panel-title {
      font-size: 11px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #333;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    /* Form styles */
    .form-group { margin-bottom: 12px; }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-size: 11px;
      color: #888;
    }
    .form-group input, .form-group select {
      width: 100%;
      background: #000;
      border: 1px solid #fff;
      color: #fff;
      padding: 8px;
      font-family: inherit;
      font-size: 12px;
    }
    .btn {
      background: #fff;
      color: #000;
      border: none;
      padding: 12px;
      font-family: inherit;
      font-size: 13px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }
    .btn:disabled { background: #333; color: #666; }
    .btn-outline {
      background: #000;
      color: #666;
      border: 1px solid #333;
    }
    .btn-outline:hover { border-color: #fff; color: #fff; }
    
    /* Flow diagram */
    .flow-container {
      padding: 20px;
    }
    
    .flow-row {
      display: flex;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .flow-stage {
      text-align: center;
      flex-shrink: 0;
    }
    
    .flow-stage-label {
      font-size: 9px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    
    .flow-box {
      border: 2px solid #333;
      padding: 15px 20px;
      min-width: 140px;
      text-align: center;
      transition: all 0.3s;
    }
    .flow-box.active {
      border-color: #fff;
      background: #fff;
      color: #000;
    }
    .flow-box.complete {
      border-color: #fff;
    }
    .flow-box-title {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .flow-box-sub {
      font-size: 10px;
      color: #888;
    }
    .flow-box.active .flow-box-sub { color: #666; }
    
    .flow-arrow {
      flex-grow: 1;
      height: 2px;
      background: #333;
      margin: 0 10px;
      position: relative;
      min-width: 40px;
    }
    .flow-arrow.active { background: #fff; }
    .flow-arrow::after {
      content: 'â†’';
      position: absolute;
      right: -5px;
      top: -10px;
      color: #333;
    }
    .flow-arrow.active::after { color: #fff; }
    
    .flow-arrow-down {
      width: 2px;
      height: 40px;
      background: #333;
      margin: 10px auto;
    }
    .flow-arrow-down.active { background: #fff; }
    
    .flow-branch {
      display: flex;
      justify-content: center;
      gap: 60px;
      margin-top: 20px;
    }
    
    .flow-branch-line {
      position: relative;
    }
    .flow-branch-line::before {
      content: '';
      position: absolute;
      top: -20px;
      left: 50%;
      width: 200px;
      height: 2px;
      background: #333;
      transform: translateX(-50%);
    }
    
    /* Manual action box */
    .manual-action {
      border: 2px dashed #666;
      padding: 15px 20px;
      text-align: center;
      margin: 20px auto;
      max-width: 300px;
    }
    .manual-action.active {
      border-color: #fff;
      border-style: solid;
    }
    .manual-action-label {
      font-size: 9px;
      color: #f90;
      margin-bottom: 5px;
    }
    
    /* Info boxes */
    .info-box {
      background: #111;
      border: 1px solid #333;
      padding: 10px;
      margin-top: 10px;
      font-size: 11px;
    }
    .info-box.highlight { border-color: #fff; }
    .info-label {
      font-size: 9px;
      color: #666;
      margin-bottom: 5px;
    }
    
    /* Event log */
    .event-log {
      background: #111;
      padding: 10px;
      height: 250px;
      overflow-y: auto;
      font-size: 11px;
    }
    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid #1a1a1a;
      display: flex;
      gap: 10px;
    }
    .log-time { color: #444; width: 55px; flex-shrink: 0; }
    .log-source {
      width: 80px;
      flex-shrink: 0;
      font-size: 9px;
      text-align: center;
      padding: 2px 4px;
      border: 1px solid #333;
    }
    .log-source.site { border-color: #fff; }
    .log-source.adapter { border-color: #0af; color: #0af; }
    .log-source.netsuite { border-color: #0f0; color: #0f0; }
    .log-source.iterable { border-color: #f0f; color: #f0f; }
    .log-source.amplitude { border-color: #ff0; color: #ff0; }
    .log-source.sales { border-color: #f90; color: #f90; }
    .log-source.datalayer { border-color: #0ff; color: #0ff; }
    
    .clear-btn {
      float: right;
      background: transparent;
      border: 1px solid #333;
      color: #666;
      padding: 3px 8px;
      font-size: 10px;
      cursor: pointer;
    }
    .clear-btn:hover { border-color: #fff; color: #fff; }
    
    /* Status panel */
    .status-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #222;
      font-size: 11px;
    }
    .status-label { color: #888; }
    .status-value { color: #fff; }
    .status-value.waiting { color: #444; }
    .status-value.processing { color: #fff; animation: blink 0.5s infinite; }
    @keyframes blink { 50% { opacity: 0.3; } }
    
    /* Duplicate indicator */
    .dup-badge {
      display: inline-block;
      background: #f90;
      color: #000;
      padding: 2px 8px;
      font-size: 10px;
      margin-left: 10px;
    }
    
    .section-divider {
      border-top: 1px dashed #333;
      margin: 30px 0;
      position: relative;
    }
    .section-divider span {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      background: #000;
      padding: 0 15px;
      font-size: 10px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>â–  LEAD FLOW ARCHITECTURE</h1>
      <div style="font-size: 11px; color: #888;">
        Site â†’ Adapter â†’ NetSuite â†’ Iterable / Amplitude
      </div>
    </header>
    
    <div class="main-layout">
      <!-- Left Panel: Controls -->
      <div class="left-panel">
        <div class="panel">
          <div class="panel-title">â–  Simulate Lead</div>
          
          <div class="form-group">
            <label>Scenario</label>
            <select id="scenario" onchange="loadScenario()">
              <option value="new">New Lead (no duplicate)</option>
              <option value="duplicate">Duplicate Lead (needs merge)</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Brand/Site</label>
            <select id="brand">
              <option value="access-hire">Access Hire</option>
              <option value="access-express">Access Express</option>
              <option value="clg">CLG Landing Page</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="email" value="newlead@company.com">
          </div>
          
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="phone" value="0400111222">
          </div>
          
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="name" value="New Lead">
          </div>
          
          <button class="btn" id="submitBtn" onclick="runFlow()">
            SUBMIT LEAD
          </button>
          
          <button class="btn btn-outline" onclick="resetDemo()">
            RESET
          </button>
        </div>
        
        <div class="panel">
          <div class="panel-title">â–  System Status</div>
          <div class="status-item">
            <span class="status-label">Website/Form</span>
            <span class="status-value" id="stat-site">Ready</span>
          </div>
          <div class="status-item">
            <span class="status-label">NS Adapter</span>
            <span class="status-value waiting" id="stat-adapter">Waiting</span>
          </div>
          <div class="status-item">
            <span class="status-label">NetSuite</span>
            <span class="status-value waiting" id="stat-netsuite">Waiting</span>
          </div>
          <div class="status-item">
            <span class="status-label">Iterable</span>
            <span class="status-value waiting" id="stat-iterable">Waiting</span>
          </div>
          <div class="status-item">
            <span class="status-label">Amplitude</span>
            <span class="status-value waiting" id="stat-amplitude">Waiting</span>
          </div>
        </div>
        
        <div class="panel">
          <div class="panel-title">â–  IDs Generated</div>
          <div class="info-box">
            <div class="info-label">Frontend UID (for NetSuite)</div>
            <div id="displayUid">-</div>
          </div>
          <div class="info-box">
            <div class="info-label">Master Lead ID (Firebase)</div>
            <div id="displayMaster">-</div>
          </div>
          <div class="info-box">
            <div class="info-label">NetSuite Lead ID</div>
            <div id="displayNsId">-</div>
          </div>
        </div>
      </div>
      
      <!-- Right Panel: Flow Diagram -->
      <div class="right-panel">
        <div class="panel">
          <div class="panel-title">â–  Data Flow</div>
          
          <div class="flow-container">
            <!-- Row 1: Form Submission -->
            <div class="flow-row">
              <div class="flow-stage">
                <div class="flow-stage-label">1. User Action</div>
                <div class="flow-box" id="box-form">
                  <div class="flow-box-title">FORM</div>
                  <div class="flow-box-sub">Website/CLG</div>
                </div>
              </div>
              
              <div class="flow-arrow" id="arrow-1"></div>
              
              <div class="flow-stage">
                <div class="flow-stage-label">2. Generate UID</div>
                <div class="flow-box" id="box-firebase">
                  <div class="flow-box-title">FIREBASE</div>
                  <div class="flow-box-sub">Dedupe + UID</div>
                </div>
              </div>
              
              <div class="flow-arrow" id="arrow-2"></div>
              
              <div class="flow-stage">
                <div class="flow-stage-label">3. Transform</div>
                <div class="flow-box" id="box-adapter">
                  <div class="flow-box-title">NS ADAPTER</div>
                  <div class="flow-box-sub">API Gateway</div>
                </div>
              </div>
              
              <div class="flow-arrow" id="arrow-3"></div>
              
              <div class="flow-stage">
                <div class="flow-stage-label">4. Create Lead</div>
                <div class="flow-box" id="box-netsuite">
                  <div class="flow-box-title">NETSUITE</div>
                  <div class="flow-box-sub">CRM</div>
                </div>
              </div>
            </div>
            
            <!-- Branch to Iterable and Amplitude -->
            <div style="text-align: center; margin: 20px 0;">
              <div style="color: #666; font-size: 10px; margin-bottom: 10px;">NetSuite sends to both systems</div>
              <div style="display: flex; justify-content: center; gap: 100px;">
                <div>
                  <div class="flow-arrow-down" id="arrow-4a"></div>
                  <div class="flow-stage">
                    <div class="flow-stage-label">5a. Marketing</div>
                    <div class="flow-box" id="box-iterable">
                      <div class="flow-box-title">ITERABLE</div>
                      <div class="flow-box-sub">Email/SMS</div>
                    </div>
                  </div>
                </div>
                <div>
                  <div class="flow-arrow-down" id="arrow-4b"></div>
                  <div class="flow-stage">
                    <div class="flow-stage-label">5b. Analytics</div>
                    <div class="flow-box" id="box-amplitude">
                      <div class="flow-box-title">AMPLITUDE</div>
                      <div class="flow-box-sub">CDP</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Duplicate handling section -->
            <div class="section-divider">
              <span>IF DUPLICATE DETECTED</span>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 30px; align-items: center; margin: 20px 0;">
              <div class="flow-stage">
                <div class="flow-stage-label">6. Manual Review</div>
                <div class="manual-action" id="box-sales">
                  <div class="manual-action-label">ðŸ‘¤ SALES PERSON</div>
                  <div class="flow-box-title">DE-DUPLICATE</div>
                  <div class="flow-box-sub">in NetSuite</div>
                </div>
              </div>
              
              <div class="flow-arrow" id="arrow-5" style="max-width: 80px;"></div>
              
              <div class="flow-stage">
                <div class="flow-stage-label">7. Update CRM</div>
                <div class="flow-box" id="box-ns-update">
                  <div class="flow-box-title">NETSUITE</div>
                  <div class="flow-box-sub">Merge Records</div>
                </div>
              </div>
              
              <div class="flow-arrow" id="arrow-6" style="max-width: 80px;"></div>
              
              <div class="flow-stage">
                <div class="flow-stage-label">8. Sync Profile</div>
                <div class="flow-box" id="box-amp-enrich">
                  <div class="flow-box-title">AMPLITUDE</div>
                  <div class="flow-box-sub">Enrich Profile</div>
                </div>
              </div>
            </div>
            
            <!-- DataLayer section -->
            <div class="section-divider">
              <span>DATALAYER UPDATES</span>
            </div>
            
            <div style="display: flex; justify-content: center; gap: 40px; margin-top: 20px;">
              <div class="flow-box" id="box-dl1">
                <div class="flow-box-title">DATALAYER</div>
                <div class="flow-box-sub">form_submit</div>
              </div>
              <div class="flow-box" id="box-dl2">
                <div class="flow-box-title">DATALAYER</div>
                <div class="flow-box-sub">lead_created</div>
              </div>
              <div class="flow-box" id="box-dl3">
                <div class="flow-box-title">DATALAYER</div>
                <div class="flow-box-sub">lead_enriched</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Event Log -->
        <div class="panel">
          <div class="panel-title">
            â–  Event Log
            <button class="clear-btn" onclick="clearLog()">Clear</button>
          </div>
          <div class="event-log" id="eventLog"></div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    const scenarios = {
      'new': {
        email: 'newlead@company.com',
        phone: '0400111222',
        name: 'New Lead',
        isDuplicate: false
      },
      'duplicate': {
        email: 'john.smith@existing.com',
        phone: '0412345678',
        name: 'John Smith',
        isDuplicate: true
      }
    };
    
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16).toUpperCase();
      });
    }
    
    function generateId(prefix) {
      return prefix + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();
    }
    
    function log(source, message) {
      const el = document.getElementById('eventLog');
      const time = new Date().toLocaleTimeString('en-AU', { hour12: false });
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `
        <span class="log-time">${time}</span>
        <span class="log-source ${source.toLowerCase()}">${source.toUpperCase()}</span>
        <span>${message}</span>
      `;
      el.insertBefore(entry, el.firstChild);
    }
    
    function clearLog() {
      document.getElementById('eventLog').innerHTML = '';
    }
    
    function setStatus(id, status, isProcessing = false) {
      const el = document.getElementById('stat-' + id);
      el.textContent = status;
      el.className = 'status-value' + (status === 'Waiting' ? ' waiting' : '') + (isProcessing ? ' processing' : '');
    }
    
    function activateBox(id) {
      const box = document.getElementById(id);
      box.classList.add('active');
      return new Promise(r => setTimeout(() => {
        box.classList.remove('active');
        box.classList.add('complete');
        r();
      }, 500));
    }
    
    function activateArrow(id) {
      document.getElementById(id).classList.add('active');
    }
    
    function loadScenario() {
      const s = scenarios[document.getElementById('scenario').value];
      document.getElementById('email').value = s.email;
      document.getElementById('phone').value = s.phone;
      document.getElementById('name').value = s.name;
    }
    
    async function runFlow() {
      const email = document.getElementById('email').value;
      const phone = document.getElementById('phone').value;
      const name = document.getElementById('name').value;
      const brand = document.getElementById('brand').value;
      const isDuplicate = document.getElementById('scenario').value === 'duplicate';
      
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = 'PROCESSING...';
      
      // Reset visuals
      document.querySelectorAll('.flow-box, .manual-action').forEach(b => b.classList.remove('active', 'complete'));
      document.querySelectorAll('.flow-arrow, .flow-arrow-down').forEach(a => a.classList.remove('active'));
      
      // Generate IDs
      const uid = generateUUID();
      const masterId = generateId('LEAD');
      const nsLeadId = 'NS-' + Math.floor(Math.random() * 100000);
      
      document.getElementById('displayUid').textContent = uid;
      document.getElementById('displayMaster').textContent = masterId;
      
      // ========== STEP 1: Form Submit ==========
      log('SITE', `Form submitted on ${brand}`);
      log('DATALAYER', 'Push: form_submit');
      setStatus('site', 'Submitted');
      await activateBox('box-form');
      await activateBox('box-dl1');
      activateArrow('arrow-1');
      
      // ========== STEP 2: Firebase Dedupe ==========
      log('SITE', 'Calling Firebase for dedupe...');
      await new Promise(r => setTimeout(r, 300));
      
      if (isDuplicate) {
        log('SITE', 'âš  Potential duplicate detected (email/phone exists)');
        log('SITE', 'Flagging for sales review');
      } else {
        log('SITE', 'No duplicate found - new lead');
      }
      log('SITE', `Generated UID: ${uid.substring(0, 8)}...`);
      log('SITE', `Master Lead ID: ${masterId}`);
      await activateBox('box-firebase');
      activateArrow('arrow-2');
      
      // ========== STEP 3: NS Adapter ==========
      setStatus('adapter', 'Processing...', true);
      log('ADAPTER', 'Received lead data');
      log('ADAPTER', 'Transforming for NetSuite API');
      if (isDuplicate) {
        log('ADAPTER', 'Including duplicate flag in payload');
      }
      await activateBox('box-adapter');
      setStatus('adapter', 'Sent');
      activateArrow('arrow-3');
      
      // ========== STEP 4: NetSuite Create Lead ==========
      setStatus('netsuite', 'Processing...', true);
      log('NETSUITE', 'Creating lead record...');
      await new Promise(r => setTimeout(r, 400));
      log('NETSUITE', `Lead created: ${nsLeadId}`);
      document.getElementById('displayNsId').textContent = nsLeadId;
      if (isDuplicate) {
        log('NETSUITE', 'âš  Duplicate flag set - pending sales review');
      }
      await activateBox('box-netsuite');
      setStatus('netsuite', isDuplicate ? 'Created (Dup)' : 'Created');
      log('DATALAYER', 'Push: lead_created');
      await activateBox('box-dl2');
      
      // ========== STEP 5a: Iterable ==========
      activateArrow('arrow-4a');
      setStatus('iterable', 'Processing...', true);
      log('NETSUITE', 'â†’ Sending to Iterable');
      await new Promise(r => setTimeout(r, 300));
      log('ITERABLE', 'Contact created');
      log('ITERABLE', 'Added to welcome sequence');
      await activateBox('box-iterable');
      setStatus('iterable', 'Synced');
      
      // ========== STEP 5b: Amplitude ==========
      activateArrow('arrow-4b');
      setStatus('amplitude', 'Processing...', true);
      log('NETSUITE', 'â†’ Sending to Amplitude');
      await new Promise(r => setTimeout(r, 300));
      log('AMPLITUDE', 'User profile created');
      log('AMPLITUDE', `Identify: ${masterId}`);
      await activateBox('box-amplitude');
      setStatus('amplitude', 'Synced');
      
      // ========== DUPLICATE FLOW ==========
      if (isDuplicate) {
        log('SITE', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
        log('SITE', 'DUPLICATE RESOLUTION FLOW');
        log('SITE', 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
        
        await new Promise(r => setTimeout(r, 800));
        
        // Sales review
        log('SALES', 'Email received: "Potential duplicate lead"');
        log('SALES', `New: ${name} <${email}>`);
        log('SALES', 'Existing: John Smith <john@example.com>');
        await activateBox('box-sales');
        
        await new Promise(r => setTimeout(r, 600));
        
        // Sales merges in NetSuite
        log('SALES', 'â†’ Merging records in NetSuite');
        activateArrow('arrow-5');
        log('NETSUITE', 'Merging duplicate into master record');
        log('NETSUITE', 'Master record updated with new submission');
        await activateBox('box-ns-update');
        
        await new Promise(r => setTimeout(r, 400));
        
        // Amplitude enrichment
        activateArrow('arrow-6');
        log('NETSUITE', 'â†’ Updating Amplitude profile');
        log('AMPLITUDE', 'Profile merged');
        log('AMPLITUDE', 'Behavioral data consolidated');
        log('AMPLITUDE', 'Computed properties updated:');
        log('AMPLITUDE', '  - lifetime_value: increased');
        log('AMPLITUDE', '  - engagement_score: recalculated');
        log('AMPLITUDE', '  - submission_count: 2 â†’ 3');
        await activateBox('box-amp-enrich');
        
        log('DATALAYER', 'Push: lead_enriched (merged profile)');
        await activateBox('box-dl3');
        setStatus('amplitude', 'Enriched');
      } else {
        // Non-duplicate enrichment
        await new Promise(r => setTimeout(r, 500));
        log('AMPLITUDE', 'Computing initial properties...');
        log('AMPLITUDE', '  - predicted_value: calculated');
        log('AMPLITUDE', '  - segment: assigned');
        log('DATALAYER', 'Push: lead_enriched');
        await activateBox('box-dl3');
        setStatus('amplitude', 'Enriched');
      }
      
      log('SITE', 'âœ“ Flow complete');
      
      btn.disabled = false;
      btn.textContent = 'SUBMIT LEAD';
    }
    
    function resetDemo() {
      document.querySelectorAll('.flow-box, .manual-action').forEach(b => b.classList.remove('active', 'complete'));
      document.querySelectorAll('.flow-arrow, .flow-arrow-down').forEach(a => a.classList.remove('active'));
      
      setStatus('site', 'Ready');
      setStatus('adapter', 'Waiting');
      setStatus('netsuite', 'Waiting');
      setStatus('iterable', 'Waiting');
      setStatus('amplitude', 'Waiting');
      
      document.getElementById('displayUid').textContent = '-';
      document.getElementById('displayMaster').textContent = '-';
      document.getElementById('displayNsId').textContent = '-';
      
      clearLog();
      loadScenario();
      log('SITE', 'Demo reset');
    }
    
    window.onload = () => {
      loadScenario();
      log('SITE', 'System ready');
    };
  </script>
</body>
</html>
